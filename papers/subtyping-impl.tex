\def\subihnf{\hnf{\subi}}

\newcommand{\subimplhnf}[4]{#1 \typec #2 : #3 {\suba}
  #4}

\newcommand{\SubConvIFull}{%
\UAX{SubConv}
{$T \eqbi U$}
{$\subimplconcl{`G}{t}{t}{T}{U}$}
{$T = \hnf{T} `^ T "/=" \Pi, \Sigma, \{|\} `^ U = \hnf{U} `^ U "/=" \{|\}$} 
}

\newcommand{\SubConvI}{%
\UAX{SubConv}
{$T \eqbi U$}
{$\subimplconcl{`G}{t}{t}{T}{U}$}
{$T = \hnf{T} `^ U = \hnf{U}$}
}


\def\SubHnfI{%
\UAX{SubHnf}
{$\subimplhyp{`G}{c}{\hnf{T}}{\hnf{U}}$}
{$\subimplhyp{`G}{c}{T}{U}$}
{} 
}

% \def\SubProdI{%
% \BAX{SubProd}
% {$\subimpl{`G}{c_1}{U}{T}$}
% {$\subimpl{`G, x : U}{c_2}{V[c_1~x/x]}{W}$}
% {$\subimplconcl{`G}{\lambda f : \Pi x : T.V.~\lambda x : U.~c_2~(f~(c_1~x))}{\Pi x : T.V}{\Pi x : U.W}$}
% {}
% }

\def\SubProdI{%
\BAX{SubProd}
{$\subimplhyp{`G}{c_1}{U}{T}$}
{$\subimplhyp{`G, x : U}{c_2}{V}{W}$}
{$\subimplconcl{`G}{f}{\lambda x : \ip{U}{`G}.~c_2~(f~(c_1~x))}{\Pi x : T.V}{\Pi x : U.W}$}
{}
}

\def\SubSigmaI{%
\BAX{SubSigma}
{$\subimplhyp{`G}{c_1}{T}{U}$}
{$\subimplhyp{`G, x : T}{c_2}{V}{W}$}
{$\subimplconcl{`G}
  {t}{\letml~(x, y) = t~\inml~(c_1~x, c_2~y)}
  {\Sigma x : T. V}{\Sigma x : U. W}$}
{}
}

\def\SubLeftI{\SubSubI}
\def\SubSubI{%
\UAX{SubSub}
%{$`G, x : U \typec P : \Prop$}
{$\subimplhyp{`G}{c}{T}{U}$}
{$\subimplconcl{`G}{t}{c~(\pi_1~t)}
  {\mysubset{x}{T}{P}}{U}$}
{}
}
    
\def\SubRightI{\SubProofI}
\def\SubProofIFull{%
\UAX{SubProof}
%{$`G, x : U \typec P : \Prop$}
{$\subimplhyp{`G}{c}{T}{U}$}
{$\subimplconcl{`G}
  {t}{\elt{\ip{U}{`G}}
    {\ip{\lambda x : U.P}{`G}}
  {(c~t)}
  {\tex{\ipG{`G, t : T}}{\ip{P}{`G, x : U}[c~t/x]}}}
  {T}{\mysubset{x}{U}{P}}$}
{$\hnf{T} "/=" \{|\}$}
}

\def\SubProofI{%
\UAX{SubProof}
%{$`G, x : U \typec P : \Prop$}
{$\subimplhyp{`G}{c}{T}{U}$}
{$\subimplconcl{`G}
  {t}{\elt{\ip{U}{`G}}
    {\ip{(\lambda x : U.P)}{`G}}
    {(c~t)}
    {\tex{\ipG{`G, t : T}}{\ip{P}{`G, x : U}[c~t/x]}}}
  {T}{\mysubset{x}{U}{P}}$}
{}
}


\newcommand{\subimpln}[4]{#1 \typec #2 : \ipt{#3}{{#1}} \subi
  \ipt{#4}{#1}}
\newcommand{\subimplndiff}[6]{#1 \typec #2 : \ipt{#3}{#1} #4 \subi
  \ipt{#5}{#1} #6}

\renewcommand{\subimpln}[4]{#1 \typec #2 : #3 \suba'
  #4}
\newcommand{\subimplnp}[4]{#1 \typec #2 : #3 \suba
  #4}
\renewcommand{\subimplndiff}[6]{#1 \typec #2 : #3 #4 \suba
  #5 #6}


\newcommand{\SubConvC}{
\UAX{SubConv}
{$T \eqbi U$}
{$\subimpln{`G}{(\lambda x : \ip{T}{`G}. x)}{T}{U}$}
{} 
}

\newcommand{\SubHnfC}{
\UAX{SubHnf}
{$\subimpln{`G}{c}{\hnf{T}}{\hnf{U}}$}
{$\subimplnp{`G}{c}{T}{U}$}
{} 
}

\def\SubProdC{%
\BAX{SubProd}
{$\subimplnp{`G}{c_1}{U}{T}$}
%{$`G, x : \ipt{U}{`G} \typec c_2 : \ipt{V}{`G, x :
 % \ipt{T}{`G}}[c_1~x/x] \subi \ipt{W}{`G, x : \ipt{U}{`G}}$}
%{$`G, x : U \typec c_2 : V[c_1~x/x] \subi W$}
{$`G, x : U \typec c_2 : V \suba W$}
{$\subimpln{`G}{\lambda f : \ip{\Pi x : T.V}{`G}.\lambda x : \ip{U}{`G}. c_2~(f~(c_1~x))}{\Pi x : T.V}{\Pi x : U.W}$}
{}
}

\def\SubSigmaC{%
\BAX{SubSigma}
{$\subimplnp{`G}{c_1}{T}{U}$}
%{$`G, x : \ipt{T}{`G} \typec c_2 : \ipt{V}{`G, x : \ipt{T}{`G}} \subi
%  \ipt{W}{`G, x : \ipt{T}{`G}}[c_1~x/x]$}
%{$`G, x : T \typec c_2 : V \subi W[c_1~x/x]$}
{$`G, x : T \typec c_2 : V \suba W$}
{$\subimpln{`G}
  {\lambda (x, y) : \ip{\Sigma x : T.V}{`G}. (c_1~x, c_2~y)}
  {\Sigma x : T. V}{\Sigma x : U. W}$}
{}
}

\def\SubLeftC{\SubSubC}
\def\SubSubC{%
\UAX{SubSub}
% {$`G, x : U \typec P : \Prop$}
{$\subimplnp{`G}{c}{U}{T}$}
{$\subimpln{`G}{c `o \pi_1}
  {\mysubset{x}{U}{P}}{T}$}
{}
}
    
\def\SubRightC{\SubProofC}
\def\SubProofC{%
\UAX{SubProof}
%{$`G, x : U \typec P : \Prop$}
{$\subimplnp{`G}{c}{T}{U}$}
{$\subimpln{`G}
  {\lambda t : \ip{T}{`G}. \elt{\ip{U}{`G}}{\ip{\lambda x :
        U.P}{`G}}{(c~t)}
    {?_{\ip{P}{`G}[c~t/x]}}}
  {T}{\mysubset{x}{U}{P}}$}
{}
}

\def\subtiFig{
\begin{figure}[ht]
  \begin{center}
    \def\fCenter{\subtd}
    
    \vspace{\infvspace}
    \SubHnfI\DP

    \vspace{\infvspace}
    \SubConvIFull\DP

    \vspace{\infvspace}
    \SubProdI\DP

    \vspace{\infvspace}
    \SubSigmaI\DP
    
    \vspace{\infvspace}
    \SubLeftI\DP
    
    \vspace{\infvspace}
    \SubProofIFull\DP
    
  \end{center}
  \caption{Réécriture de la coercion vers \CCI}
  \label{fig:subtyping-impl-rules}
\end{figure}
}

\def\subticFig{
  \begin{figure}[th]
    \begin{center}
      \def\fCenter{\subtd}
      
    \vspace{\infvspace}
    \SubConvC\DP
    \quad
    \SubHnfC\DP
    
    \vspace{\infvspace}
    \SubProdC\DP

    \vspace{\infvspace}
    \SubSigmaC\DP
    
    \vspace{\infvspace}
    \SubLeftC\DP
    
    \vspace{\infvspace}
    \SubRightC\DP
    
  \end{center}
  \caption{Réécriture de la coercion vers \CCI}
  \label{fig:subtyping-impl-rules}
\end{figure}
}

\def\subtiShortContent{
  \begin{center}
    \def\fCenter{\subti}
    \SubConvI\DP
    \quad
    \SubHnfI\DP

    \vspace{\infvspace}
    \SubLeftI\DP

    \vspace{\infvspace}
    \SubRightI\DP

    \vspace{\infvspace}
    \SubProdI\DP
    
    \vspace{\infvspace}
    \SubSigmaI\DP
  \end{center}}

\def\subtiShort{
\begin{figure}[ht]
  \subtiShortContent
  \caption{Réécriture de la coercion vers \CCI}
  \label{fig:subtyping-impl-rules}
\end{figure}
}

\def\coerceoldFig{
\begin{figure}
\begin{verbatim}
let app_opt f = function
   Some f -> f
 | None -> (fun x -> x)

let rec coerce' env (x,y) =
 match (x,y) with
 | (Pi y : T.V, Pi y : U.W) =>
    let c1 = coerce env U T 
    and c2 = coerce (U :: env) V W
    in
       (fun f -> 
         mkLambda (x, ip env U, app_opt c2 ((lift 1 f) (c1 x))))

 | (Sigma y : T.V, Sigma y : U.W) =>
    let c1 = coerce env T U 
    and c2 = coerce (T :: env) V W
    in
       (fun f -> 
          mkPair (c1 (mkApp coqfst f), c2 (mkApp coqsnd f)))

 | ({ x : U | P }, T) =>
    let c = coerce env U T
    in
       (fun f -> 
          app_opt c (mkApp pi_1 f))
 
 | (T, { x : U | P }) =>
    let c = coerce env T U
    in
       (fun t -> 
          let ipU = ip env U in
          let ipP = ip (U :: env) P in
          let ct = app_opt c t in
            mkElt ipU  ipP ct (mkEx (subst ct ipP)))
 | _ => assert(false)

and coerce env (x, y) = 
  let x', y' = hnf x, hnf y in
    if conv x' y' then None
    else Some (coerce' env x' y')
\end{verbatim}
  \caption{Génération des coercions}
  \label{fig:coerce}
\end{figure}
}

\def\Some{\sref{Some}}
\def\None{\sref{None}}
\def\coerceFig{
\begin{figure}
  \[\begin{array}{lcll}
    \coercehnf{`G}{\Pi y : T.V}{\Pi y : U.W} & = 
    & \letml~c_1 = \coerce{`G}{U}{T}~\inml \\
    & & \letml~c_2 = \coerce{(`G, x : U)}{V[c_1~x/x]}{W}~\inml \\
    & & \lambda f : \Pi y : T.V.\lambda x : U.c_2~(f~(c_1~x)) \\
    \\
    \coercehnf{`G}{\Sigma y : T.V}{\Sigma y : U.W} & = 
    & \letml~c_1 = \coerce{`G}{T}{U}~\inml \\
    & & \letml~c_2 = \coerce{(`G, x : T)}{V}{W[c_1~x/x]}~\inml \\
    & & \lambda t : \Sigma y : T.V.(c_1~(\pi_1~t), c_2~(\pi_2~t)) \\
    & & \\

    \coercehnf{`G}{\mysubset{x}{U}{P}}{T} & = 
    & \letml~c = \coerce{`G}{U}{T}~\inml \\
    & & \lambda t : \mysubset{x}{U}{P}. c~(\pi_1~t) \\
    & & \\
    
    \coercehnf{`G}{T}{\mysubset{x}{U}{P}} & = 
    & \letml~c = \coerce{`G}{T}{U}~\inml \\
    & & \lambda t : T. \elt{U}{(\lambda x : U.P)}{(c~t)}{\ex{`G, t : T}{P[c~t/x]}} \\
    & & \\
    \coercehnf{`G}{\_}{\_} & = & `_ \\
    \\
    
    \coerce{`G}{T}{U} & = & 
    \letml~c = \coercehnf{`G}{\hnf{T}}{\hnf{U}}~\inml \\
    & & \ifml~c "/=" `_~\thenml~c \\
    & & \elseml~\ifml~T \eqbi U~\thenml~\lambda x : T.x~\elseml~`_
\end{array}\]
\caption{Génération des coercions}
\label{fig:coerce}
\end{figure}}

%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "subset-typing"
%%% LaTeX-command: "TEXINPUTS=\"style:.:\" latex"
%%% End: 
