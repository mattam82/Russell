\def\GD{`G, x : U, `D}
\def\Gr{`G, `D[u/x]}
\def\iGD{\ipG{\GD}}
\def\iGr{\ipG{\Gr}}


\begin{lemma}[Coercion de sortes]
  \label{subti-coercion-sorts}
  Si $`G \typec e : s \subi T$ ou $`G \typec e : T \subi s$ alors $T
  \eqbr s$ et $e = []$.
\end{lemma}
\begin{proof}  
  Clairement on ne peut dériver $s \suba T$ que par \irule{SubConv}
  (éventuellement précédé de \irule{SubHnf}). En effet seule la règle
  \irule{SubProof} pourrait s'appliquer, mais cela impliquerait que
  $T \eqbr \mysubset{x}{U}{P}$ avec $s \suba U$ et ainsi de suite. La
  seule possibilité est de dériver $s \eqbr T$ ou $s \eqbr U$, auquel cas $U$ est une
  sorte ce qui contredit le fait que $\mysubset{x}{U}{P} : s$ dans le
  cas précédent. On dérive donc $s \subi T$ si et seulement si $s
  \eqbr T$.
\end{proof}

\begin{lemma}[Stabilité de la coercion par substitution]
  \label{subti-coercion-subst}
  Si $\GD \typea T, T' : s$, $`G \typec u :
  U$, alors
  $\begin{array}{lcl}
    \GD \typea t : T & "=>" & \ip{t[u/x]}{\Gr} \eqbre
    \ip{t}{\GD}[\ip{u}{`G}/x] \\
    \subimpl{\GD}{c}{T}{T'} & "=>" & \subimpl{\Gr}{c'}{T[u/x]}{T'[u/x]}
    `^ c' \eqbre c[\ip{u}{`G}/x]
  \end{array}$
  
\end{lemma}

\begin{proof}
  Par induction mutuelle sur les dérivation de $c$ et $t$.

  \begin{induction}
    \case{SubHnf} On a: 
    \begin{prooftree}
      \AXC{$\subimpl{\GD}{c}{\hnf{T}}{\hnf{T'}}$}
      \UIC{$\subimpl{\GD}{c}{T}{T'}$}
    \end{prooftree}
    
    \def\as{\overrightarrow{a}}    
    \def\bs{\overrightarrow{b}}    
    \def\asux{\overrightarrow{a[u/x]}}
    \def\bsux{\overrightarrow{b[u/x]}}
    \def\ipux{[\ip{u}{`G}/x]}

    Par induction on a
    $\subimpl{\Gr}{c'}{\hnf{T}[u/x]}{\hnf{T'}[u/x]}$ avec $c' \eqbre
    c\ipux$.
    Si $\hnf{T[u/x]} = \hnf{T}[u/x]$ et $\hnf{T'[u/x]} = \hnf{T'}[u/x]$
    c'est direct par induction. Sinon, on a $\hnf{T} = x~\as$ ou $\hnf{T'} =
    x~\as$. Les deux cas sont similaires, on traite le cas ou $\hnf{T} =
    x~\as$. Le jugement $x~\as \suba \hnf{T'}$
    ne peut être dérivé que par \irule{SubProof} ou
    \irule{SubConv}. Dans le premier cas, cela implique qu'on a une
    dérivation de $d : x~\as \suba U'$ où $\hnf{T'} = \mysubset{y}{U'}{P}$. Par
    induction on a donc une dérivation de
    $\subimpl{\Gr}{d'}{u~\asux}{U'[u/x]}$ avec $d ' \eqbre
    d\ipux$. 
    Par le lemme \ref{substi-coercion-hnf} on a donc une dérivation de 
    $\subimpl{\Gr}{d'}{\hnf{(u~\asux)}}{\hnf{(U'[u/x])}}$ avec $d' \eqbre
    d\ipux$. 
    
    \begin{prooftree}
      \AXC{$\subimpl{\Gr}{d'}{\hnf{(u~\asux)}}{\hnf{(U'[u/x])}}$}
      \UIC{$\subimpl{\Gr}{d'}{\hnf{(u~\asux)}}{U'[u/x]}$}
      \UIC{$\subimpl{\Gr}{c'}{\hnf{T[u/x]}}{\hnf{(T'[u/x])} = \mysubset{y}{U'[u/x]}{P[u/x]}}$}
      \UIC{$\subimpl{\Gr}{c'}{T[u/x]}{T'[u/x]}$}
    \end{prooftree}
    
    Par induction, on a $\ip{U'[u/x]}{\Gr} \eqbr \ip{U'}{\GD}\ipux$ et
    $\ip{P[u/x]}{\Gr} = \ip{P}{\GD}\ipux$. 
    On en déduit:
    \begin{eqnarray*}
      \ip{P[u/x]}{\Gr}[d'/y] & 
      \eqbre & \ip{P}{\GD}\ipux[d'/y] \\
      & \eqbre & \ip{P}{\GD}\ipux[d\ipux~t/y] \\
      & = & \ip{P}{\GD}[d/y]\ipux
    \end{eqnarray*}
    
    Soit $A = \ipG{\Gr} \typec \ip{P[u/x]}{\Gr}[d'/y]$ et
    $B = \ipG{\GD} \typec \ip{P}{\GD}[d/y]$. On a
    $A \eqbr B\ipux$ car $\ipG{\Gr} \eqbr \ipG{\GD}\ipux = \ipG{`G}, \ipG{`D}\ipux$ 
    par application de l'hypothèse d'induction sur chaque élément de
    $`D$ et les conclusion des existentielles sont convertibles par le résultat précédent.
    
    On a donc:
    \begin{eqnarray*}
      c' & = &
      \elt{\ip{U'[u/x]}{\Gr}}
      {\ip{(\lambda y : (U'[u/x]).P[u/x])}{\Gr}}
      {d'}
      {?_A} \\
      & \eqbre &
      \elt{\ip{U'[u/x]}{\Gr}}
      {\ip{(\lambda y : (U'[u/x]).P[u/x])}{\Gr}}
      {d\ipux}
      {?_A} \\
      & \eqbre &
      \elt{\ip{U'}{\GD}\ipux}
      {\ip{(\lambda y : U'.P)}{\GD}\ipux}
      {d\ipux}
      {?_A} \\
      & \eqbre &
      (\elt{\ip{U'}{\GD}}{\ip{\lambda y : U'.P}{\GD}}{d}
      {?_B})\ipux \\
      & = & c\ipux
    \end{eqnarray*}
    
    Dans le cas ou l'on applique directement \irule{SubConv} cela
    implique que $\hnf{T} = x = \hnf{T'}$ donc par reflexivité de la
    coercion \ref{subti-reflexive}, $\subimpl{\Gr}{c'}{u}{u}$ est dérivable et $c' \eqbre
    [] \eqbre []\ipux$.
      
    \case{SubConv}
    On a $T \eqbr T'$, donc $c \eqbre []$. D'autre part, $T[u/x] \eqbr T'[u/x]$ par substitutivité de
    la $\beta\rho$-équivalence. Par le lemme \ref{subti-eqb-coercion-eqbe-id}, on
    sait qu'il existe une coercion $c'$ telle que le jugement $\Gr
    \typec c' : T[u/x] \sub T'[u/x]$ est dérivable et $c' \eqbre []$.
    On a bien $c' \eqbre c\ipux$.
    
    \case{SubProd}
    On a:
    \begin{prooftree}
      \AXC{$\subimpl{\GD}{c_1}{A'}{A}$}
      \AXC{$\subimpl{\GD, y : A'}{c_2}{B}{B'}$}
      \BIC{$\subimpl{\GD}
        {\lambda x : \ip{A'}{\GD}.~c_2[[]~c_1[x]]}
        {\Pi y : A.B}{\Pi y : A'.B'}$}
    \end{prooftree}
    
    Par induction et application de \irule{SubProd}:
    \begin{prooftree}
      \AXC{$\subimpl{\Gr}{c_1'}{A'[u/x]}{A[u/x]}$}
      \AXC{$\subimpl{\Gr, y : A'[u/x]}{c_2'}{B[u/x]}{B'[u/x]}$}
      \BIC{$\subimpl{\Gr}{c'}
        {\Pi y : A[u/x].B[u/x]}{\Pi y : A'[u/x].B'[u/x]}$}
    \end{prooftree}
    
    où \[c' = \lambda x : \ip{A'[u/x]}{\Gr}.~c_2'[[]~c_1'[x] `^ c_1'
    \eqbre c_1\ipux `^ c_2' \eqbre c_2\ipux\]
    Par induction, $\ip{A'[u/x]}{\Gr} \eqbre \ip{A'}{\GD}\ipux$,
    on a donc bien $c' \eqbre c\ipux$.
   
    \casethree{SubSigma}{SubProof}{SubSub} Idem, direct par induction.
  
    \case{PropSet} Trivial.
    
    \case{Var} 
    On a:
    \typenva
    \begin{prooftree}
      \BAX{}
      {$\wf \GD$}
      {$y : T `: \GD$}
      {$\GD \seq y : T$}
      {}
    \end{prooftree}    
    \typenvi

    \begin{itemize}
    \item Si $x "/=" y$, alors par définition de l'interprétation,
      on doit montrer
      $\ip{y[u/x]}{\Gr} = y = \ip{y}{\GD}\ipux$.
      
    \item Sinon, $t[u/x] = u$ et $\ip{u}{\Gr} = \ip{x}{\GD}\ipux =
      \ip{u}{\GD}$. On utilise ici le fait que $u$ est bien typé dans
      l'environnement $`G$, donc dans toute extension bien formée de cet
      environnement par affaiblissement.      
    \end{itemize}
    
    \case{App}\quad
    \typenva
    \begin{prooftree}
      \TAX{}
      {$\GD \seq f : F \quad \mualgo(F) = \Pi y : A. B : s$}
      {$\GD \seq e : E \quad `G \seq E, A : s$}
      {$E \sub A$}
      {$\GD \seq (f~e) : B [ e / y ]$}
      {}
    \end{prooftree}
    \typenvi

    Par induction:
    \[\ip{f[u/x]}{\Gr} \eqbr \ip{f}{\GD}\ipux\]
    \[\ip{e[u/x]}{\Gr} \eqbr \ip{e}{\GD}\ipux\]
    
    \def\afe{`a}    
    Par définition de la substitution et de l'interprétation, 
    \begin{eqnarray*}
      \ip{(f~e)}{\GD}
      & = & (((\pi_F~\ip{f}{\GD})~(c_e~\ip{e}{\GD})) \\
      \text{ où } & & \\
      \pi_F & = & \coerce{\GD}{F}{(\Pi y : A.B)} \\
      c_e & = & \coerce{\GD}{E}{A}.
    \end{eqnarray*}
    
    Clairement, $\pi_F$ et $c_e$ sont dérivables, puisqu'on part de
    jugements dérivables par la coercion algorithmique.

    On a la substitutivité du typage \ref{substitutive-typing} donc le
    jugement substitué est:
    \typenva
    \begin{prooftree}
      \TAX{App}
      {$\Gr \seq f[u/x] : F[u/x] \quad \mualgo(F[u/x]) = \Pi y : A[u/x]. B[u/x] : s$}
      {$\Gr \seq e[u/x] : E[u/x] \quad `G \seq E[u/x], A[u/x] : s$}
      {$E[u/x] \sub A[u/x]$}
      {$\Gr \seq (f~e)[u/x] : B' [ e[u/x] / y ]$}
      {}
    \end{prooftree}
       
    Soit $e' = e[u/x]$ et $f' = f[u/x]$, on a donc d'autre part:
    \begin{eqnarray*}
      \ip{(f~e)[u/x]}{\Gr}
      & = & \ip{f'~e'}{\Gr} \\
      & = & \pi_{F[u/x]}[\ip{f'}{\Gr}]~c_{e'}[\ip{e'}{\Gr}] \\
      \text{ où } & & \\
      \pi_{F[u/x]} & = & \coerce{\Gr}{F[u/x]}{(\Pi y : A[u/x].B[u/x])} \\
      c_{e'} & = & \coerce{\Gr}{E[u/x]}{A[u/x]}
    \end{eqnarray*}
    
    Par induction, il existe des coercions $d$, $e$ telles que:
    $\subimpl{\Gr}{d}{F[u/x]}{(\Pi y : A.B)[u/x]}$
    et $\subimpl{\Gr}{e}{E[u/x]}{A[u/x]}$ avec
    $d \eqbre \pi_F\ipux$ et $e \eqbre c_e\ipux$. Par unicité des
    coercions on en déduit que $d = \pi_{F[u/x]}$ et $e = c_{e'}$.

    \[\begin{array}{ll}
      \firsteq{\ip{f~e}{\GD}\ipux}
      
      \step{Définition de l'interprétation}
      {=}(\pi_F[\ip{f}{\GD}])~(c_e[\ip{e}{\GD}])\ipux 

      \step{Définition de la substitution}
      {=}{(\pi_F\ipux[\ip{f}{\GD}\ipux])~(c_e\ipux[\ip{e}{\GD}\ipux])}

      \step{Application de l'hypothèse d'induction pour les termes}
      {\eqbre}{(\pi_F\ipux[\ip{f'}{\Gr}])~(c_e\ipux[\ip{e'}{\Gr}])}

      \step{Application de l'hypothèse d'induction pour les coercions}
      {\eqbre}{(d[\ip{f'}{\Gr}])~e[\ip{e'}{\Gr}]}

      \step{Unicité des coercions}
      {\eqbre}{\pi_{F[u/x]}[\ip{f'}{\Gr}]~c_{e'}[\ip{e'}{\Gr}]}
      
      \step{Définition de l'interprétation}
      {\eqbre}{\ip{(f~e)[u/x]}{\Gr}}
    \end{array}\]
    
    \casethree{Prod}{Sigma}{Subset} Par induction.

    \case{Abs}
    \typenva
    On a:
    \begin{prooftree}
      \AXC{$\GD \seq \Pi y : T. U : s $}
      \AXC{$\GD, y : T \seq M : U $}
      \BIC{$\GD \seq \lambda y : T. M : \Pi y : T.U$}
    \end{prooftree}
    
    On a bien:
    \[\begin{array}{ll}
      \firsteq{\ip{\lambda y : T.M}{\GD}\ipux}
      
      \step{Définition de l'interprétation}
      {=}{\lambda y : \ip{T}{\GD}\ipux.\ip{M}{\GD, y : T}\ipux}

      \step{Application de l'hypothèse de récurrence}
      {\eqbre}{\lambda y : \ip{T[u/x]}{\Gr}.\ip{M[u/x]}{\Gr, y : T[u/x]}}

      \step{Définition de l'interprétation}
      {=}{\ip{\lambda y : T[u/x].M[u/x]}{\Gr}}
    \end{array}\]
      
    \casetwo{LetSum}{SumDep} \TODO{Par induction}


  \end{induction}
\end{proof}

On va maintenant étendre la relation de coercion aux contextes de
manière canonique.
\typenva
\begin{definition}[Coercion de contextes]
  \label{coercion-ctx}
  On définit inductivement la coercion de deux contextes de coercions
  algorithmiques par les règles suivantes:
  \begin{itemize}
  \item $[] \sub []$
  \item $`G, x : T \sub `G', x : T'$ si $`G \sub `G'$ et $T \sub T'$.
  \end{itemize}
\end{definition}

De même pour les coercions explicites dérivées par le jugement $`G
\typec c : T \suba S$.
\begin{definition}[Coercion explicites de contextes]
  \label{coercion-ctx-i}
  On définit inductivement la coercion de deux contextes de coercions
  explicites par les règles suivantes:
  \begin{itemize}
  \item $[] \sub []$
  \item $`r, c : `G, x : T \sub `G', x : T'$ si $`r : `G \sub `G'$ et 
    $`G \typec c : T \sub T'$.
  \end{itemize}
\end{definition}

Clairement toute coercion de contexte algorithmique correspond à une
coercion de contexte explicite et vice-versa.

\begin{definition}[Extension de la substitution aux coercions de
  contextes]
  \label{subst-coercion-ctx}
  On définit la substitution d'une coercion de contexte inductivement:
  \begin{itemize}
  \item $t[[]] = t$
  \item $t[`r, c : `G, x : T \sub T'] = t[`r : `G][c[x]/x]$
  \end{itemize}
\end{definition}

\begin{lemma}[Stabilité par affaiblissement]
  \label{narrowing-i-coercion}
  Si $`r : `D \sub `G$, $`G \typec c : T \subi T'$ et $\ip{T'}{`D} \eqbre
  \ip{T'}{`G}[`r]$, alors $`D \typec c' : T \sub T'$ et $c' \eqbre c[`r]$.
\end{lemma}

\begin{proof}
  Par induction sur la dérivation de coercion:

  \begin{induction}
    \case{SubHnf} 
    On a $\subimpl{`G}{c}{\hnf{T}}{\hnf{T'}}$. Par induction, 
    $\subimpl{`D}{c[`r]}{\hnf{T}}{\hnf{T'}}$. 
    On peut donc dériver $`D \typec c[`r] : T \sub T'$ par \irule{SubHnf}.

    \case{SubConv}
    On a $T \eqbre T'$ et $c = []$. 
    On peut donc dériver $\subimpl{`D}{c' = []}{T}{T'}$,
    on a bien $c' = c[`r]$.

    \case{SubProd}
    On a:
    \begin{prooftree}
      \BAX{}
      {$\subimpl{`G}{c_1}{C}{A}$}
      {$\subimpl{`G, x : C}{c_2}{B}{D}$}
      {$\subimpl{`G}{\lambda x : \ip{C}{`G}.~c_2[[]~c_1[x]]}
        {\Pi x : A.B}{\Pi x : C.D}$}
      {}
    \end{prooftree}

    Par induction on a $\subimpl{`D}{c_1[`r]}{C}{A}$. On peut définir
    la coercion $`s = `r, [] : `D, x : C \sub `G, x : C$ et obtenir par
    induction: $\subimpl{`D, x : C}{c_2'}{B}{D}$ avec $c_2' \eqbre c_2[`s]$.
    
    On peut alors appliquer \irule{SubProd} pour obtenir:
    \[\subimpl{`D}
    {c' = \lambda x : \ip{C}{`D}.~c_2[`s][[]~c_1[`r][x]]}{\Pi x : A.B}{\Pi x : C.D}\]
    
    On a:
    \[\begin{array}{ll}
      \firsteq{(\lambda x : \ip{C}{`G}.~c_2[[]~c_1[x]])[`r]}

        \step{Définition de la substitution}
        {=}{\lambda x : \ip{C}{`G}[`r].(c_2[`r])[[]~(c_1[`r])[x]]}

        \step{Application de l'hypothèse de récurrence}
        {\eqbre}{\lambda x : \ip{C}{`D}.(c_2[`r])[[]~(c_1[`r])[x]]}
        
        \step{Coercion identité dans $`s$}
        {=}{\lambda x : \ip{C}{`D}.(c_2[`s])[[]~(c_1[`r])[x]]}
      \end{array}
      \]
      
    \case{SubSigma}\quad
    \begin{prooftree}
      \BAX{}
      {$\subimpl{`G}{c_1}{A}{C}$}
      {$\subimpl{`G, x : A}{c_2}{B}{D}$}
      {$\subimpl{`G}{t}{(c_1[\pi_1~[]], c_2~[\pi_2~[]])}
        {\Sigma x : A.B}{\Sigma x : C.D}$}
      {}
    \end{prooftree}
    Par induction on a {$\subimpl{`D}{c_1[`r]}{A}{C}$}. On peut définir
    la coercion $`s = `r, [] : `D, x : A \sub `G, x : A$ et obtenir par
    induction:
    $\subimpl{`D, x : A}{c_2[`s]}{B}{D}$
    
    On peut alors appliquer \irule{SubSigma} pour obtenir:
    \[\subimpl{`G}
    {c' = ((c_1[`r])[\pi_1~[]], (c_2[`s])[\pi_2~[]])}
    {\Sigma x : A.B}{\Sigma x : C.D}\]
    
    On a:
    \[\begin{array}{ll}
      \firsteq{
        ((c_1[\pi_1~[]], c_2[\pi_2~[]]))[`r]}
      
        \step{Définition de la substitution}
        {=}{((c_1[`r])[\pi_1~[]], (c_2[`r])[\pi_2~[]])}

        \step{Coercion identité dans $`s$}
        {=}{((c_1[`r])[\pi_1~[]], (c_2[`s])[\pi_2~[]])}
      \end{array} 
      \]
      
   \case{SubProof}\quad
   \begin{prooftree}
     \UAX{}
     {$\subimpl{`G}{d}{T}{U}$}
     {$\subimpl{`G}
       {c = \elt{\ip{U}{`G}}
         {\ip{(\lambda x : U.P)}{`G}}
         {d}
         {\tex{\ipG{`G}}{\ip{P}{`G, x : U}[d/x]}}}
       {T}{\mysubset{x}{U}{P}}$}
     {}
   \end{prooftree}

   Par induction, on a $\subimpl{`D}{d[`r]}{T}{U}$. On peut donc dériver:
   \[\subimpl{`D}{c' = \elt{\ip{U}{`D}}
     {\ip{(\lambda x : U.P)}{`D}}
     {d[`r]}
     {\tex{\ipG{`D}}{\ip{P}{`D, x : U}[d[`r]/x]}}}
   {T}{\mysubset{x}{U}{P}}\]
   
   On a bien $c[`r] \eqbr c'$, car:
   \begin{equations}
     \firsteq{(\ipG{`G} \vdash (\ip{P}{`G, x : U})[d/x])[`r]}
     
     \step{Définition de la substitution, $x `; `G$}
     {=}{\ipG{`G}[`r] \vdash (\ip{P}{`G, x : U}[`r])[d[`r]/x]}

     \step{Hypothèse de récurrence}
     {\eqbr}{\ipG{`D} \vdash (\ip{P}{`G, x : U}[`r])[d[`r]/x]}

     \step{$\ip{P}{`G, x : U}[`r] = \ip{P}{`D, x : U}$}
     {\eqbr}{\ipG{`D} \vdash \ip{P}{`D, x : U}[d[`r]/x]}
     
   \end{equations}
   
   \case{SubSub} Direct par induction.
  \end{induction}
\end{proof}

\begin{lemma}[Stabilité par affaiblissement]
  \label{narrowing-i-term}
  Si $`r : `D \sub `G$, $`G \typec t : T$ alors 
  $`D \typec t : T'$ et il existe $`a$, $\subimpl{`D}{`a}{T'}{T}$ avec
  $\ip{t}{`G}[`r] \eqbre `a[\ip{t}{`D}]$.
\end{lemma}

\begin{proof}
  La première partie du lemme se déduit par applications répétées du
  lemme de restriction \ref{narrowing-a}.
  Par induction sur la dérivation de typage:

  \begin{induction}
    \case{Var} 
    On a:
    \typenva
    \begin{prooftree}
      \BAX{Var}
      {$\wf `G$}
      {$y : T `: `G$}
      {$`G \seq y : T$}
      {}
    \end{prooftree}    
    
    Par définition de la coercion de contextes, il existe $c : y : T' \sub T
    `: `r$. Soit $`a = c$, on a bien: $\ip{y}{`G}[`r] = c[y] =
    `a[\ip{y}{`D}]$.
    
    \case{App}
    \typenva
    On a: 
    \begin{prooftree}
      \TAX{App}
      {$`G \seq f : F \quad \mualgo(F) = \Pi y : A. B$}
      {$`G \seq e : E \quad `G \seq E, A : s$}
      {$E \sub A $}
      {$`G \seq (f~e) : B [ e / y ]$}
      {}
    \end{prooftree}
    
    et donc par induction, $`D \seq f : F'$ avec
    $\subimpl{`D}{`a_f}{F'}{F}$ et
    $`D \seq e : E'$ avec $\subimpl{`D}{`a_e}{E'}{E}$.

    Par définition de l'interprétation, 
    \begin{eqnarray*}
      \ip{(f~e)}{`G}
      & = & (((\pi_F[\ip{f}{`G}])~(c_e[\ip{e}{`G}])) \\
      \text{ où } & & \\
      \pi_F & = & \coerce{`G}{F}{(\Pi y : A.B)} \\
      c_e & = & \coerce{`G}{E}{A}.
    \end{eqnarray*}
    
    Clairement, $\pi_F$ et $c_e$ sont dérivables, puisqu'on part de
    jugements dérivables par la coercion algorithmique.

    De même:
    \begin{eqnarray*}
      \ip{f~e}{`D}
      & = & (\pi_{F'}[\ip{f'}{`D}])~(c_{e'}[\ip{e'}{`D}]) \\
      \text{ où } & & \\
      \pi_{F'} & = & \coerce{`D}{F'}{(\Pi y : A'.B')} \\
      c_{e'} & = & \coerce{`D}{E'}{A'}
    \end{eqnarray*}

    On a la coercion $\subimpl{`G}{\pi_F}{F}{\Pi y : A.B}$ ; 
    par le lemme \ref{subti-coercion-subst} on obtient
    $\subimpl{`D}{\pi_F[`r]}{F}{\Pi y : A.B}$.
    On a donc les coercions suivantes:
    \[
    \xymatrix{
      F\ar[rr]_{\pi_F[`r]} & & 
      \Pi y : A.B \\
      F'\ar[u]^{`a_f}\ar[rr]^{\pi_{F'}} & &
      {\Pi y : A'.B'}\ar@{-->}[u]^{c_f}}
    \]

    Par symmétrie et transitivité de la coercion, on en déduit qu'il
    existe $c_f$, $\subimpl{`D}{c_f}{\Pi y : A'.B'}{\Pi y : A.B}$.
    La coercion $c_f$ est nécessairement de la forme:
    $\lambda y : \ip{A}{`D}.c_2[[]~c_1[y]]$ où 
    $\subimpl{`D}{c_1}{A}{A'}$ et $\subimpl{`D, x : A}{c_2}{B'}{B}$.

    Par le lemme \ref{subti-coercion-subst} on a
    $\subimpl{`D}{c_e[`r]}{E}{A}$.

    On a donc les coercions suivantes pour l'argument $e$:   
    \[
    \xymatrix{
      E\ar[rr]_{c_e[`r]} & & 
      A\ar[d]^{c_1} \\
      E'\ar[u]^{`a_e}
      \ar@{-->}[rr]^{c_{e'}} & & A'}
    \]
       

    Ce diagramme commute, il existe donc une coercion $c_{E',A} \eqbre
    c_e[`r] `o `a_e : E' \sub A$.    
    Par le lemme \ref{narrowing-i-coercion} on a donc
    $\subimpl{`D, x : E'}{c_2'}{B'}{B}$ avec $c_2' \eqbre
    c_2[(c_e[`r])[`a_e[x]]/x]$.

    Par le lemme \ref{subti-coercion-subst} avec $`D \typec e : E'$ on obtient:
    $\subimpl{`D}{c_2''}{B'[e/x]}{B[e/x]}$ avec \[c_2'' \eqbre
    c_2'[\ip{e}{`D}/x] \eqbre c_2[(c_e[`r])[`a_e[e]]/x]\]. 

  
    Soit $`a = c_2''$, on peut vérifier:
    \[\begin{array}{ll}
      \firsteq{`a[\ip{f~e}{`D}]}
      
      \step{Définition de l'interprétation}
      {=}{`a[(\pi_{F'}[\ip{f}{`D}])[c_{e'}[\ip{e}{`D}]]]}
      
      \step{Définitions de $`a$ et $c_{e'}$}
      {=}{c_2[c_e[`r]~[(`a_e[\ip{e}{`D}])]/x]~[
        ((\pi_{F'}[\ip{f}{`D}])~[(c_1 `o c_e[`r] `o `a_e)[\ip{e}{`D}]])]}
      
      \step{Définition de la composition}
      {=}{c_2[c_e[`r]~[(`a_e[\ip{e}{`D}])]/x]~[
        ((\pi_{F'}[\ip{f}{`D}])~[c_1[c_e[`r][`a_e[\ip{e}{`D}]]]])]}

      \step{Définition de $c_f$ ($= \lambda x.c_2[[]~c_1[x]]$)}
      {=}{c_f[(\pi_{F'}[\ip{f}{`D}])~[c_e[`r]~[`a_e[\ip{e}{`D}]]]]}
      
      \step{Commutation du diagramme 1}
      {\eqbre}
      {(\pi_F[`r][`a_f[\ip{f}{`D}]]~[c_e[`r][`a_e~\ip{e}{`D}]])}
      
      \step{Définitions de $`a_f$ et $`a_e$}{=}
      {(\pi_F[`r][\ip{f}{`G}[`r]])~[c_e[`r][\ip{e}{`G}[`r]]]}

      \step{Définition de l'interprétation}{=}{\ip{f~e}{`G}[`r]}
      \vspace{0.2em}
    \end{array}\]
    
    \vspace{1cm}
    
    \TODO{Autres cas}
  \end{induction}   
\end{proof}

%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "subset-typing"
%%% LaTeX-command: "TEXINPUTS=\"style:$TEXINPUTS\" latex"
%%% End: 
