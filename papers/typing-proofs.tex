\setboolean{displayLabels}{false}

\begin{lemma}[Sous-typage bien sorté]
  \label{subtyping-sorts}
  Si $`G \subtd U \sub T$ alors $`G \typed U : s$ si et seulement si
  $`G \typed T : s$.
\end{lemma}

\begin{proof}
  Par induction sur la dérivation de sous-typage.
  Pour \SubProdRule et \SubSigmaRule, par induction les composantes
  correspondantes sont dans la même sorte, donc le composé aussi.

  Pour \SubProofRule et \SubSubRule, comme le constructeur de types subset
  est de type $\Type "->" \Prop "->" \Type$, on conserve bien les mêmes
  sortes de part et d'autre.
\end{proof}

\begin{lemma}[Renforcement]
  Si $`G, x : S \seq t : T$ et $`G \subtd S' \sub S$ alors $`G, x : S'
  \seq t : T$
\end{lemma}

\begin{proof}
  
\end{proof}


\begin{lemma}[Passage de la subsumption à l'application]
  \label{subsum-elim}
  On peut réecrire toute dérivation $`G \typed t : T$ utilisant la
  subsumption ailleurs qu'à sa racine vers une dérivation l'utilisant
  uniquement à sa racine ou pour la prémisse droite de l'application.
\end{lemma}

\begin{proof}
  On inspecte les dérivations possibles utilisant \SubSubRule{} juste avant
  une autre règle.

  \begin{description}
    \item[\VarRule:] Par de prémisse de la forme $`G \typed t : T$, donc
      pas d'application de \SubsumRule{} possible.
      
    \item[\AbsRule:] \quad
      \begin{prooftree}
        \AXC{\vdots}
        \UIC{$`G \seq \Pi x : T. U : s $}
        \AXC{\vdots}
        \UIC{$`G, x : T \seq M : U'$}
        \AXC{\vdots}
        \UIC{$`G \subtd U' \sub U$}
        \BIC{$`G, x : T \seq M : U $}
        \BIC{$`G \seq \lambda x : T. M : \Pi x : T.U$}
      \end{prooftree}
      
      Par le lemme \ref{subtyping-sorts}, on a $`G \seq \Pi x : T. U' : s$.

      \begin{prooftree}
        \AXC{\vdots}
        \UIC{$`G \seq \Pi x : T. U' : s $}
        \AXC{\vdots}
        \UIC{$`G, x : T \seq M : U'$}
        \BIC{$`G \seq \lambda x : T. M : \Pi x : T.U'$}
        \AXC{$`G \subtd T \sub T$}
        \AXC{\vdots}
        \UIC{$`G \subtd U' \sub U$}
        \BIC{$`G \subtd \Pi x : T.U' \sub \Pi X : T.U$}        
        \BIC{$`G \seq \lambda x : T. M : \Pi x : T.U$}
      \end{prooftree}
      
    \item[\SumRule:]\quad
      \begin{prooftree}
        \AXC{\vdots}
        \UIC{$`G \seq \Sigma x : T.U : s $}
        \AXC{\vdots}
        \UIC{$`G \seq t : S$}
        \UIC{$`G \subtd S \sub T$}
        \BIC{$`G \seq t : T $}
        \AXC{\vdots}
        \UIC{$`G \seq u : U[t/x]$}
        \AXC{\vdots}
        \TIC{$`G \seq (t,u) : \Sigma x : T.U$}
      \end{prooftree}
      
      Comme $S \sub T$, on a bien $\Sigma x : S.U \sub \Sigma x : T.U$
      par \SubSigmaRule. On sait de plus que $\Sigma x : S.U$ est bien
      sorté de sorte $s$.

      \begin{prooftree}
        \AXC{\vdots}
        \UIC{$`G \seq \Sigma x : S.U : s $}
        \AXC{\vdots}
        \UIC{$`G \seq t : S$}
        \AXC{\vdots}
        \UIC{$`G \seq u : U[t/x]$}
        \TIC{$`G \seq (t,u) : \Sigma x : S.U$}
        \AXC{\vdots}
        \UIC{$`G \subtd \Sigma x : S.U \sub \Sigma x : T.U$}
        \BIC{$`G \seq (t,u) : \Sigma x : T.U$}
      \end{prooftree}
      
    \item[\LetSumRule,\LetInRule:]\quad
      Règles problèmatiques. Si l'on ajoute des anotations au let, on
      obtient:
      
      \begin{prooftree}
        \AXC{\vdots}        
        \UIC{$`G \seq t : T' $}
        \AXC{\vdots}
        \UIC{$`G \subtd T' \sub \Sigma x : T.U$}
        \BIC{$`G \seq t : \Sigma x : T.U $}
        \AXC{\vdots}
        \UIC{$`G, x : T, u : U \seq v : V $}
        \BIC{$`G \seq \letml (x, u) : \Sigma x : T.U = t \inml v : V$}
      \end{prooftree}
      
      On peut alors changer les règles pour faire du sous-typage dans la
      prémisse gauche. A droite c'est direct ($V' \sub V$).
      
      
    \item[\AppRule:] On autorise le sous-typage à la prémisse droite. A
      gauche on peut avoir:
      
      \begin{prooftree}
        \AXC{\vdots}
        \UIC{$`G \seq f : T' $}
        \AXC{\vdots}
        \UIC{$`G \subtd  T' \sub \Pi x : V. W$}
        \BIC{$`G \seq f : \Pi x : V. W $}
        \AXC{\vdots}
        \UIC{$`G \seq u : V $}
        \BIC{$`G \seq f u : W [ u / x ]$}
      \end{prooftree}
      
      Par inspection des règles de sous-typage, on sait que le jugement
      $T' \sub \Pi x : V.W$ résulte soit d'une application de
      \SubProdRule{} soit de \SubSubRule.
      Dans le premier cas on a la dérivation:

      \begin{prooftree}
        \AXC{\vdots}
        \UIC{$`G \seq f : \Pi x : V'.W'$}
        \AXC{\vdots}
        \UIC{$`G \subtd V \sub V'$}
        \AXC{\vdots}
        \UIC{$`G \subtd W' \sub W$}
        \BIC{$`G \subtd  \Pi x : V'.W' \sub \Pi x : V. W$}
        \BIC{$`G \seq f : \Pi x : V. W $}
        \AXC{\vdots}
        \UIC{$`G \seq u : V $}
        \BIC{$`G \seq f u : W [ u / x ]$}
      \end{prooftree}
      
      Comme on peut utiliser la subsumption sur l'argument, qu'on
      l'autorise en racine de la dérivation on réécrit cette dérivation en:

      \begin{prooftree}
        \AXC{\vdots}
        \UIC{$`G \seq f : \Pi x : V'.W'$}
        \AXC{\vdots}
        \UIC{$`G \seq u : V $}
        \AXC{\vdots}
        \UIC{$`G \subtd V \sub V'$}
        \BIC{$`G \seq u : V'$}
        \BIC{$`G \seq f u : W' [ u / x ]$}
        \AXC{\vdots}
        \UIC{$`G \subtd W' \sub W$}
        \BIC{$`G \seq f u : W [ u / x ]$}
      \end{prooftree}
      
      \def\subs{\subset{x}{U}{P}}
      Si $T' `= \subs$, on peut déduire que la dérivation est de la
      forme:
      
      \begin{prooftree}
        \AXC{\vdots}
        \UIC{$`G \seq f : \subs$}
        \AXC{\vdots}
        \UIC{$`G \subtd V \sub V'$}
        \AXC{\vdots}
        \UIC{$`G \subtd W' \sub W$}
        \BIC{$`G \subtd \Pi x : V'.W' \sub \Pi x : V.W$}
        \UIC{\vdots}
        \noLine
        \UIC{$`G \subtd U \sub \Pi x : V. W$}
        \UIC{$`G \subtd \subs \sub \Pi x : V. W$}
        \BIC{$`G \seq f : \Pi x : V. W $}
        \AXC{\vdots}
        \UIC{$`G \seq u : V $}
        \BIC{$`G \seq f u : W [ u / x ]$}
      \end{prooftree}

      On ne peut réecrire cette dérivation à cause de la
      \emph{décomprehension} du type $T'$, on doit donc 
      reprendre la fonction $\mu_0$ de \PVS{} \cite{PVS-Semantics:TR}
      renomée $\mu$ ici qui opère cette décompréhension.
      
      \begin{definition}[$\mu$]
        \begin{eqnarray*}
          \subset{x}{U}{P} & "=>" & \mu~U \\
          x                & "=>" & x
        \end{eqnarray*}
      \end{definition}
      
      On obtient la règle:
      \begin{prooftree}
        \QAX{App}
        {$`G \subtd f : T$}
        {$\mu~T = \Pi x : V. W$}
        {$`G \seq u : V' $}
        {$`G \subtd V' \sub V$}
        {$`G \seq (f u) : W [ u / x ]$}
        {$$}
      \end{prooftree}     
      
      \begin{techremark}
        En pratique, les types du Calcul des Constructions ne sont pas
        toujours en forme normale et il peut donc être nécessaire de les
        réduire pour vérifier des jugements du genre: 
        $`G \seq t : \Pi x : T.V$. On pourrait voir $\mu$ comme une
        extension de la relation de $\beta$-équivalence avec la réduction
        $\subset{x}{U}{P} "->"_\mu U$.
        On aurait 

      \end{techremark}
      
    \end{description}
  
\end{proof}

On a donc montré que l'on peut réduire l'utilisation de la règle de
subsumption aux arguments d'applications et à la racine du jugement.
On peut simplement ignorer cette dernière utilisation du sous-typage, car
cela ne peut donner qu'un type moins précis au même terme. Considérant
que nous voulons donner à la fois un terme et sa spécification, il
peut même être utile d'enlever cette dernière avant de faire la
vérification que le type inféré du terme est bien sous-type du type
spécifié.  

Conversion!. %\cite{ChenPhD}
  
\begin{lemma}[Conservation de la conversion par sous-typage]
  \label{conv-sub}
  Si $`G \typed t : T$, $T \eqbi U$ alors $`G \subti t : T \sub U$.
\end{lemma}

\begin{proof}
  Par induction sur la forme de $T$.
  
  \def\seq{\subti}.
  
  \begin{itemize}
  \item[$T$ atomique:]
    On a alors $U = T$, trivial.
    
  \item[$T `= \Pi X.Y$:]
    Alors $U `= \Pi V.W$ et $X \eqbi V$, $Y \eqbi W$, 
    donc par induction $`G \subti x : U \sub T$ et 
    $`G, x : U \subti v : V \sub W$. On applique alors
    \SubProdRule{} à ces deux prémisses.
    
  \item[$T `= \Sigma x : X.Y$:]
    $U$ est de la forme $\Sigma x : V.W$, avec $X \eqbi V$ et $Y \eqbi
    W$. Par induction et application de \SubSigmaRule.
    
  \item[$T `= \subset{x}{X}{P}$:] 
    On a alors $U `= \subset{x}{X'}{P'}$ avec $X \eqbi X'$, $P \eqbi
    P'$, et la propriété est vraie par \SubLeftRule{} et \SubRightRule{}:
    
    \begin{prooftree}
      \AXC{$`G \seq t : X \sub X'$}
      \AXC{$`G \typei P : \Pi x : X.\Prop$}
      \LeftLabel{\SubLeftRule}
      \BIC{$`G \seq t : \subset{x}{X}{P} \sub X'$}
      \LeftLabel{\SubRightRule}
      \UIC{$`G \seq t : \subset{x}{X}{P} \sub \subset{x}{X'}{P'}$}
    \end{prooftree}
    
  \end{itemize}
\end{proof}

\begin{lemma}[Substitutivité des termes du sous-typage]
  \label{substitutive-term-subtyping}
  Si $`G \subti x : U \sub T$ alors pour tout $u$ tel que $`G
  \typed u : U$, $`G \subti u : U \sub T$.
\end{lemma}
\begin{proof}
  Par induction sur la dérivation de sous-typage 
  $`G \subti x : U \sub T$:
  \def\seq{\subti}.
  
  \begin{itemize}
  \item[\SubConvRule:]
    Direct par préservation de l'équivalence $\eqbi$ par le sous-typage.
    
  \item[\SubProdRule,\SubSigmaRule:] $x$ est une variable, on ne peut
    donc pas utiliser ces règles.
    
  \item[\SubLeftRule:] On a
    \begin{prooftree}
      \BAX{Sub-Left}
      {$`G \seq x : U' \sub V$}
      {$`G \typei P : \Pi x : U'. \Prop$}
      {$`G \seq x : \subset{x}{U'}{P} \sub V$}
      {}
    \end{prooftree}
    
    On a $U `= \subset{x}{U'}{P}$ et $`G \subti x : U' \sub V$.
    Par induction, si $`G \typed u : U'$ alors $`G \subti u : U' \sub T$.
    Si $`G \typed u : \subset{x}{U'}{P}$ alors
    $`G \typed u : U'$ par application de \LetSubRule et donc par
    application de \SubLeftRule, $`G \subti u : \subset{x}{U'}{P}
    \sub V$.
    
  \item[\SubRightRule:] On a
    \begin{prooftree}
      \UAX{}
      {$`G \seq x : U \sub V'$}
      {$`G \seq x : U \sub \subset{x}{V'}{P}$}
      {}
    \end{prooftree}
    
    On a $V `= \subset{x}{V'}{P}$ et $`G \subti x : U \sub V'$.
    Par induction, si $`G \typed u : U$ alors $`G \subti u : U
    \sub V'$. Donc par application de \SubRightRule, $`G \subti u : U \sub V$.
    
  \end{itemize}
\end{proof}

\begin{lemma}[Substitutivité du sous-typage]
  \label{substitutive-subtyping}

  Si $`G, x : V \subti t : T \sub U$, $G \typei u : V$ et 
  $`G \typei t[u/x] : T[u/x]$, alors $`G \typed t[u/x] : T[u/x] \sub U[u/x]$.
\end{lemma}
%% \begin{proof}
%%   Par induction sur la dérivation de sous-typage:
%%   \def\seq{\subti}.
  
%%   \begin{itemize}
%%   \item[\SubConvRule:]
%%     On a $T \eqbi U$, $`G, x : V \subti y : T \sub U$ et
%%     $`G \typei y[u/x] : T[u/x]$.    
%%     Si $y = x$, alors on doit montrer $`G \subti u : T[u/x] \sub
%%     U[u/x]$ qui est vrai car $\eqbi$ est substitutive et $T[u/x], U[u/x]
%%     $ sont bien typés.
%%     Sinon, $`G \typei y : T[u/x] \sub U[u/x]$, vrai par
%%     substitutivité de $\eqbi$.
    
%%   \item[\SubProdRule:] On a
%%     \begin{prooftree}
%%       \SubProd
%%     \end{prooftree}
    
    
%%   \item[\SubSigmaRule:] On a 
%%     \begin{prooftree}
%%       \SubSigma
%%     \end{prooftree}
    
%%     Par hypothèse d'induction, $`G \typed t : T, U$, $`G \typed v : V[t/x], W[t/y]$.
%%     Par \SumRule, $(t, v) : \Sigma y : U, W$.

%%   \item[\SubLeftRule:] On a
%%     \begin{prooftree}
%%       \SubLeft
%%     \end{prooftree}
    
%%     Par induction, $`G \typed p : V$.

%%   \item[\SubRightRule:] On a
%%     \begin{prooftree}
%%       \SubRight
%%     \end{prooftree}
    
%%     Par induction, $`G \typed p : U$. Par \SubsetRule, $`G \typed p :
%%     \subset{x}{U}{P}$.
    
%%   \end{itemize}
%% \end{proof}

\begin{lemma}[Inversion du typage]
\label{inversion-typing}

On a les propriétés suivantes sur le jugement de typage:
\begin{enumerate}
\item Si $`G \type t : \Pi x : T.U$ alors $t = \lambda x : T.v$ et $`G, x : T
  \type v : U$.
\item Si $`G \type t : \Sigma x : T.U$ alors $t = (t', v)$, $`G, x : T \type U
  : s1$ et $`G \type v : U[t/x]$.
\item Si $`G \type t : \subset{x}{U}{P}$ alors $`G \type t : U$.
\end{enumerate}
\end{lemma}

\begin{lemma}[Inversion du sous-typage]
  \label{inversion-subtyping}
  Si $`G \subti t : \Pi x : T.U \sub \Pi x : V.W$ 
  alors $t = \lambda x : T. M$ et $`G, x : T \typei M : U$.
  
\end{lemma}

\begin{lemma}[Admissibilité de la réflexivité, transitivité du sous-typage]
  \quad
  \label{refl-trans-subtyping}
  \begin{enumerate}
  \item Pour tout $t, S$, si $`G \typed t : S$ alors $`G \subti t : S \sub S$.
  \item Pour tout $t, S, T, U$,  si $`G \subti t : S \sub T$ et $`G \subti t
    : T \sub U$ alors $`G \subti t : S \sub U$.
  \end{enumerate}
\end{lemma}

\begin{proof}  
  \begin{enumerate}
  \item $S \eqbi S$, donc pour tout $x : S$, $`G \subti x : S \sub
    S$. Par substivité du sous-typage, la propriété est vraie pour tout
    $t$ tel que $`G \typed t : S$.
  \item Dans \cite{Pierce:TypeSystems}, voir p. 420.
  \end{enumerate}
\end{proof}

\begin{lemma}[Correction du sous-typage]
  \label{correct-subtyping}
  Si $`G \subti t : U \sub V$ alors $`G \typed t : U "=>" `G
  \typed t : V$.
\end{lemma}

\begin{proof}
  Par induction sur la dérivation de sous-typage:
  
  \begin{itemize}
  \item[\SubConvRule:] On a $T \eqbi U$ et l'on suppose 
    $x \typed T$. On a donc bien $`G \typed x : U$.
    
  \item[\SubProdRule:] On a
    \begin{prooftree}
      \SubProd
    \end{prooftree}
    
    Par induction, $`G \typed x : U "=>" `G \typed x : T$, 
    $`G, x : U \typed v : V "=>" `G, x : U \typed v : W$.
    On suppose $`G \typed \lambda x : T.v : \Pi x : T.V$.
    Par inversion du typage, on a $`G, x : T \typed v : V$.
    
    Par \AbsRule, $`G \typed \lambda x : U.v : \Pi x : U.W$.
    
  \item[\SubSigmaRule:] On a 
    \begin{prooftree}
      \SubSigma
    \end{prooftree}
    
    Par hypothèse d'induction, $`G \typed t : T, U$, $`G \typed v : V[t/x], W[t/y]$.
    Par \SumRule, $(t, v) : \Sigma y : U, W$.

  \item[\SubLeftRule:] On a
    \begin{prooftree}
      \SubLeft
    \end{prooftree}
    
    Par induction, $`G \typed p : V$.

  \item[\SubRightRule:] On a
    \begin{prooftree}
      \SubRight
    \end{prooftree}
    
    Par induction, $`G \typed p : U$. Par \SubsetRule, $`G \typed p :
    \subset{x}{U}{P}$.
    
  \end{itemize}
  
\end{proof}


\begin{lemma}[Correction du typage]
  \label{correct-typing}
  $`G \typei t : T "=>" `G \typed t : T$
\end{lemma}

\begin{proof}
  Par induction sur la dérivation dans le système algorithmique:

  \begin{description}
  \item[\WfAtomRule,\WfVarRule,\PropSetRule,\VarRule,\ProdRule,\AbsRule,
    \LetInRule, \SigmaRule, \SumRule, \LetSumRule:] règles inchangées.

  \item[\AppRule:] On a
    \def\fCenter{\typei}
    \begin{prooftree}
      \AppI
    \end{prooftree}
    
    Par induction, $`G \typed f : \Pi x : V. W $.
    Par le lemme \ref{correct-subtyping}, et l'hypothèse $`G \typed u : U$, 
    $`G \typed u : V$. Donc, par \AppRule, on a bien $`G \typed f u :
    W[u/x]$.
  \end{description}
  
\end{proof}

\begin{lemma}[Complétude du typage]
  \label{complete-typing}
  $`G \typed t : T "=>" `E U, `G \typei t : U `^ `G \subti t : U \sub T$
\end{lemma}

\begin{proof}
  Par induction sur la dérivation dans le système déclaratif:

  \begin{description}
  \item[\WfAtomRule,\WfVarRule,\PropSetRule,\VarRule,\ProdRule,\AbsRule,
    \LetInRule, \SigmaRule, \SumRule, \LetSumRule:] règles inchangées.
    
  \item[\AppRule:] On a 
    \begin{prooftree}
      \App
    \end{prooftree}
    
    Par induction, $`E X, Y, `G \typei f : \Pi x : X. Y `^ 
    `G \subti f : \Pi x : X. Y \sub \Pi x : V. W$ et
    $`E U, `G \typei u : U `^ `G \subti u : U \sub V$.
    
    Si $`G \subti f : \Pi x : X.Y \sub \Pi x : V.W$, alors 
    $f$ est de la forme $\lambda x : X.v$ et par inversion (lemme
    \ref{inversion-subtyping}) $`G \subti x : V \sub X$.
    Par substitutivité du sous-typage (lemme
    \ref{substitutive-term-subtyping}), on a donc $`G \subti u : V
    \sub X$. Par transitivité du sous-typage \ref{refl-trans-subtyping}, 
    $`G \subti u : U \sub X$. On peut donc appliquer \AppRule{} pour
    obtenir $`G \typei f u : Y[u/x]$. 
    
    Par la covariance du produit en son codomaine, 
    $`G, x : V \subti v : Y \sub W$. Par substitivité du
    sous-typage (lemme \ref{substitutive-subtyping}), on a donc
    $`G \subti v[u/x] : Y[u/x] \sub W[u/x]$, la propriété est
    donc bien vérifiée.
    
  \item[\SubsetRule:] On a
    \begin{prooftree}
      \Subset
    \end{prooftree}
    
    Par induction, $`E T, `G \typei x : T `^ `G \subti x : T \sub U$.
    

  \item[\LetSubRule:]
    
  \item[\ConvRule:]

  \end{description}
  
\end{proof}


%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "subset-typing"
%%% End: 
