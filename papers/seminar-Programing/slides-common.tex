\usepackage[T1]{fontenc}
\usepackage{concrete}

\mode<all>
{
\setbeamerfont{block title}{size={}}
\usefonttheme{serif}
\usefonttheme{professionalfonts}
\setbeamercovered{invisible}
\useoutertheme[subsection=false]{smoothbars}
\useinnertheme[shadow=true]{rounded}
\usecolortheme{orchid}
\usecolortheme{whale}
\setbeamertemplate{navigation symbols}{}
\setbeamertemplate{mini frames}[box]
\setbeamertemplate{itemize items}[triangle]
\setbeamertemplate{enumerate items}[square]

}

\usepackage[latin1]{inputenc}
\usepackage{xspace} % To get the right spacings in front of : and so on
\usepackage[english]{babel}
\usepackage{subfigure}
\usepackage{bussproofs}
\usepackage{pgf}
\usepackage{colortbl}
\usepackage{xcolor}
\usepackage{abbrevs}
\usepackage{coq}

\def\PI{\name{PI}}
\def\shaded#1{{\color{black!50}#1}}
 
\EnableBpAbbreviations
\def\fCenter{\vdash}
\def\seq{\fCenter}

\hypersetup{
  pdftitle = Programing in Coq,
  pdfauthor = Matthieu Sozeau,
  pdfsubject = Theoretical Computer Science
 } 

\input{grammar-macros}

\newboolean{defineTheoremEn}
\newboolean{defineTheoremFr}
\setboolean{defineTheoremEn}{true}
\setboolean{defineTheoremFr}{false}
\input{mathenv}
\setboolean{displayLabels}{true}

\input{typing-macros}
\def\infvspace{0.5cm}

\input{typing-decl}
\input{subtyping-decl}

\input{typing-algo}
\input{subtyping-algo}

\input{typing-impl}
\input{subtyping-impl}

% [Short Paper Title] (optional, use only with long paper titles)
\title{\Program{}ing in \Coq}

\author[Matthieu Sozeau]
{{\sc Matthieu Sozeau} \\ under the direction of {\sc Christine Paulin-Mohring}}

\def\Gallium{\name{Gallium}}

\institute[]
{
  \LRI{}, Univ. Paris-Sud - \Demons{} Team \& \INRIAFuturs{} - \ProVal{} Project
}

\date % (optional, should be abbreviation of conference name)
{\Gallium seminar \\
16 march 2007}
% \date % (optional, should be abbreviation of conference name)
% {\Demons-\ProVal-\LogiCal seminar \\
% 9 march 2007}

\subject{Theoretical Computer Science}

\pgfdeclareimage[height=0.5cm]{ups-logo}{../figures/ups-logo}
\pgfdeclareimage[height=0.5cm]{lri-logo}{../figures/lri-logo}
\pgfdeclareimage[height=0.5cm]{inria-logo}{../figures/inria-logo}

\def\imgheight{7.5cm}

\pgfdeclareimage[height=\imgheight]{term}{figures/bigpicterm}
\pgfdeclareimage[height=\imgheight]{simple}{figures/bigpicsimple}
\pgfdeclareimage[height=\imgheight]{simplecoq}{figures/bigpicsimplecoq}
\pgfdeclareimage[height=\imgheight]{depone}{figures/bigpicdepone}
\pgfdeclareimage[height=\imgheight]{deponeobl}{figures/bigpicdeponeobl}
\pgfdeclareimage[height=\imgheight]{deponecoq}{figures/bigpicdeponecoq}
\pgfdeclareimage[height=\imgheight]{deponeextr}{figures/bigpicdeponeextr}
% \pgfdeclareimage[height=\imgheight]{dep}{figures/bigpicdep}
% \pgfdeclareimage[height=\imgheight]{depobl}{figures/bigpicobl}
% \pgfdeclareimage[height=\imgheight]{depoblterm}{figures/bigpicoblterm}
\pgfdeclareimage[height=\imgheight]{depextr}{figures/bigpicextr}

\pgfdeclareimage[height=4cm]{fingertree}{figures/FingerTree-ex}
\pgfdeclareimage[interpolate=true,height=8cm]{fingertree-big}{figures/FingerTree-ex}


\def\typea{\vdash}
\def\suba{\rightslice}

\newcommand{\indfig}{
  \begin{center}
    \AXC{$`G, {(\tele{x_i : X_i `~ y_i : Y_i})}_{0}^{j-1} \vdash ?_j : x_j :
      X_j `~ y_j : Y_j \quad `A j `: [0..i]$}
    \UIC{$`G \vdash c(\tele{?_i}) : I~\tele{x_i} \suba I~\tele{y_i} : s$}
    \DP    
  \end{center}
}   

\def\coqeuclid{
\coqdocindent{0.50em}
\coqdockw{Inductive} \coqdocid{diveucl} \coqdocid{a} \coqdocid{b} : \coqdockw{Set} :=\coqdoceol
\coqdocindent{1.50em}
\coqdocid{divex} : \alert{\ensuremath{\forall} \coqdocid{q} \coqdocid{r},
\coqdocid{b} > \coqdocid{r} \ensuremath{\to} \coqdocid{a} =
\coqdocid{q} \ensuremath{\times} \coqdocid{b} + \coqdocid{r}}
\ensuremath{\to} \coqdocid{diveucl} \coqdocid{a}
\coqdocid{b}.\coqdoceol

\medskip
\coqdocindent{0.50em}
\coqdockw{Lemma} \coqdocid{eucl\_dev} : \ensuremath{\forall} \coqdocid{n}, \coqdocid{n} > 0 \ensuremath{\to} \ensuremath{\forall} \coqdocid{m}:\coqdocid{nat}, \coqdocid{diveucl} \coqdocid{m} \coqdocid{n}.\coqdoceol
\noindent
\coqdocindent{0.50em}
\coqdockw{Proof}.\coqdoceol
\noindent
\coqdocindent{1.50em}
\coqdocid{intros} \coqdocid{b} \coqdocid{H} \coqdocid{a}; \coqdocid{pattern} \coqdocid{a} \coqdockw{in} \ensuremath{\vdash} \ensuremath{\times}; \coqdocid{apply} \coqdocid{gt\_wf\_rec}; \coqdocid{intros} \coqdocid{n} \coqdocid{H0}.\coqdoceol
\noindent
\coqdocindent{1.50em}
\coqdocid{elim} (\coqdocid{le\_gt\_dec} \coqdocid{b} \coqdocid{n}).\coqdoceol
\noindent
\coqdocindent{1.50em}
\coqdocid{intro} \coqdocid{lebn}.\coqdoceol
\noindent
\coqdocindent{1.50em}
\coqdocid{elim} (\coqdocid{H0} (\coqdocid{n} - \coqdocid{b})); \coqdocid{auto} \coqdockw{with} \coqdocid{arith}.\coqdoceol
\noindent
\coqdocindent{1.50em}
\coqdocid{intros} \coqdocid{q} \coqdocid{r} \coqdocid{g} \coqdocid{e}.\coqdoceol
\noindent
\coqdocindent{1.50em}
\coqdocid{apply} \coqdocid{divex} \coqdockw{with} (\coqdocid{S} \coqdocid{q}) \coqdocid{r}; \coqdocid{simpl} \coqdockw{in} \ensuremath{\vdash} \ensuremath{\times}; \coqdocid{auto} \coqdockw{with} \coqdocid{arith}.\coqdoceol
\noindent
\coqdocindent{1.50em}
\coqdocid{elim} \coqdocid{plus\_assoc}.\coqdoceol
\noindent
\coqdocindent{1.50em}
\coqdocid{elim} \coqdocid{e}; \coqdocid{auto} \coqdockw{with} \coqdocid{arith}.\coqdoceol
\noindent
\coqdocindent{1.50em}
\coqdocid{intros} \coqdocid{gtbn}.\coqdoceol
\noindent
\coqdocindent{1.50em}
\coqdocid{apply} \coqdocid{divex} \coqdockw{with} 0 \coqdocid{n}; \coqdocid{simpl} \coqdockw{in} \ensuremath{\vdash} \ensuremath{\times}; \coqdocid{auto} \coqdockw{with} \coqdocid{arith}.\coqdoceol
\noindent
\coqdocindent{0.50em}
\coqdockw{Qed}.\coqdoceol
}

\begin{document}

\begin{frame}[plain]
  \titlepage
  \vfill\hfill
  \pgfuseimage{ups-logo}
  ~
  \pgfuseimage{lri-logo}
  ~
  \pgfuseimage{inria-logo}
\end{frame}

% \begin{frame}[plain]
%   \frametitle{The Big Picture}
%   \only<1>{\pgfuseimage{term}}%
%   \only<2>{\pgfuseimage{simple}}%
%   \only<3>{\pgfuseimage{simplecoq}}\only<4>{\pgfuseimage{depone}}\only<5>{\pgfuseimage{deponeobl}}\only<6>{\pgfuseimage{deponecoq}}\only<7>{\pgfuseimage{deponeextr}}%
%   \only<8>{\coqeuclid{}}%
%   \only<9>{\pgfuseimage{depextr}}
% \end{frame}

\frame{\tableofcontents}

\section{The idea}

\subsection{A simple idea}
\begin{frame}
  \frametitle{A simple idea}
  
  \begin{block}{Definition}
    $\{ x : T `| P \}$ is the set of objects of set $T$ verifying property $P$. 
  \end{block}
  
  \begin{itemize}
  \item Useful for specifying, widely used in mathematics ;    
  \item Links object and property.
  \end{itemize}
  \pause
  \begin{block}{Adapting the idea} 
    \begin{center}
      \BAX{}{$t : T$}
      {$\uncover<3->{\alert{p} : }P[t/x]$}
      {$\uncover<3->{(}t\uncover<3->{, \alert{p})} : \mysubset{x}{T}{P}$}
      {}\DP\quad      
      \UAX{}{$t : \mysubset{x}{T}{P}$}
      {$\uncover<3->{\alert{\texttt{proj}}~}t : T$}
      {}
      \DP
    \end{center}
  \end{block}  
\end{frame}

\subsection{From \PVS to \Coq}
\begin{frame}
  \frametitle{From ``\ps''\ldots}
  
  \begin{block}{\PVS{}}
    \vspace{0.7em}
    \begin{itemize}
    \item Specialized typing algorithm for subset types, generating
      \emph{Type-checking conditions}.    
      \begin{tabular}{lcll}
        $t : \mysubset{x}{T}{P}$ & used as & $t : T$
        & ok \\
        $t : T$ & used as & $t : \mysubset{x}{T}{P}$ 
        & if $P[t/x]$
      \end{tabular}
      \pause
      
    \item[{\bf +}] Practical success ; \pause
    \item[{\bf --}] No strong safety guarantee in \PVS{}.
    \end{itemize}  
  \end{block}
%   \pause 
%   \begin{block}{\Coq{}}
%     Use coercions to explicit the equivalence:
%     \begin{tabular}{lclcl}
%       $t : \mysubset{x}{T}{P}$ & \only<4>{$"<=>"$} \only<5->{$"->"$} & $t : T$
%       & \only<5->{$"~>"$} & \only<5->{$\pi_1~t$ \\
%         $t : T$ & $"->"$ & $t : \mysubset{x}{T}{P}$ 
%         & $"~>"$ & $\sref{elt}~{t}~(\alert<3->{? : P[t/x]})$}
%     \end{tabular}
%   \end{block}
\end{frame}

\begin{frame}[t]
  \frametitle{\ldots to Subset coercions}
  
  \begin{enumerate}
  \item<1-> A property-irrelevant language (\Russell{}) with \alert{decidable} typing ;
  \item<2-> A total interpretation to \Coq{} terms with holes ;
  \item<3-> A mechanism to turn the holes into proof obligations and
    manage them.
  \end{enumerate}
  
  \begin{center}
    \UAX{}{$`G \typea t : \mysubset{x}{T}{P}$}
    {$`G \typea \uncover<2->{\texttt{proj}~}t : T$}
    {}\DP

    \vspace{0.5cm}
    \TAX{}{$`G \typea t : T$}
    {$`G, x : T \type P : \Prop$}
    {\uncover<3>{$`G \type p : P[t/x]$}}
    {$`G \type \uncover<2->{(}t\uncover<2->{, }\uncover<2->{{\only<2>{?}\only<3>{p}})} : \mysubset{x}{T}{P}$}
    {\uncover<2>{$`G \type ? : P[t/x]$}}\DP
  \end{center}
  
%   \begin{center}
%   \begin{tabular}{lclcl}
%     $t : \mysubset{x}{T}{P}$ & \only<1>{$"<=>"$} \only<2->{$"->"$} & $t : T$
%     & \only<2->{$"~>"$} & \only<2->{$\pi_1~t$ \\
%       $t : T$ & $"->"$ & $t : \mysubset{x}{T}{P}$ 
%       & $"~>"$ & $\sref{elt}~{t}~(\alert<3->{? : P[t/x]})$}
%   \end{tabular}
% \end{center}

\end{frame}

\section{Theoretical development}
\frame<beamer>{\tableofcontents[currentsection]}

\subsection{\Russell{}}

\begin{frame}
  \frametitle{\Russell{} syntax}
  
  $\begin{array}{lcl}
    x & `: & \mathcal{V} \\
    \\
    s, t, u, v & \Coloneqq & x \\
    & | & \Set \\
    & | & \Prop \\
    & | & \Type \\
\pause
    & | & \lambda x : s. t \\
    & | & s~t \\
    & | & \Pi x : s. t \\
\pause
    & | & \pair{\Sigma x : s.t}{u}{v} \\
    & | & \pi_1~s `| \pi_2~s \\
    & | & \Sigma x : s. t \\
\pause
    & | & \mysubset{x}{s}{t} 
  \end{array}$  
\end{frame}

\begin{frame}[t,label=typingdecl]
  \frametitle{\Russell{} typing $\typed$ and coercion $\subd$}
  
  Calculus of Constructions with
  \typenvd
  \setboolean{displayLabels}{false}
  \begin{center}
    \vspace{0.25cm}
    \only<1>{\Conv\DP}
    \only<2->{\Coerce\DP
      \def\fCenter{\subd}
      \SubConv\DP}
    \uncover<3->{    
    \vspace{0.25cm}
    \BAX{SubSub}
    {$`G \type U \sub V : \Set$}
    {$`G, x : U \type P : \Prop$}
    {$`G \type \mysubset{x}{U}{P} \sub V : \Set$}
    {}\DP
    \vspace{0.25cm}
    \BAX{SubProof}
    {$`G \type U \sub V : \Set$}
    {\alert{$`G, x : V \type P : \Prop$}}
    {$`G \type U \sub \mysubset{x}{V}{P} : \Set$}
    {}\DP}
  
    \vspace{0.25cm}
    \only<4-5>{
      \AXC{$`G \type 0 : `N$}
      \AXC{$`G \type `N~\sub \mysubset{x}{`N}{x \neq 0} : \Set$}
      \BIC{$`G \type 0 : \mysubset{x}{`N}{x \neq 0}$}
      \only<5>{\UIC{$`G \type \alert{? : 0 \neq 0}$}}
      \DP
    }
    \only<6->{\SubProd\DP
      
      \vspace{0.25cm}
      \SubSigma\DP}
  % \SubSigma\DP}
  \end{center}

\end{frame}

\begin{frame}
  \frametitle{Results}

  \begin{theorem}[Decidability of type checking and type inference]
    $`G \type t : T$ is decidable. 
  \end{theorem}  
  
  \uncover<2->{
    \begin{lemma}[Admissibility of transitivity]
      If $`G \type T \sub U : s `^ `G \type U \sub V : s$ then $`G \type
      T \sub V : s$.
    \end{lemma}

  \begin{theorem}[Subject Reduction]
    If $`G \type t : T$ and $t "->"_{\beta\pi} t'$ then $`G \type t' : T$.
  \end{theorem}}
  
  \begin{prooftree}
    \TAX{App}
    {$\tgen{`G}{f}{T} \quad \subgen{`G}{T}{\Pi x : A.B}{s}$}
    {$\tgen{`G}{e}{E}$}
    {$\subgen{`G}{E}{A}{s'}$}
    {$\tgen{`G}{(f~e)}{B [ e / x ]}$}
    {}
  \end{prooftree}
  
\end{frame}

\def\typec{\vdash_{?}}
\renewcommand{\subimpl}[4]{#1 \typec #2 : #3 \sub #4}

\newcommand{\blue}[1]{{\color{blue}#1}}

\subsection{Interpretation in \Coq{}}
\frame<beamer>{\tableofcontents[currentsubsection]}

\setboolean{displayLabels}{false}
\begin{frame}
  \frametitle{From \Russell{} to \Coq}
  
  \begin{block}{The target system : \CIC{} with metavariables}
    \begin{center}
      \BAX{}{$`G \typec t : T$}
      {$`G \typec p : P[t/x]$}
      {$`G \typec \elt{T}{P}{t}{p} : \mysubset{x}{T}{P}$}
      {}\DP
      
      \vspace{0.25cm}
      \UAX{}{$`G \typec t : \mysubset{x}{T}{P}$}
      {$`G \typec \eltpit~t : T$}
      {}
      \DP
      \quad
      \UAX{}{$`G \typec t : \mysubset{x}{T}{P}$}
      {$`G \typec \eltpip~t : P[\eltpit~t/x]$}
      {}
      \DP

      \vspace{0.25cm}
      \UAX{}
      {$`G \typec P : \Prop$}
      {$`G \typec ?_{P} : P$}
      {}\DP
    \end{center}
  \end{block}

  We build an interpretation $\ip{\_}{`G}$ from \Russell to \CICq
  terms.
  \pause  
  \begin{block}{Our goal}
    \begin{center}
      If $`G \type t : T$ then $\ipG{`G} \typec \ip{t}{`G} : \ip{T}{`G}$.
    \end{center}
  \end{block}
\end{frame}

\begin{frame}[t]
  \frametitle{Deriving explicit coercions}
      
  \begin{block}{Interpretation of coercions}
    \begin{center}
      If $\subgen{`G}{T}{U}{s}$ then $`G \typec c[\ctxdot] : T \sub U$ which implies
      $\ipG{`G}, x : \ip{T}{`G} \typec \blue{c}[x] : \ip{U}{`G}$.
    \end{center}
  \end{block}
  
  \uncover<2->{
    \begin{definition}
      \begin{center}
        \def\fCenter{\sub}    
        \UAX{SubConv}
        {$T \eqbr U$}
        {$\subimpl{`G}{\uncover<3->{\blue{\ctxdot}}}{T}{U}$}
        {}\DP
        
        \vspace{0.25cm}
        \uncover<4->{$\subimpl{`G}{\uncover<5->{\blue{\eltpit~\ctxdot}}}{\mysubset{x}{T}{P}}{T}$}
        
        \vspace{0.25cm}
        \uncover<6->{
          {$\subimpl{`G}
            {\uncover<7->{\blue{\elt{\_}{\_}{\ctxdot}
                {\ex{\ip{P}{`G, x : T}[\ctxdot/x]}}}}}
            {T}{\mysubset{x}{T}{P}}$}}
      \end{center}
    \end{definition}
  
    \uncover<8->{
      \begin{example}      
        \begin{prooftree}
          \AXC{$`G \typec 0 : `N$}
          \AXC{$`G \typec \elt{\_}{\_}{\ctxdot}{?_{(x \neq 0)[\ctxdot/x]}} : `N \sub \mysubset{x}{`N}{x \neq 0}$}
          \BIC{$`G \typec %(\elt{\_}{\_}{\ctxdot}{?_{(x \neq
                          %0)[\ctxdot/x]}})[0] =
            \elt{\_}{\_}{0}{?_{\alert{0 \neq 0}}} : \mysubset{x}{`N}{x \neq 0}$}
        \end{prooftree}
      \end{example}}
  }
\end{frame}

\begin{frame}
  \frametitle{Interpretation of terms}
    
  \begin{example}[Application]
    \setboolean{displayLabels}{false}
    \typenva
    \begin{center}
      \TAX{App}
      {$\tgen{`G}{f}{T} \quad \subgen{`G}{T}{\Pi x : V. W}{s}$}
      {$\tgen{`G}{u}{U}$} % \quad \tgen{#1}{#9, #5}{#7'}$}
      {$\subgen{`G}{U}{V}{s'}$}
      {$\tgen{`G}{(f~u)}{W[u/x]}$}
      {}
      \DP
    \end{center}
    
    \typenvi
    \[\begin{array}{lcll}
      \ip{f~u}{`G} 
      & = & \letml~\pi = \coerce{`G}{T}{(\Pi x : V.W)}~\inml & \\
      & & \letml~c = \coerce{`G}{U}{V}~\inml & \\
      & & (\pi[\ip{f}{`G}])~(c[\ip{u}{`G}]) & \\
    \end{array}\]    
  \end{example}
  \begin{theorem}[Soundness]
    If $`G \typea t : T$ then $\ipG{`G} \typec \ip{t}{`G} : \ip{T}{`G}$.
  \end{theorem}
\end{frame}


\begin{frame}
  \frametitle{Theoretical matters \dots}
  
  $\typec$'s equational theory:
  
  \[\begin{array}{llcll}
    \shaded{(\beta)} & \shaded{(\lambda x : X.e)~v} & \shaded{`=} & \shaded{e[v/x]} & \\
    \shaded{(\pi_i)} & \shaded{\pi_i~\pair{T}{e_1}{e_2}} & \shaded{`=} & \shaded{e_i} & \\
    \shaded{(\sigma_i)} & \shaded{\sigma_i~(\elt{E}{P}{e_1}{e_2})} & \shaded{`=} & \shaded{e_i} & \\
    (\eta) & (\lambda x : X.e~x) & `= & e & \text{if $x `; FV(e)$} \\ % et $e : \Pi x : X.Y$} \\
    (\text{\SP}) % & \pair{\Sigma x : X.Y}{\pi_1~e}{\pi_2~e} & `= & e & \\ % \text{if $e : \Sigma x : X. Y$} \\
    & \elt{E}{P}{(\eltpit~e)}{(\eltpip~e)} & `= & e & \\%\text{if $e : \mysubset{x}{E}{P}$} \\
    \uncover<2->{(\alert{\PI}) & \elt{E}{P}{t}{p} & `= & \elt{E}{P}{t'}{p'} & \text{if $t
        `= t'$}}
  \end{array}\]

  \uncover<2->{$"=>"$ \alert{Proof Irrelevance}}

  \uncover<3->{
  \begin{block}{\dots have practical effects}
    Difficulty to reason on code: $f (\elt{T}{P}{x}{p_1}) \not`= f (\elt{T}{P}{x}{p_2})$.
  \end{block}}
\end{frame}

\subsection{Inductive types}
\def\vector#1{\coqid{vector}~#1}
\def\vnil{\coqid{vnil}}
\def\vcons{\coqid{vcons}}

\begin{frame}
  \frametitle{Inductive types}
  
  \begin{block}{Different representations}
    $\vector{n} "=" \mysubset{x}{\coqid{list}~A}{\coqid{length}~x = n}$ or
    $\vector{n} "=" \coqid{vnil} : \vector{0} `| \coqid{vcons} : A "->" `A n, \vector{n}
    "->" \vector{(S~n)}$ ?
  \end{block}
  
  \pause
  \begin{center}
    \begin{prooftree}
      \AXC{$`G \type v : \vector{x}$}
      \AXC{$`G \type \vector{x} \suba \vector{y} : \Set$}
      \BIC{$`G \type v : \vector{y}$}
    \end{prooftree}
  \end{center}

  \pause
  \begin{block}{A natural extension: reindexing}
    Let $I~\tele{x}$ be an inductive type with \emph{real} arguments
    $\tele{x}$.
    We can coerce any object of this type to an object of
    $I~\tele{y}$ provided $\tele{x} = \tele{y}$.
  \end{block}
  
\end{frame}

\section{\Program}
\frame<beamer>{\tableofcontents[currentsection]}

\subsection{Architecture}
\begin{frame}[t]
  \frametitle{The \Program vernacular}
  
  \begin{block}{Architecture}
    Wrap around \Coq{}'s vernacular commands (\texttt{Definition},
    \texttt{Fixpoint}, \texttt{Lemma}, \ldots).
    
    \begin{enumerate}
    \item<2-> Use the \Coq{} parser.
%     \item<3-> Typecheck $`G^{\circ} \type t : T$ and generate
%       $\ipG{`G^{\circ}} \typec \ip{t}{`G^{\circ}} : \ip{T}{`G^{\circ}}$ ;
    \item<3-> Typecheck $`G \type t : T$ and generate
      $\ipG{`G} \typec \ip{t}{`G} : \ip{T}{`G}$ ;
    \item<4-> Interactive proving of obligations ;
    \item<5-> Final definition.
    \item[]<6-> \alert{Restriction} We assume $`G \typecci \ip{T}{`G} : s$. % $`G^{\circ} = `G$      
    \end{enumerate}
  \end{block}
  
  \only<2->{
    \[\uncover<2-4>{\texttt{Program}~}\texttt{Definition}~f~:
    \uncover<3->{\llbracket} T \uncover<3->{\rrbracket_{`G}} := 
    \uncover<3->{\llbracket} t
    \uncover<3->{\rrbracket_{`G}}\uncover<4->{ + \text{ obligations}}.\]}
  
\end{frame}

\subsection{Hello world}
\begin{frame}
  \frametitle{Hello world: Euclidean division}

  \begin{center}
    \centering{\Huge DEMO}
  \end{center}
\end{frame}

\subsection{Extensions}
\frame<beamer>{\tableofcontents[currentsubsection]}

\begin{frame}[t]
  \frametitle{Pattern-matching revisited}
  
  Put \alert{logic} into the terms.

  \uncover<3->{
    \begin{block}{Further refinements}
      \begin{itemize}
      \item<3-> Each branch typed only once ;
      \item<5-> Add inequalities for intersecting patterns ;
      \item<6-> Generalized to dependent inductive types.
      \end{itemize}
    \end{block}}
  
  \only<1-5>{
    Let $e : `N$:
    \only<1-2>{\[ \begin{array}{ll}
        \matchml~e\uncover<2->{~\asml~t~} & \returnml~\uncover<2->{t = e "->"} T~\withml \\
        `| S~n "=>" & \uncover<2->{\funml{}~(H : S~n = e) "=>"} t_1 \\
        `| 0 "=>" & \uncover<2->{\funml{}~(H : 0 = e) "=>"} t_2 \\
        \enml & \uncover<2->{(\sref{refl\_equal}~e)}
      \end{array}\]}
    \only<3-5>{
      \[ \begin{array}{ll}
        \matchml~e~\asml~t & \returnml~t = e "->" T~\withml \\
        `| S~(S~n) "=>" & \funml{}~(H : S~(S~n) = e) "=>" t_1 \\
        `| \only<4>{S~0}\only<3,5>{n} "=>" & \funml{}~(H : \only<4>{S~0}\only<3,5>{n} = e)
        "=>" \only<5->{\letml~H' : \alert<5>{`A n', n "/="
            S~(S~n')}}~\inml~t_2 \\
        \only<4>{\!\!`| 0 "=>" & \funml{}~(H : 0 = e) "=>" t_2 \\}
        \enml & (\sref{refl\_equal}~e)
      \end{array}\]}
  }
    % \only<1-4>{
%   Let $e : \mysubset{x}{`N}{P}$:
%   \[ \begin{array}{ll}
%     \matchml~\uncover<2->{\eltpit(}e\uncover<2->{)~\asml~t~} & \returnml~\uncover<2->{t = \eltpit{(e)} "->"} T~\withml \\
%     `| S~(S~n) "=>" & \uncover<2->{\funml{}~H : S~(S~n) = \eltpit{(e)} "=>"} t_1 \\
%     `| \only<3>{S~}n "=>" & \uncover<2->{\funml{}~(H : \only<3>{S~}n =
%       \eltpit{(e)})}
%     \only<4->{\alert<4>{(\_ : `A n', n "/=" S~(S~n'))}}
%     "=>" t_2 \\
%     \only<3>{\!\!`| 0 "=>" & \uncover<2->{\funml{}~H : 0 = \eltpit{(e)} "=>"} t_2 \\}
%     \enml & \uncover<2->{(\sref{refl\_equal}~\eltpit{(e)})}
%   \end{array}\]}

  \only<6->{
    Let $e : \vector{n}$:
    \[ \begin{array}{l}
      \matchml~e~\uncover<7->{\asml~t~\inml~\vector{n'}}~\returnml~\uncover<7->{\alert{n' = n} "->" t \alert{"~="} e "->"} T~\withml \\
      `| \vnil "=>" \uncover<7->{\funml{}~(H : \alert{0 = n}) (Hv : \vnil \alert{"~="} e) "=>"} t_1 \\
      `| \vcons~x~n'~v' "=>" \uncover<7->{\funml{}~(H : \alert{S~n' = n}) (Hv :
        \vcons~x~n'~v' \alert{"~="} e) "=>"} t_2 \\%
    \enml \uncover<7->{(\coqid{refl\_equal}~n) (\coqid{JMeq\_refl}~e)}
  \end{array}\]}

\end{frame}

\begin{frame}
  \frametitle{Sugar}

  \begin{block}{Obligations}
    Unresolved implicits ($\_$) are turned into obligations, \`a la \alert{\texttt{refine}}.
  \end{block}
  
  \begin{block}{Bang}
    $! "=" (\texttt{False\_rect}~\_~\_)$ where {\small $\texttt{False\_rect} : `A
    A : \Type, \texttt{False} "->" A$}. It corresponds to \ML's
    \texttt{assert(false)}.
  \end{block}
  
  \[\matchml~0~\withml~0 "=>" 0 `| n "=>" !~\enml\]
  % \pause
%   \begin{block}{Destruction}
%     Let $\destml~t~\asml~p~\inml~e "=" \matchml~t~\withml~p "=>" e~\enml$.
%     $p$ can be an arbitrary pattern.
%   \end{block}
  

\end{frame}

\begin{frame}
  \frametitle{Recursion}

  Support for well-founded recursion (and measures).
  \[ \texttt{Program}~\Fixpoint~f~(a : `N)~\{ \mlkw{wf} < a \} : `N := b. \]
  
  \uncover<2->{
    \[\begin{array}{lcl}
      a & : & `N \\
      f & : & \{ x : `N `| x < a \} "->" `N \\
      \hline
      b & : & `N
    \end{array}\]
  }
\end{frame}

% \subsection{Safe lists}
% \begin{frame}[t]
%   \frametitle{\Program: The list example}
%   \vspace{-0.75em}
%   \begin{center}%
%     \only<1>{\pgfuseimage{subtac-syntax}}%
%     \only<2>{\pgfuseimage{myhd-proof}}%
%     \only<3>{\pgfuseimage{myhd-extract}}%
%     \only<4>{\pgfuseimage{mytail-extract}}%
%     \only<5>{\pgfuseimage{mytest-good}}%
%     \only<6>{\pgfuseimage{mytest-bad}}%
%     \only<7>{\pgfuseimage{append-proof}}%
%     \only<8>{\pgfuseimage{append-extract}}%
%     \only<9>{\pgfuseimage{append-app}}%
%   \end{center}
% \end{frame}

\section{Finger Trees}
\frame<beamer>{\tableofcontents[currentsection]}

\subsection*{Finger Trees}
\begin{frame}
  \frametitle{A quick tour of Finger Trees}
  
  \begin{itemize}
  \item A simple general purpose data structure (Hinze \& Paterson, 2006) ;
  \item Purely functional, nested datatype ;
  \item General purpose, parameterized data structure (gives sequences,
    priority queues, search trees...) ;
  \item Efficient deque operations (amortized constant time) and
    concatenation and splitting (logarithmic in smallest argument's
    size).
  \item Simple implementation compared to Kaplan \& Tarjan's
    catenable dequeues, efficient in practice.
  \end{itemize}
  
\end{frame}

\begin{frame}
  \frametitle{The Big Finger Tree Picture}
  \pgfuseimage{fingertree-big}
\end{frame}

\begin{frame}[t]
  \frametitle{Digits}
  \scriptsize{
  \coqdockw{Section} \coqdocid{Digit}.\coqdoceol
\coqdocindent{1.00em}
\coqdockw{Variable} \coqdocid{A} : \coqdockw{Type}.\coqdoceol


\medskip

\coqdocindent{1.00em}
\coqdockw{Inductive} \coqdocid{digit} : \coqdockw{Type} := \coqdoceol
\coqdocindent{1.00em}
\coqor  \coqdocid{One} : \coqdocid{A} \ensuremath{\to} \coqdocid{digit}\coqdoceol
\coqdocindent{1.00em}
\coqor  \coqdocid{Two} : \coqdocid{A} \ensuremath{\to} \coqdocid{A} \ensuremath{\to} \coqdocid{digit}\coqdoceol
\coqdocindent{1.00em}
\coqor  \coqdocid{Three} : \coqdocid{A} \ensuremath{\to} \coqdocid{A} \ensuremath{\to} \coqdocid{A} \ensuremath{\to} \coqdocid{digit}\coqdoceol
\coqdocindent{1.00em}
\coqor  \coqdocid{Four} : \coqdocid{A} \ensuremath{\to} \coqdocid{A} \ensuremath{\to} \coqdocid{A} \ensuremath{\to} \coqdocid{A} \ensuremath{\to} \coqdocid{digit}.\coqdoceol

\medskip

\coqdocindent{1.00em}
\coqdockw{Definition} \coqdocid{full} \coqdocid{x} := \coqdockw{match} \coqdocid{x} \coqdockw{with} \coqdocid{Four} \coqdocid{\_} \coqdocid{\_} \coqdocid{\_} \coqdocid{\_} \ensuremath{\Rightarrow} \coqdocid{True} \coqor  \coqdocid{\_} \ensuremath{\Rightarrow} \coqdocid{False}  \coqdockw{end}.\coqdoceol
% \coqdocindent{1.00em}
% \coqdockw{Definition} \coqdocid{single} (\coqdocid{x} : \coqdocid{digit}) := \coqdockw{match} \coqdocid{x} \coqdockw{with} \coqdocid{One} \coqdocid{\_} \ensuremath{\Rightarrow} \coqdocid{True} \coqor  \coqdocid{\_} \ensuremath{\Rightarrow} \coqdocid{False} \coqdockw{end}.\coqdoceol
\pause

\medskip
\coqdocindent{1.00em}
\coqdockw{Program Definition} \coqdocid{add\_digit\_left} (\coqdocid{a} : \coqdocid{A}) (\coqdocid{d} : \coqdocid{digit} \coqor  \ensuremath{\lnot} \coqdocid{full} \coqdocid{d}) : \coqdocid{digit} :=\coqdoceol
\coqdocindent{2.00em}
\coqdockw{match} \coqdocid{d} \coqdockw{with}\coqdoceol
\coqdocindent{3.00em}
\coqor  \coqdocid{One} \coqdocid{x} \ensuremath{\Rightarrow} \coqdocid{Two} \coqdocid{a} \coqdocid{x}\coqdoceol
\coqdocindent{3.00em}
\coqor  \coqdocid{Two} \coqdocid{x} \coqdocid{y} \ensuremath{\Rightarrow} \coqdocid{Three} \coqdocid{a} \coqdocid{x} \coqdocid{y}\coqdoceol
\coqdocindent{3.00em}
\coqor  \coqdocid{Three} \coqdocid{x} \coqdocid{y} \coqdocid{z} \ensuremath{\Rightarrow} \coqdocid{Four} \coqdocid{a} \coqdocid{x} \coqdocid{y} \coqdocid{z}\coqdoceol
\coqdocindent{3.00em}
\coqor  \coqdocid{Four} \coqdocid{\_} \coqdocid{\_} \coqdocid{\_} \coqdocid{\_} \ensuremath{\Rightarrow} !\coqdoceol
\coqdocindent{2.00em}
\coqdockw{end}.\coqdoceol
\coqdocindent{1.00em}
\coqdockw{Next} \coqdockw{Obligation}.\coqdoceol
\noindent
\coqdocindent{2.00em}
\coqdocid{intros} ; \coqdocid{simpl} \coqdockw{in} \coqdocid{n} ; \coqdocid{auto}.\coqdoceol
\noindent
\coqdocindent{1.00em}
\coqdockw{Qed}.\coqdoceol

}


\end{frame}

\begin{frame}[t]
  \frametitle{Monoids \& Nodes}
\scriptsize{
\coqdocindent{1.00em}
\coqdockw{Variable} \coqdocid{v} : \coqdockw{Type}.\coqdoceol
\coqdocindent{1.00em}
\coqdockw{Variable} \coqdocid{mono} : \coqdocid{monoid} \coqdocid{v}.\coqdoceol
\medskip
\coqdocindent{1.00em}
\coqdockw{Notation} "'$\varepsilon$'" := \coqdocid{mempty} \coqdocid{mono}.\coqdoceol
\coqdocindent{1.00em}
\coqdockw{Infix} "$\cdot$" := \coqdocid{mappend} \coqdocid{mono} (\coqdocid{right} \coqdocid{associativity}, \coqdocid{at} \coqdocid{level} 20).\coqdoceol
\medskip
\coqdocindent{1.00em}
\coqdockw{Program Definition} \coqdocid{listMonoid} (\coqdocid{A} :
\coqdockw{Type}) : \coqdocid{monoid} (\coqdocid{list} \coqdocid{A}) := \coqdoceol
\coqdocindent{2.00em}
\coqdocid{mkMonoid} \coqdocid{nil} \coqdocid{app} \coqdocid{\_} \coqdocid{\_} \coqdocid{\_}.\coqdoceol
\medskip
\pause
\coqdocindent{1.00em}
\coqdockw{Section} \coqdocid{Nodes}.\coqdoceol
\coqdocindent{2.00em}
\coqdockw{Variable} \coqdocid{A} : \coqdockw{Type}.\coqdoceol
\coqdocindent{2.00em}
\coqdockw{Variable} \coqdocid{measure} : \coqdocid{A} \ensuremath{\to} \coqdocid{v}.\coqdoceol
\coqdocindent{2.00em}
\coqdockw{Notation} "'\ensuremath{\coqdoublebar}' \coqdocid{x} '\ensuremath{\coqdoublebar}'" $\coloneqq$ (\coqdocid{measure} \coqdocid{x}).\coqdoceol

\medskip
\coqdocindent{2.00em}
\coqdockw{Inductive} \coqdocid{node} : \coqdockw{Type} $\coloneqq$\coqdoceol
\coqdocindent{2.00em}
\coqor  \coqdocid{Node2} : \ensuremath{\forall} \coqdocid{x} \coqdocid{y}, \{ \coqdocid{s} : \coqdocid{v} \coqor  \coqdocid{s} = $\coqdoublebar$ \coqdocid{x} $\coqdoublebar$ $\cdot$ $\coqdoublebar$ \coqdocid{y} $\coqdoublebar$ \} \ensuremath{\to} \coqdocid{node}\coqdoceol
\coqdocindent{2.00em}
\coqor  \coqdocid{Node3} : \ensuremath{\forall} \coqdocid{x} \coqdocid{y} \coqdocid{z}, \{ \coqdocid{s} : \coqdocid{v} \coqor  \coqdocid{s} = $\coqdoublebar$ \coqdocid{x} $\coqdoublebar$ $\cdot$ $\coqdoublebar$ \coqdocid{y} $\coqdoublebar$ $\cdot$ $\coqdoublebar$ \coqdocid{z} $\coqdoublebar$ \} \ensuremath{\to} \coqdocid{node}.\coqdoceol
\pause
\medskip
\coqdocindent{2.00em}
\coqdockw{Program Definition} \coqdocid{node2} (\coqdocid{x} \coqdocid{y} : \coqdocid{A}) : \coqdocid{node} $\coloneqq$ \coqdoceol
\coqdocindent{3.00em}
\coqdocid{Node2} \coqdocid{x} \coqdocid{y} ($\coqdoublebar$ \coqdocid{x}
$\coqdoublebar$ $\cdot$ $\coqdoublebar$ \coqdocid{y}
$\coqdoublebar$).\coqdoceol
\medskip
\coqdocindent{2.00em}
\coqdockw{Program Definition} \coqdocid{node\_measure} (\coqdocid{n} : \coqdocid{node}) : \coqdocid{v} $\coloneqq$\coqdoceol
\coqdocindent{3.00em}
\coqdockw{match} \coqdocid{n} \coqdockw{with} \coqor  \coqdocid{Node2} \coqdocid{\_} \coqdocid{\_} \coqdocid{s} \ensuremath{\Rightarrow} \coqdocid{s} \coqor  \coqdocid{Node3} \coqdocid{\_} \coqdocid{\_} \coqdocid{\_} \coqdocid{s} \ensuremath{\Rightarrow} \coqdocid{s} \coqdockw{end}.\coqdoceol
}

\end{frame}

\begin{frame}[t]
  \frametitle{Dependent Finger Trees}
  \small{
  \coqdockw{Inductive} \coqdocid{fingertree} (\coqdocid{A} :
  \coqdockw{Type}) \only<2->{(\alert<2>{\coqdocid{measure} :
      \coqdocid{A} \ensuremath{\to} \coqdocid{v}})} : \only<3->{\alert{\coqdocid{v}} \ensuremath{\to} }\coqdockw{Type} $\coloneqq$\coqdoceol
  \coqor  \coqdocid{Empty} : \coqdocid{fingertree} \coqdocid{A}
  \only<2->{\alert<2>{\coqdocid{measure}}\only<3->{ \alert{$\varepsilon$}}}\coqdoceol
  \coqor  \coqdocid{Single} : \ensuremath{\forall} \coqdocid{x} :
  \coqdocid{A}, \coqdocid{fingertree} \coqdocid{A} \only<2->{\alert<2>{\coqdocid{measure}}\only<3->{ (\alert{\coqdocid{measure} \coqdocid{x}})}}\coqdoceol
  \coqor  \coqdocid{Deep} : \ensuremath{\forall} (\coqdocid{l} :
  \coqdocid{digit} \coqdocid{A})\only<3->{ (\alert{\coqdocid{m} : \coqdocid{v}})},\coqdoceol
  \coqdocindent{1.00em}
  \coqdocid{fingertree} (\alert<1>{\coqdocid{node} \coqdocid{A}}\only<2->{ \alert<2>{\coqdocid{measure}}})
  \only<2->{(\alert<2>{\coqdocid{node\_measure} \coqdocid{A}
      \coqdocid{measure}})\only<3->{\alert<3->{ \coqdocid{m}}}}
  \ensuremath{\to}\coqdoceol \coqdocindent{1.00em}
  \ensuremath{\forall} \coqdocid{r} : \coqdocid{digit} \coqdocid{A}, \coqdoceol
  \coqdocindent{1.00em}
  \coqdocid{fingertree} \coqdocid{A}\only<2->{
    \alert<2>{\coqdocid{measure}}\only<3->{\coqdoceol\coqdocindent{3.00em}(\alert{\coqdocid{digit\_measure} \coqdocid{measure} \coqdocid{l}
        $\cdot$ \coqdocid{m} $\cdot$ \coqdocid{digit\_measure}
        \coqdocid{measure} \coqdocid{r}})}}.
  \coqdoceol}

  \only<1>{
  \begin{center}
    \pgfuseimage{fingertree}
  \end{center}}

  \only<2>{
    \begin{center}
      \small{\coqdocid{node\_measure} \coqdocid{A}
      (\coqdocid{measure} : \coqdocid{A} \ensuremath{\rightarrow}
      \coqdocid{v})  : \coqdocid{node A measure}
      \ensuremath{\rightarrow} \coqdocid{v}}
    \end{center}
  }
  
\end{frame}

\begin{frame}[t]
  \frametitle{Adding to the left}

  \medskip
  \coqdockw{Program Fixpoint} \coqdocid{add\_left} \coqdocid{A}
  (\coqdocid{measure} : \coqdocid{A} \ensuremath{\to} \coqdocid{v})
  \coqdoceol
  \coqdocindent{1.00em}
  (\alert{\coqdocid{a}} : \coqdocid{A}) (\alert{\coqdocid{s}} : \coqdocid{v})
  (\coqdocid{t} : \coqdocid{fingertree} \coqdocid{measure} \coqdocid{s})
  \{\coqdocid{struct} \coqdocid{t}\} : \coqdoceol
  \coqdocindent{1.00em}
  \coqdocid{fingertree} \coqdocid{measure} (\alert{\coqdocid{measure} \coqdocid{a} $\cdot$ \coqdocid{s}}) $\coloneqq$\coqdoceol
  \coqdocindent{1.00em}
  \coqdockw{match} \coqdocid{t} \coqdockw{with}\coqdoceol
  \coqdocindent{2.00em}
  \coqor  \coqdocid{Empty} \ensuremath{\Rightarrow} \coqdocid{Single} \coqdocid{a}\coqdoceol
  \coqdocindent{2.00em}
  \coqor  \coqdocid{Single} \coqdocid{b} \ensuremath{\Rightarrow} \coqdocid{Deep} (\coqdocid{One} \coqdocid{a}) \coqdocid{Empty} (\coqdocid{One} \coqdocid{b})\coqdoceol
  \coqdocindent{2.00em}
  \coqor  \coqdocid{Deep} \coqdocid{pr} \coqdocid{st'} \coqdocid{t'} \coqdocid{sf} \ensuremath{\Rightarrow} \coqdoceol
  \coqdocindent{3.00em}
  \only<1>{$\cdots$}\only<2->{
  \coqdockw{match} \coqdocid{pr} \coqdockw{with}\coqdoceol
  \coqdocindent{4.00em}
  \coqor  \coqdocid{Four} \coqdocid{b} \coqdocid{c} \coqdocid{d}
  \coqdocid{e} \ensuremath{\Rightarrow}\coqdoceol
  \coqdocindent{5.00em}
  \coqdockw{let} \coqdocid{sub} $\coloneqq$ \coqdocid{add\_left} (\alert{\coqdocid{node3} \coqdocid{measure} \coqdocid{c} \coqdocid{d} \coqdocid{e}}) \coqdocid{t'} \coqdockw{in}\coqdoceol
  \coqdocindent{6.00em}
  \coqdocid{Deep} (\coqdocid{Two} \coqdocid{a} \coqdocid{b}) \coqdocid{sub} \coqdocid{sf}\coqdoceol
  \coqdocindent{4.00em}
  \coqor  \coqdocid{x} \ensuremath{\Rightarrow} \coqdocid{Deep} (\alert{\coqdocid{add\_digit\_left} \coqdocid{a} \coqdocid{pr}}) \coqdocid{t'} \coqdocid{sf}\coqdoceol
  \coqdocindent{3.00em}
  \coqdockw{end}}\coqdoceol
  \coqdocindent{1.00em}
  \coqdockw{end}.\coqdoceol
  
\end{frame}

\begin{frame}
  \frametitle{Dependent Finger Trees - cont'd}

  \begin{block}{Two hundred lines, one hundred obligations concatenation}
    \coqdocindent{1.00em}
    \coqdockw{Definition} \coqdocid{app} (\coqdocid{A} : \coqdockw{Type}) (\coqdocid{measure} : \coqdocid{A} \ensuremath{\to} \coqdocid{v}) \coqdoceol
    \coqdocindent{2.00em}
    (\coqdocid{xs} : \coqdocid{v}) (\coqdocid{x} : \coqdocid{fingertree} \coqdocid{measure} \coqdocid{xs})\coqdoceol
    \coqdocindent{2.00em}
    (\coqdocid{ys} : \coqdocid{v}) (\coqdocid{y} : \coqdocid{fingertree} \coqdocid{measure} \coqdocid{ys}) : \coqdoceol
    \coqdocindent{2.00em}
    \coqdocid{fingertree} \coqdocid{measure} (\coqdocid{xs} $\cdot$
    \coqdocid{ys}).\coqdoceol
  \end{block}
  
  Splitting, views can be defined in a similar way.

\end{frame}

\begin{frame}
  \frametitle{A glimpse of Finger Trees in \Coq}
  
  \begin{block}{The development}
    \begin{itemize}
    \item Certified implementation of Finger Trees. 
      Certified implementation of sequences built on top of Finger Trees.
    \item $\sim$ 1200 lines of specification, $\sim$ 1400 of proof, mostly unchanged
      code.
    \item Extracts to \Haskell and \Ocaml (with magic).
    \end{itemize}
  \end{block}
  \pause
  \begin{block}{Conclusions}
    \begin{itemize}
    \item[+] \Program scales ;
    \item[+] Subset types arise naturally ;
    \item[+] Dependent types are a powerful specification tool ;      
    \item[--] Need more language technology, e.g: overloading ;
    \item[--] Some difficulties with reasoning and computing.
    \end{itemize}   
  \end{block}
  
\end{frame}

\section{Conclusion}
\begin{frame}
  \frametitle{Conclusion}
  
  \begin{block}{Our contributions}
    \begin{itemize}
    \item A more \alert{flexible} programming language, (almost) \alert{conservative} over
      \CIC, \alert{integrated} with the existing environment and a
      formal \alert{justification} of ``\ps{}''.
    \item A tool to make \alert{programming} in \Coq using the \alert{full} language
      possible, which can \alert{effectively} be used for non-trivial
      developments.
    \end{itemize}
  \end{block}
  
  \begin{block}{Future work}
    Reasoning support through tactics, implementation of
    proof-irrelevance in \Coq's kernel.
  \end{block}
  
\end{frame}

\begin{frame}
  \frametitle{The End}
  \centering{
    \begin{center}
      \url{http://www.lri.fr/~sozeau/research/russell.en.html}
    \end{center} 
  }
\end{frame}

\begin{frame}
  \frametitle{Why eta rules and proof irrelevance ?}
  
  Let $A,B : \Type$, $c : A \suba B$, $d : B \suba A$. 
  \pause
  
  Let $P : A "->" \Prop$ with $p : \Pi x : A, P~x$ and $q : \Pi x : B,
  P~x$.
  
  \pause
  Consider: $p~x =_{(P~x)} q~x$ in context $`G "=" x : A$. 
  
  By $\ip{\_}{`G}$: $\ip{P}{`G} "=" P$, $\ip{p}{`G} "=" p$ and
  $\ip{q}{`G} "=" q : \alert{\Pi x : B, P~d[x]}$, \pause 
  
  hence: $\ip{p~x =_{(P~x)} q~x}{`G} "=" p~x =_{(P~x)} \alert{q~c[x]}$.

  We have $p~x : P~x$ but $q~c[x] : P~d[c[x]]$, so $x `= d[c[x]]$ is
  necessary.
  This means eta rules for all constructs are needed.
  \pause
  
  Now: $c "=" \elt{A}{P}{\cdot}{?_{P[\cdot/x]}} : A \suba
  \mysubset{x}{A}{P}$ and $d "=" \eltpit{\cdot} : \mysubset{x}{A}{P}
  \suba A$, so $d[c[x]] "=" x$ but what about $c[d[x]]$ ? 
  \pause

  $c[d[x]] "=" \elt{A}{P}{(\eltpit~x)}{?_{P[\eltpit x/x]}} \alert{\not`=}
  x$ except if PI is included in $`=$.
  
\end{frame}



\begin{frame}
  \frametitle{Dependent Inductive coercion rule}
  \indfig

  \small{
    \begin{center}
      \begin{prooftree}
        \AXC{$\dots$}
        \AXC{$`G \typec ?_{x=y} : x = y$}
        \UIC{$`G \typec \eqrec{`N}{x}{\vector{}}{\ctxdot}{y}{?_{x = y}} : \vector{x} \suba \vector{y}$}
        \BIC{$`G \typec \eqrec{`N}{x}{\vector{}}{v}{y}{?_{x = y}} : \vector{y}$}
      \end{prooftree}
      
      $\texttt{eq\_rec} : `A (A : \Set) (x : A) (P : A "->" \Set),
      P~x "->" `A y, x = y "->" P~y$
    \end{center}
  }
\end{frame}

\begin{frame}
  \frametitle{Splitting nodes}
  
  \scriptsize{\coqdocindent{1.00em}
\coqdockw{Program Definition} \coqdocid{splitNode} (\coqdocid{p} : \coqdocid{v} \ensuremath{\to} \coqdocid{bool}) (\coqdocid{i} : \coqdocid{v}) (\coqdocid{n} : \coqdocid{node} \coqdocid{measure}) : \coqdoceol
\coqdocindent{1.00em}
\{ \coqdocid{s} : \coqdocid{split} (\coqdockw{fun} \coqdocid{A} \ensuremath{\Rightarrow} \coqdocid{option} (\coqdocid{digit} \coqdocid{A})) \coqdocid{A} \coqor  \coqdockw{let} (\coqdocid{l}, \coqdocid{x}, \coqdocid{r}) $\coloneqq$ \coqdocid{s} \coqdockw{in}\coqdoceol
\coqdocindent{2.00em}
\coqdockw{let} \coqdocid{ls} $\coloneqq$ \coqdocid{option\_digit\_measure} \coqdocid{measure} \coqdocid{l} \coqdockw{in}\coqdoceol
\coqdocindent{2.00em}
\coqdockw{let} \coqdocid{rs} $\coloneqq$ \coqdocid{option\_digit\_measure} \coqdocid{measure} \coqdocid{r} \coqdockw{in}\coqdoceol
\coqdocindent{2.00em}
\coqdocid{node\_measure} \coqdocid{n} = \coqdocid{ls} $\cdot$ $\coqdoublebar$ \coqdocid{x} $\coqdoublebar$ $\cdot$ \coqdocid{rs} \ensuremath{\land}\coqdoceol
\coqdocindent{2.00em}
\coqdocid{node\_to\_list} \coqdocid{n} = \coqdocid{option\_digit\_to\_list} \coqdocid{l} $\app$ [x] $\app$ \coqdocid{option\_digit\_to\_list} \coqdocid{r} \ensuremath{\land}\coqdoceol
\coqdocindent{2.00em}
(\coqdocid{l} = \coqdocid{None} \ensuremath{\lor} \coqdocid{p} (\coqdocid{i} $\cdot$ \coqdocid{ls}) = \coqdocid{false}) \ensuremath{\land}\coqdoceol
\coqdocindent{2.00em}
(\coqdocid{r} = \coqdocid{None} \ensuremath{\lor} \coqdocid{p}
(\coqdocid{i} $\cdot$ \coqdocid{ls} $\cdot$ $\coqdoublebar$ \coqdocid{x}
$\coqdoublebar$) = \coqdocid{true})\} $\coloneqq$ $\ldots$}
\end{frame}

\begin{frame}
  \frametitle{Instantiation: sequences}
  \framesubtitle{The monoid and measure: executable semantics}

  \coqdockw{Definition} \coqdocid{below} \coqdocid{i} := \{ \coqdocid{x} : \coqdocid{nat} | \coqdocid{x} $<$ \coqdocid{i} \}.\coqdoceol
  \medskip
  \coqdockw{Definition} \coqdocid{v} := \{ \coqdocid{i} : \coqdocid{nat} \& (\coqdocid{below} \coqdocid{i} \ensuremath{\to} \coqdocid{A}) \}.\coqdoceol
  \medskip
  \pause
  \coqdockw{Program Definition} $\varepsilon$ : \coqdocid{v} := 0 $\Yleft$ (\coqdockw{fun} \coqdocid{\_} \ensuremath{\Rightarrow} !).\coqdoceol
  \coqdockw{Program Definition} \coqdocid{append} (\coqdocid{xs} \coqdocid{ys} : \coqdocid{v}) : \coqdocid{v} := \coqdoceol
  \coqdocindent{1.00em}
  \coqdockw{let} (\coqdocid{n}, \coqdocid{fx}) := \coqdocid{xs} \coqdockw{in}
  \coqdockw{let} (\coqdocid{m}, \coqdocid{fy}) := \coqdocid{ys} \coqdockw{in}\coqdoceol
  \coqdocindent{2.00em}
  (\coqdocid{n} + \coqdocid{m}) $\Yleft$ \coqdoceol
  \coqdocindent{3.00em}
  (\coqdockw{fun} \coqdocid{i} \ensuremath{\Rightarrow} \coqdockw{if}
  \coqdocid{lt\_ge\_dec} \coqdocid{i} \coqdocid{n} \coqdockw{then}
  \coqdocid{fx} \coqdocid{i} \coqdockw{else} \coqdocid{fy}
  (\coqdocid{i} - \coqdocid{n})).\coqdoceol
  \medskip
  \coqdockw{Program Definition} \coqdocid{seqMonoid} := @\coqdocid{mkMonoid} \coqdocid{v} $\varepsilon$ \coqdocid{append} \coqdocid{\_} \coqdocid{\_} \coqdocid{\_}.\coqdoceol
  \pause
  \medskip
  \coqdockw{Program Definition} \coqdocid{measure} (\coqdocid{x} : \coqdocid{A}) : \coqdocid{v} := 1 $\Yleft$ (\coqdockw{fun} \coqdocid{\_} \ensuremath{\Rightarrow} \coqdocid{x}).\coqdoceol  
  
\end{frame}

\begin{frame}
  \frametitle{Instantiation: sequences}
  \framesubtitle{The sequence and its operations}
    
  \coqdockw{Definition} \coqdocid{seq} (\coqdocid{x} : \coqdocid{v}) := \coqdocid{fingertree} \coqdocid{seqMonoid} \coqdocid{measure} \coqdocid{x}.\coqdoceol
  \medskip
  \coqdockw{Program Fixpoint} \coqdocid{make} (\coqdocid{i} :
  \coqdocid{nat}) (\coqdocid{v} : \coqdocid{A}) \{ \coqdocid{struct}
  \coqdocid{i} \} : \coqdoceol \coqdocindent{1.00em} \coqdocid{seq} (\coqdocid{i} $\Yleft$ (\coqdockw{fun} \coqdocid{\_} \ensuremath{\Rightarrow} \coqdocid{v})). \coqdoceol
  \medskip
  \pause
  \coqdockw{Program Definition} \coqdocid{get} (\coqdocid{i} : \coqdocid{nat}) (\coqdocid{m} : \coqdocid{below} \coqdocid{i} \ensuremath{\to} \coqdocid{A}) \coqdoceol
  \coqdocindent{1.00em}
  (\coqdocid{x} : \coqdocid{seq} (\coqdocid{i} $\Yleft$ \coqdocid{m})) (\coqdocid{j} : \coqdocid{below} \coqdocid{i}) : \{ \coqdocid{value} : \coqdocid{A} | \coqdocid{m} \coqdocid{j} = \coqdocid{value} \}.\coqdoceol
  \medskip
  \pause
  \coqdockw{Program Definition} \coqdocid{set} (\coqdocid{i} : \coqdocid{nat}) (\coqdocid{m} : \coqdocid{below} \coqdocid{i} \ensuremath{\to} \coqdocid{A})  \coqdoceol
  \coqdocindent{1.00em}
  (\coqdocid{x} : \coqdocid{seq} (\coqdocid{i} $\Yleft$ \coqdocid{m})) (\coqdocid{j} : \coqdocid{below} \coqdocid{i}) (\coqdocid{value} : \coqdocid{A}) \coqdoceol
  \coqdocindent{1.00em}
  :  \coqdocid{seq} (\coqdocid{i} $\Yleft$ (\coqdockw{fun} \coqdocid{idx} : \coqdocid{below} \coqdocid{i} \ensuremath{\Rightarrow} \coqdockw{if} \coqdocid{eq\_nat\_dec} \coqdocid{idx} \coqdocid{j} \coqdockw{then} \coqdocid{value} \coqdockw{else} \coqdocid{m} \coqdocid{idx})).\coqdoceol
  
\end{frame}

\end{document}

%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "slides"
%%% LaTeX-command: "x=pdf; TEXINPUTS=\"~/research/publication/styles:..:../style:../figures:\" ${pdfx}latex"
%%% TeX-PDF-mode: t
%%% End: 
