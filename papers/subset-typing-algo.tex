\subsection{Élaboration du système algorithmique \& propriétés}

Pour pouvoir implémenter le typeur, il nous faut un système dirigé par la
syntaxe. 
C'est presque le cas pour la coercion, il y a juste la règle
\irule{SubConv} qu'on peut appliquer à n'importe quel moment. 


\subsubsection*{Conversion}
On note $\suba$ le même système que figure \ref{subtyping-decl-rules} mais
où l'on n'applique \irule{SubConv} seulement si aucune autre règle ne
s'applique.

On montre que les deux systèmes de coercion sont équivalents: 

Il nous faut tout d'abord un lemme sur la conversion:
\begin{lemma}
  \label{conv-prod}
  Si $\Pi T U \eqbi S$ alors $S \eqbi \Pi T' U'$ avec $T \eqbi T'$ et $U
  \eqbi U'$.
\end{lemma}

Le seul cas intéressant est si les deux termes sont dans la relation de $\beta$-équivalence:
\begin{lemma}[Conservation de la conversion par sous-typage]
  \label{conv-sub}
  Si $`G \typea T, U : s$ et $T \eqbi U$ alors $T \suba U$.
\end{lemma}

\begin{proof}
  Par induction sur la forme de $T$.
  
  \def\seq{\suba}.
  
  \begin{itemize}
  \item[$T$ atomique:]
    On a alors $U = T$, trivial.
    
  \item[$T `= \Pi X.Y$:]
    Alors $U `= \Pi V.W$ et $X \eqbi V$, $Y \eqbi W$
    d'après le lemme \ref{conv-prod}.
    Par induction $X \sub Y$ et $V \sub W$. 
    On applique alors \irule{SubProd} à ces deux prémisses.
    
  \item[$T `= \Sigma X.Y$:]
    $U$ est de la forme $\Sigma V.W$, avec $X \eqbi V$ et $Y \eqbi
    W$. Par induction et application de \irule{SubSigma}.
    
  \item[$T `= \subset{x}{X}{P}$:] 
    On a alors $U `= \subset{x}{X'}{P'}$ avec $X \eqbi X'$, $P \eqbi
    P'$, et la propriété est vraie par \irule{SubLeft} et \irule{SubRight}:
    
    \begin{prooftree}
      \AXC{$X \sub X'$}
      \LeftLabel{\SubLeftRule}
      \UIC{$\subset{x}{X}{P} \sub X'$}
      \LeftLabel{\SubRightRule}
      \UIC{$\subset{x}{X}{P} \sub \subset{x}{X'}{P'}$}
    \end{prooftree}
  \end{itemize}
\end{proof}


Il faut cependant s'assurer que deux types de sortes
différentes ne peuvent être identifiés. En effet dans notre système
la $\beta$-convertibilité n'assure pas que deux termes ont la même
sorte, par exemple:
$\typed (\lambda x : \Type. x)~(\nat:\Set) : \Type "->"_\beta \nat : \Set$.
\TODO{Dans mon système, on ne peut pas faire la coercion de nat à Set}

Le fait que les arguments sont tout deux sortés avec la même sorte
avant de dériver le jugement de coercion nous assure que l'on ne fera
pas d'identification erronée. 

En conséquence $\subd$ et $\suba$ sont équivalentes. Le système
d'inférence de $\suba$ donne donc un algorithme pour décider de la relation
de coercion. L'indéterminisme entre les règles \irule{SubProof} et
\irule{SubSub} ne pose pas de problème: on peut laisser le choix à 
l'implémentation puisque le système est confluent.

Cependant, il reste une source importante d'indécidabilité dans le
système de typage, c'est la règle de coercion. On va l'éliminer du
système algorithmique après avoir montré que
toute dérivation de typage utilisant \irule{Coerce} peut se réécrire en
une dérivation n'utilisant cette règle qu'à sa racine.
\def\subs{\subset{x}{U}{P}}
Il nous faut changer quelque peu les règles pour obtenir le système
algorithmique. En particulier, on va utiliser la fonction $\mu0$ de \PVS{}
\cite{PVS-Semantics:TR} renomée $\mu$ ici pour opèrer des
\emph{décompréhension}. Cette fonction efface les constructeurs de type
sous-ensemble en tête d'un type, par exemple: $\mualgo(\subset{f}{\nat
  "->" \nat}{f~0 = 0}) = \nat "->" \nat$. Cela va nous permettre de
restreindre l'utilisation du jugement du sous-typage à l'application.

\TODO{bof}
\begin{remark}
  En pratique, les types du Calcul des Constructions ne sont pas
  toujours en forme normale et il peut donc être nécessaire de les
  réduire pour vérifier des jugements du genre: 
  $`G \seq t : \Pi x : T.V$. On pourrait voir $\mu$ comme une
  extension de la relation de $\beta$-équivalence avec la réduction
  $\subset{x}{U}{P} "->"_\mu U$. 
\end{remark}

\subsection*{Sommes dépendantes}
En inspectant la règle \irule{Sum}, on remarque qu'il n'est pas possible
d'inférer le type $U$ à partir du seul terme $(t, u)$. Cela
nécessiterait de résoudre un problème d'unification d'ordre supérieur
auquel il n'y a pas de solution la plus générale. On introduit donc dans
le système algorithmique deux nouvelles règles, dont une (\irule{SumDep})
permettant d'annoter le terme avec le type $U$ recherché. On considère
que c'est à l'utilisateur d'annoter suffisament les termes. Par défaut,
si le terme n'est pas annoté on considère l'objet $(u, v)$ comme une
paire non-dépendante (\irule{SumInf}).

\typenva
\typeaFig
\typemuaFig
\subtaFig

\subsection*{Subsumption}
\typenva

% On enlève \irule{Coerce} du système et on change la règle 
% d'application \irule{App} de la figure \ref{typing-decl-rules}.
% On note $\typea$ le système de typage obtenu. 

\begin{proposition}[Passage de la subsumption à l'application]
  \label{subsum-elim}
  On peut réecrire toute dérivation $`G \typea t : T$ utilisant la
  subsumption ailleurs qu'à sa racine vers une dérivation $`G \type t :
  U$ avec $U \suba T$.
\end{proposition}

On a besoin de quelques lemmes auparavant:

\begin{lemma}[$\beta$-equivalences et $\mu$]
  \label{beta-mu}
  Si $X \sub Y$ et $\mu~Y \eqbi \Sigma x : T.U$ alors $\mu X \eqbi \Sigma x : T'.U'$
  et $T' \sub T$, $U' \sub U$.
  Si $X \sub Y$ et $\mu~Y \eqbi \Pi x : T.U$ alors $\mu X \eqbi \Pi x :
  T'.U'$ et $T \sub T'$, $U' \sub U$.
\end{lemma}
\begin{proof}
  \begin{induction}
    Par induction sur la dérivation de coercion, on fait le cas pour $\Sigma$.
    
    \case{SubConv} Trivial, puisqu'on aura $\mu~X = \mu~Y$.

    \case{SubProd} Impossible, $\mu$ ne traversant pas les produits.

    \case{SubSigma} Direct, on a une dérivation de $\Sigma x : T'. U'
    \sub \Sigma x : T.U$.
    
    \case{SubLeft} Ici, $Y `= \subset{x}{V}{P}$, on peut donc déduire que
    $\mu~Y = \mu~V \eqbi \Sigma x : T.U$. On 
    applique l'hypothèse de récurence avec $X \sub V$ et on obtient:
    $\mu~X \eqbi \Sigma x : T'.U' `^ T' \sub T `^ U' \sub U$.

    \case{SubRight} Ici, $X `= \subset{x}{V}{P}$. Par induction, 
    $\mu~V = \mu~X \eqbi \Sigma x : T'.U' `^ T' \sub T `^ U' \sub U$.
  \end{induction}
\end{proof}

\begin{proof}
  On inspecte les dérivations possibles utilisant \irule{Coerce} juste avant
  une autre règle.
  
  \typenva
  \begin{induction}
    \case{Var} Par de prémisse de la forme $`G \type t : T$, donc
    pas d'application de \irule{Subsum} possible.
    
    \case{Abs} \quad
    
    \begin{prooftree}
      \AXC{\vdots}
      \UIC{$`G \seq \Pi x : T. U : s $}
      \AXC{\vdots}
      \UIC{$`G, x : T \seq M : U'$}
      \AXC{\vdots}
      \UIC{$`G, x : T \seq U', U : s$}
      \AXC{\vdots}
      \UIC{$U' \sub U$}
      \TIC{$`G, x : T \seq M : U $}
      \BIC{$`G \seq \lambda x : T. M : \Pi x : T.U$}
    \end{prooftree}
    
    Comme $`G, x : T \typed U' : s$ on peut former le produit 
    $`G \typea \Pi x : T. U' : s$.
    On réecrit donc la dérivation en:     
    
    \begin{prooftree}
      \AXC{\vdots}
      \UIC{$`G \seq \Pi x : T. U' : s $}
      \AXC{\vdots}
      \UIC{$`G, x : T \seq M : U'$}
      \BIC{$`G \seq \lambda x : T. M : \Pi x : T.U'$}
      \AXC{$T \eqbi T$}
      \UIC{$T \sub T$}
      \AXC{\vdots}
      \UIC{$U' \sub U$}
      \BIC{$\Pi x : T.U' \sub \Pi X : T.U$}        
      \BIC{$`G \seq \lambda x : T. M : \Pi x : T.U$}
    \end{prooftree}
    
    \case{Sum}\quad
    
    \begin{prooftree}
      \AXC{\vdots}
      \UIC{$`G \seq \Sigma x : T.U : s $}
      \AXC{\vdots}
      \UIC{$`G \seq t : S$}
      \AXC{\vdots}
      \UIC{$S \sub T$}
      \BIC{$`G \seq t : T $}
      \AXC{\vdots}
      \UIC{$`G \seq u : U[t/x]$}
      \TIC{$`G \seq (t,u) : \Sigma x : T.U$}
    \end{prooftree}
    
    Comme $S \sub T$, on a bien $\Sigma x : S.U \sub \Sigma x : T.U$
    par \irule{SubSigma}. On sait de plus que $\Sigma x : S.U$ est bien
    sorté de sorte $s$. En effet, par inversion de $`G \seq \Sigma x :
    T.U : s$ on a $`G, x : T \seq U : s$ et par renforcement ($S \sub T$), $`G, x : S \seq
    U : s$. On peut donc dériver:

    \begin{prooftree}
      \AXC{\vdots}
      \UIC{$`G \seq \Sigma x : S.U : s $}
      \AXC{\vdots}
      \UIC{$`G \seq t : S$}
      \AXC{\vdots}
      \UIC{$`G \seq u : U[t/x]$}
      \TIC{$`G \seq (t,u) : \Sigma x : S.U$}
      \AXC{\vdots}
      \UIC{$\Sigma x : S.U \sub \Sigma x : T.U$}
      \BIC{$`G \seq (t,u) : \Sigma x : T.U$}
    \end{prooftree}
    
    \case{LetSum}\quad
    \begin{prooftree}
      \AXC{\vdots}        
      \UIC{$`G \seq t : S $}
      \AXC{\vdots}
      \UIC{$S \sub V$}
      \BIC{$`G \seq t : V$}
      \AXC{$\mu~V \eqbi \Sigma x : T.U$}
      \AXC{\vdots}
      \UIC{$`G, x : T, u : U \seq v : V $}
      \TIC{$`G \seq \letml~(x, u) = t~\inml~v : V$}
    \end{prooftree}
    
    Par le lemme \ref{beta-mu}, on a $\mu~S \eqbi \Sigma x : T'.U'$,
    $T' \suba T$ et $U' \suba U$. Par renforcement (lemme
    \ref{narrowing-i}) on a:

    \begin{prooftree}
      \AXC{\vdots}        
      \UIC{$`G \seq t : S $}
      \AXC{$\mu~S \eqbi \Sigma x : T'.U'$}
      \AXC{\vdots}
      \UIC{$`G, x : T', u : U' \seq v : V $}
      \TIC{$`G \seq \letml~(x, u) = t~\inml~v : V$}
    \end{prooftree}

    Si l'on applique la subsumption à droite c'est direct ($V' \sub V$).
    
    \case{LetIn}
    De façon similaire, par renforcement on obtient la dérivation sans \irule{Coerce}.
    
    \case{App}\quad    
    \begin{prooftree}
      \AXC{\vdots}
      \UIC{$`G \seq f : T $}
      \AXC{\vdots}
      \UIC{$ T \sub \Pi x : V. W$}
      \BIC{$`G \seq f : \Pi x : V. W $}
      \noLine
      \UIC{$\mualgo(\Pi x : V.W) \eqbi \Pi x : V.W$}
      \AXC{\vdots}
      \UIC{$`G \seq u : U $}
      \AXC{\vdots}
      \UIC{$U \sub V$}
      \TIC{$`G \seq f u : W [ u / x ]$}
    \end{prooftree}
    
    Par le lemme \ref{beta-mu} on a $\mu(T) \eqbi \Pi x : V'.W'$ avec
    $V \suba V'$ et $W' \suba W$. Par la transitivité de la coercion on
    a: $U \suba V `^ V \suba V' "=>" U \suba V'$.
    On peut donc dériver:
    
    \begin{prooftree}
      \AXC{\vdots}
      \UIC{$`G \seq f : T $}
      \noLine
      \UIC{$\mualgo(T) \eqbi \Pi x : V'.W'$}
      \AXC{\vdots}
      \UIC{$`G \seq u : U $}
      \AXC{\vdots}
      \UIC{$U \sub V'$}
      \TIC{$`G \seq f u : W [ u / x ]$}
    \end{prooftree}
    
    \case{Subsum}\quad

    Dans le cas où l'on a un enchainement de règles \irule{Coerce}:
    \begin{prooftree}
      \AXC{\vdots}
      \UIC{$`G \seq t : S$}
      \AXC{\vdots}
      \UIC{$S \sub T$}
      \BIC{$`G \seq t : T$}
      \AXC{\vdots}
      \UIC{$T \sub U$}
      \BIC{$`G \seq t : U$}
    \end{prooftree}
    
    En utilisant la transitivité de la coercion on obtient:
    \begin{prooftree}
      \AXC{\vdots}
      \UIC{$`G \seq t : S$}
      \AXC{\vdots}
      \UIC{$S \sub U$}
      \BIC{$`G \seq t : U$}
    \end{prooftree}

  \end{induction}
  
\end{proof}

Par induction, on a donc montré que l'on peut réduire l'utilisation de la règle de
subsumption à la racine d'une dérivation. On peut ignorer sans perte de généralité 
l'utilisation de la coercion à la racine de la dérivation, 
on fera de toute façon un test de coercion entre le type inféré et le
type spécifié juste avant la réécriture. On considère maintenant le
système algorithmique comme présenté figure \ref{fig:typing-algo-rules}.

\begin{lemma}[Substitutivité du typage]
  \label{substitutive-typing}
  Si $`G, x : U \typea t : T$ et $`G \typea u : U$ alors
  $`G \typea t[u/x] : T[u/x]$.
\end{lemma}

\begin{proof}
  \typenva
  Par induction sur la dérivation de typage $`G, x : U \typea t : T$.
  
  \begin{induction}
    \casetwo{PropSet}{Type} 
    La substitution n'a aucun effet et $`G$ est bien
    formé.

    \case{Var}
    Si $t `= x$ alors on a $T = U$ et $T[u/x] = U$ puisque $x$
    n'apparait pas dans $U$. On a donc bien $`G \typea t[u/x] = u :
    T[u/x] = U$.
    
    \case{Prod}
    Par induction  $`G \typea (\Pi x : T.U)[u/x] : s[u/x]$ et
    

    \case{Abs}
    \case{App}
    \case{LetIn}
    \case{Sigma}
    \case{Sum}
    \case{LetSum}
    \case{Subset}

  \end{induction}
  
\end{proof}


\begin{lemma}[Substitutivité de la coercion]
  \label{substitutive-coercion}
  Si $U \suba T$ alors pour tout $u$, $U[u/x] \suba T[u/x]$.
\end{lemma}

\begin{proof}
  
  \begin{induction}[subtyping-algo]
    \case{SubConv}
    Direct par préservation de l'équivalence $\eqbi$ par substitution.
    
    \case{SubProd}
    Par induction $U[u/x] \suba T[u/x]$ et $V[u/x] \suba W[u/x]$, donc
    $\Pi y : T[u/x].V[u/x] \suba \Pi y : U[u/x].W[u/x]$. La propriété
    est donc bien vérifiée.
    
    \case{SubSigma} Direct par induction.
    
    \case{SubSub} Par induction, $U'[u/x] \suba V[u/x]$. On applique
    \irule{SubLeft} pour obtenir $\sub{y}{U'[u/x]}{P} \suba V[u/x]$. 
    
    \case{SubRight} Direct par induction.
  \end{induction}
\end{proof}

\begin{lemma}[Substitutivité du typage avec coercion]
  \label{substitutive-typing-coercion}
  Si $`G, x : V \typea t : T \sub U$, $G \typea u : V$
  alors $`G \typed t[u/x] : T[u/x] \sub U[u/x]$.
\end{lemma}

\begin{proof}
  Par substitutivité du typage (\ref{substitutive-typing}) on a $`G \typed t[u/x] : T[u/x]$.
  Par le lemme précédent $T[u/x] \suba U[u/x]$.
\end{proof}

\begin{lemma}[Inversion de la coercion]
  \label{inversion-subtyping}
  Si $`G \subta \lambda x : T. M : \Pi x : T.U \sub \Pi x : V.W$ 
  alors $`G, x : T \typea M : U$.
\end{lemma}
\begin{proof}
  \TODO{pas utilisé ?}
\end{proof}

\begin{fact}[Symétrie de la coercion]
  La relation $\sub$ est symétrique.
\end{fact}

\begin{lemma}[Coercion et $\mu$]
  \label{coercion-mu}
  Si $\Pi x : X.Y \sub U$ alors $\mu(U) \eqbi \Pi x : X'.Y'$ et $X' \sub
  X$, $Y \sub Y'$.
  Si $\Sigma x : X.Y \sub U$ alors $\mu(U) \eqbi \Sigma x : X'.Y'$ et $X \sub
  X'$, $Y \sub Y'$.
  Pour tout $U$, $U \sub \mu(U)$.
\end{lemma}
\begin{proof}
  Par induction sur les dérivations de $\suba$ et la définition de $\mu$.
\end{proof}

\begin{lemma}[Coercion et conversion]
  \label{coercion-conv}
  Si $S \eqbi T$ et $T \sub U$ alors $S \sub U$
\end{lemma}

\begin{proof}
  Par simple inspection des règles on voit que le jugement ne peut
  distinguer deux termes $\beta$-équivalents.
\end{proof}

\begin{lemma}[Transitivité de la coercion]
  \label{trans-subtyping}
  Pour tout $S, T, U$,  si $S \sub T$ et $T \sub U$ alors $S \sub U$.
\end{lemma}

\begin{proof}  
  \TODO{Dans \cite{Pierce:TypeSystems}, voir p. 420}
  On procède par élimination de la règle \irule{SubTrans} dans toute
  dérivation de $S \sub U$.
  
  \begin{induction}[subtyping-decl]

    \case{SubConv}\quad
    \begin{prooftree}
      \AXC{$S \eqbi T$}
      \UIC{$S \sub T$}
      \AXC{$T \sub U$}
      \BIC{$S \sub U$}
    \end{prooftree}
    
    Par le lemme précédent, on élimine trivialement \irule{SubTrans}.

    \case{SubProd}\quad
    \begin{prooftree}
      \AXC{$X' \sub X$}
      \AXC{$Y \sub Y'$}
      \BIC{$\Pi~X~Y \sub \Pi~X'~Y'$}
      \AXC{$\Pi~X'~Y' \sub U$}
      \BIC{$\Pi~X~Y \sub U$}
    \end{prooftree}
    
    Si $\Pi~X'~Y' \sub U$, alors il existe $S$, $T$, tel que $\mu(U)
    \eqbi \Pi~S~T$ et $S \sub X'$, $Y' \sub T$.
    Par induction, $S \sub X$ et $Y \sub T$ donc $\Pi~X~Y \sub \Pi~S~T$ 
    et enfin $\Pi~X~Y \sub U$.

    De facon équivalente pour le second cas.

    \case{SubSigma}\quad
    \begin{prooftree}
      \AXC{$X \sub X'$}
      \AXC{$Y \sub Y'$}
      \BIC{$\Sigma~X~Y \sub \Sigma~ X'~Y'$}
      \AXC{$\Sigma~X'~Y' \sub U$}
      \BIC{$\Sigma~X~Y \sub U$}
    \end{prooftree}
    
    Si $\Sigma~X'~Y' \sub U$, alors il existe $S$, $T$, tel que $\mu(U)
    \eqbi \Sigma~S~T$ et $X' \sub S$, $Y' \sub T$.
    Par induction, $X \sub S$ et $Y \sub T$ donc $\Sigma~X~Y \sub
    \Sigma~S~T$ et enfin $\Sigma~X~Y \sub U$ (lemme \ref{coercion-mu}).
    
    De façon équivalente pour le second cas.

    \case{SubProof}\quad
    \begin{prooftree}
      \AXC{$S \seq V$}
      \UIC{$S \seq \subset{x}{V}{P}$}
      \AXC{$\subset{x}{V}{P} \sub U$}
      \BIC{$S \sub U$}
    \end{prooftree}
    
    Si $\subset{x}{V}{P} \sub U$ alors $\mu(U) \eqbi V$.
    Comme $S \seq V$, par induction, $S \seq \mu(U)$ donc
    $S \sub U$.
    
    De façon équivalente pour le second cas.

    \case{SubSub}
    Cas identique à \irule{SubProof}
    
  \end{induction}
\end{proof}

\begin{corrolary}[Complétude de la coercion]
  \label{complete-coercion}
  Si $U \subd V$ alors $U \suba V$.
\end{corrolary}

\begin{proof}
  Les règles des deux systèmes sont les mêmes excepté \irule{SubTrans}
  qu'on peut éliminer dans le système algorithmique. De plus
  l'application restreinte de la conversion ne change pas les jugements
  dérivables (lemme \label{conv-sub}).
\end{proof}

\begin{theorem}[Correction de la coercion]
  \label{correct-coercion}
  Si $U \suba V$ alors $U \subd V$.
\end{theorem}

\begin{proof}
  Les règles du système algorithmique sont un sous-ensemble des règles
  du système déclaratif.
\end{proof}

\begin{theorem}[Correction du typage]
  \label{correct-typing}
  Si $`G \typea t : T$ alors $`G \typed t : T$
\end{theorem}

\setboolean{displayLabels}{false}
\begin{proof}
  \begin{induction}[typing-algo]
  \item[\irule{WfEmpty},\irule{WfVar},\irule{PropSet},\irule{Var},\irule{Prod},\irule{Abs},
    \irule{LetIn}, \irule{Sigma}, \irule{Sum}:] règles inchangées.
    
    \case{LetSum}
    On a 
    \begin{prooftree}
      \LetSumA
    \end{prooftree}
    
    Par induction, $`G \typed t : S$, et par correction de la coercion $S \subd \Sigma x : T. U$.
    On peut donc dériver $`G \typed t : \Sigma x : T.U$ à l'aide de \irule{Coerce}.
    On peut directement appliquer \irule{LetSum} à cette prémisse et à
    l'hypothèse d'induction $`G, x : T, y : U \typed v : V$.
    
    \case{App} On a:
    \def\fCenter{\typea}
    \begin{prooftree}
      \AppA
    \end{prooftree}
    
    Par induction, $`G \typed f : T$, et $T \subd \Pi x : V. W$.
    On peut donc dériver $`G \typed f : \Pi x : V.W$ à l'aide de la
    subsumption.
    Par le lemme \ref{correct-coercion}, et l'hypothèse $`G \typed u :
    U$, on obtient $`G \typed u : V$ par \irule{Subsum}.
    Donc, par \irule{App}, on a bien $`G \typed f u : W[u/x]$.
  \end{induction}  
\end{proof}

\setboolean{displayLabels}{true}
\begin{lemma}[Complétude du typage]
  \label{complete-typing}
  $`G \typed t : T "=>" `E U, `G \subta t : U \sub T$
\end{lemma}

\begin{proof}
  \begin{induction}[typing-decl]
  \item[\irule{WfEmpty},\irule{WfVar},\irule{PropSet},\irule{Var},\irule{Prod},\irule{Abs},
    \irule{LetIn}, \irule{Sigma}, \irule{Sum}, \irule{Subset}:] règles inchangées.
    
    \case{App} On a 
    \typenvd
    \begin{prooftree}
      \App
    \end{prooftree}
    
    \typenva
    Par induction, $`E T, `G \typea f : T \suba \Pi x : V. W$ et
    $`E U, `G \subta u : U \sub V$.
    
    Si $T \suba \Pi x : V.W$ alors $\mualgo(T) \eqbi \Pi x : V'.W'$ avec
    $V \suba V'$ et $W' \suba W$.

    Par transivité de la coercion: $U \suba V'$, on peut donc dériver 
    \begin{prooftree}
      \TAX{App}
      {$`G \seq f : T \quad \mualgo(T) \eqbi \Pi x : V'. W'$}
      {$`G \seq u : U \quad `G \seq U, V' : s$}
      {$U \suba V'$}
      {$`G \seq (f u) : W' [ u / x ]$}
      {}
    \end{prooftree}
    
    Par substitutivité de la coercion (lemme
    \ref{substitutive-subtyping}), $W'[u/x] \suba W[u/x]$, la propriété
    est donc bien vérifiée.

    \case{LetSum} On a
    \typenvd
    \begin{prooftree}
      \LetSum
    \end{prooftree}
    
    \typenva
    Par induction, $`E S, `G \typea t : S \suba \Sigma x : T.U$ et 
    $`E V', `G, x: T, y : U \typea v : V' \suba V$.
    On a $\mualgo(S) \eqbi \Sigma x : T'.U'$ avec $T' \suba T$ et $U'
    \suba U$. Par renforcement on peut donc dériver $`G, x : T', y : U'
    \seq v : V'$.
    
    On a donc la dérivation suivante dans le système algorithmique:
    \begin{prooftree}
      \TAX{LetSum}
      {$`G \seq t : S$}
      {$\mualgo(S) \eqbi `S x : T'. U'$}
      {$`G, x : T', y : U' \seq v : V'$}
      {$`G \seq \letml~(x, u) = t~\inml~v : V'$}
      {}
    \end{prooftree}
    
    Comme $V' \suba V$, la propriété est vraie.

    \casetwo{Conv}{Subsum}
    Dans les deux cas on a inductivement $`E T', `G \typea t : T'
    \suba T$. Avec \irule{Conv} on a $T \eqbi S$, donc $T' \suba S$ par
    le lemme \ref{sub-conv}. Pour \irule{Subsum} on a $T \subd S$.
    Par complétude de la coercion, $T \suba S$ et par transitivité de la
    coercion, $T' \suba S$. La propriété est donc bien vérifiée dans les
    deux cas.
    
  \end{induction}
  
\end{proof}

On combine les théorêmes de correction et complétude pour obtenir la propriété suivante entre les deux systèmes:
\begin{corrolary}[Équivalence des systèmes déclaratifs et algorithmiques]
  $`G \typed t : T$ \ssi{} il existe $U$ tel que $`G \typea t : U$ et $U \suba T$.
\end{corrolary}

On a maintenant un système raffiné dérivant les même jugements (à
coercion près) que le système déclaratif. On veut en extraire un
algorithme de typage. Pour cela on doit pouvoir résoudre deux problèmes:
\begin{itemize}
\item\textbf{Vérification de type.} On donne $`G$,$t$ et $T$ et l'on doit
  décider si $`G \typea t : T$ ;
\item\textbf{Inférence de type.} On donne $`G$,$t$ et l'on doit trouver $T$ tel
  que $`G \typea t : T$ si c'est dérivable, sinon on échoue.
\end{itemize}
En pratique, la vérification a besoin de l'inférence puisque lorsqu'on
vérifie une application $f u : T$ on doit inférer le type de $f$.
On montre donc les théorêmes suivants:

\begin{theorem}[Décidabilité de l'inférence dans le système algorithmique]
  Le problème d'inférence $`G \typea t : ?$ est décidable.
\end{theorem}

\begin{proof}
  Il suffit d'observer que les règles de typage sont dirigées par la
  syntaxe du deuxième argument et permettent donc d'inférer un type pour
  tout terme. En lisant les prémisses de chaque règle de gauche à
  droite, on voit que l'inférence est décidable.
\end{proof}

\begin{theorem}[Décidabilité de $\typea$]
  La relation de typage $`G \typea t : T$ est décidable.
\end{theorem}
\begin{proof}
  Direct. On utilise le théorême précédent pour le cas de l'application.
\end{proof}

%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "subset-typing"
%%% LaTeX-command: "TEXINPUTS=\"style:$TEXINPUTS\" latex"
%%% End: 
