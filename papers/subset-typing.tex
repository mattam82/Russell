\documentclass[a4paper,11pt]{article}
\usepackage[francais]{babel} 
\usepackage[latin1]{inputenc}  %% les accents dans le fichier.tex
\usepackage[T1]{fontenc}       %% Pour la c\'{e}sure des mots accentu\'{e}s
\usepackage{indentfirst}
\usepackage{a4}
\usepackage[dvips]{graphicx}
\usepackage{coqdoc}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{amsfonts}
\usepackage{array}
\usepackage{myabbrevs}
\usepackage{bnf}
\usepackage{bussproofs}
\usepackage{hyperref}
%\usepackage{concmath}
\usepackage{cmbright}
\usepackage{fancyhdr}


\def\infvspace{3em}
% This is the "centered" symbol
\def\fCenter{~{\mbox{$\vdash$}}}
\def\seq{\fCenter}
% Optional to turn on the short abbreviations
\EnableBpAbbreviations

\newtheorem{lemma}{Lemme}[section]
\newtheorem{theo}[lemma]{Théorême}
\newtheorem{prop}[lemma]{Proposition}

\newcommand{\src}[1]{\texttt{#1}}
\newcommand{\srcm}[1]{\text{\texttt{#1}}}
%\newcommand{\Set}{\ensuremath{\text{\texttt{Set}}}}
\newcommand{\Prop}{\ensuremath{\text{\texttt{Prop}}}}

\newcommand{\rname}[1]{{\sc #1}}
\newcommand{\rulelabel}[1]{{\bf {\sc (#1)}}}
\newcommand{\UR}[2]{\RightLabel{\rulelabel{#1}}\UIC{#2}}
\newcommand{\URL}[2]{\LeftLabel{\rulelabel{#1}}\UIC{#2}}

\newcommand{\UAX}[4]{\AXC{#2}\LeftLabel{\rulelabel{#1}}\RightLabel{#4}\UIC{#3}}

\newcommand{\BAX}[5]{\AXC{#2}\AXC{#3}
  \LeftLabel{\rulelabel{#1}}\RightLabel{#5}\BIC{#4}}

\newcommand{\TAX}[6]{\AXC{#2}\AXC{#3}\AXC{#4}
  \LeftLabel{\rulelabel{#1}}\RightLabel{#6}\TIC{#5}}

\newcommand{\BR}[2]{\RightLabel{\rulelabel{#1}}\BIC{#2}}
\newcommand{\BRL}[2]{\LeftLabel{\rulelabel{#1}}\BIC{#2}}

\newcommand{\letml}{\textbf{let}~}
\newcommand{\inml}{~\textbf{in}~}

\newcommand{\eqbi}{`=_{\beta\iota}}

\def\judgewf{~{\mbox{$\vdash_{wf}$}}~}
\def\judgetype{~{\mbox{$\vdash$}}~}
\def\judgesub{~{\mbox{$\vdash_{``<=}$}}~}

\newcommand{\elt}[4]{\text{elt}~#1~#2~#3~#4}
\renewcommand{\subset}[3]{\{ #1 : #2 `| #3~#1 \}}

\def\thetitle{Sous-typage par prédicats en Coq}

\pagestyle{fancy}
\fancyhead[RO,LE]{\thetitle}
\fancyfoot[C]{\thepage}
%\renewcommand{\headrulewidth}{0pt}

\title{\thetitle}

\author{Matthieu Sozeau}

\date{\today}

\begin{document}

\maketitle

\begin{abstract}
  blabla 
\end{abstract}

\def\WfAtomRule{\rname{Wf-Atom}}
\def\WfVarRule{\rname{Wf-Var}}
\def\PropSetRule{\rname{PropSet}}
\def\AbsRule{\rname{Abs}}
\def\VarRule{\rname{Var}}
\def\ProdRule{\rname{Prod}}
\def\SubsetRule{\rname{Subset}}
\def\AppRule{\rname{App}}
  
\begin{figure}[h]
  \begin{center}
    \def\fCenter{\judgewf}
    \UAX{Wf-Atom}{}{$\seq []$}{} \DisplayProof
    \UAX{Wf-Var}{$`G \judgetype A : s$}{$\seq `G, x : A$}
    {$s `: \{ Set, Prop, Type \}$} \DisplayProof
    \vspace{\infvspace}
    \def\fCenter{\judgetype}
    \UAX{PropSet}{$\judgewf `G$}{$`G \seq s : Type$}
    {$s `: \{ Prop, Set \}$} \DisplayProof
    \BAX{Var}{$\judgewf `G$}{$x : A `: `G$}{$`G \seq x : A$}{} \DisplayProof
    \vspace{\infvspace}
    \TAX{Abs}{$`G \seq T : s1$}{$`G, x : T \seq M : U$}
    {$`G, x : T \seq U : s2$}
    {$`G \seq \lambda x : T. M : \Pi x : T.U$}
    {$s1, s2 `: \text{{\sc Sort}}$} \DisplayProof
    \vspace{\infvspace}
    \BAX{Prod}{$`G \seq T : s1$}{$`G, x : T \seq U : s2$}
    {$`G \seq \Pi x : T.U : s2$}
    {$s1, s2 `: \text{{\sc Sort}}$} \DisplayProof
    
    \vspace{\infvspace}
    \TAX{Subset}{$`G \seq f : \Pi x : U. Prop$}
    {$`G \seq x : U$}{$`G \seq p : P~x$}
    {$`G \seq \elt{U}{f}{x}{p} : \{ x : U `| P~x \}$}{$$} \DisplayProof
    
    \vspace{\infvspace}

    \TAX{App}
    {$`G \seq u : U$}
    {$`G \seq f : \Pi x : V. W$}
    {$`G \judgesub u : U ``<= V "~>" p$}
    {$`G \seq (f u) "~>" (f p) : W [ p / x ]$}
    {$$} \DisplayProof

  \end{center}
  \label{typing-rules}
  \caption{Typage du Calcul des Constructions avec sous-types prédicats}
\end{figure}

\def\SubConvRule{\rname{Sub-Conv}}
\def\SubProdRule{\rname{Sub-Prod}}
\def\SubSigmaRule{\rname{Sub-Sigma}}
\def\SubLeftRule{\rname{Sub-Left}}
\def\SubRightRule{\rname{Sub-Right}}

\begin{figure}[h]
  \begin{center}
    \def\fCenter{\judgesub}
    
    \BAX{Sub-Conv}
    {$`G \judgetype x : T$}
    {$T \eqbi U$}
    {$`G \seq x : T ``<= U "~>" x$}
    {} 
    \DisplayProof
    \vspace{\infvspace}

    \BAX{Sub-Prod}
    {$`G \seq x : U "<|-|>" T "~>" p$}
    {$`G, x : T \seq v : V ``<= W[x/y] "~>" q$}
    {$`G \seq \lambda x : T. v : \Pi x : T.V ``<= \Pi y : U.W "~>" 
      \lambda y : U. q[p/y]$}
    {}
    \DisplayProof
    
    \vspace{\infvspace}
    \BAX{Sub-Sigma}
    {$`G \seq x : T ``<= U "~>" p$}
    {$`G \seq v : V ``<= W[p/y] "~>" q$}
    {$`G \seq (x, v) : \Sigma x : T. V ``<= \Sigma y : U. W "~>"
      (p, q)$}
    {}
    \DisplayProof

    \vspace{\infvspace}
    \BAX{Sub-Left}
    {$`G \judgetype q : P~p$}
    {$`G, q : P~p \seq p : U ``<= V "~>" t$}
    {$`G \seq p : \subset{x}{U}{P} ``<= V "~>" t$}
    {}
    \DisplayProof

    \vspace{\infvspace}
    \BAX{Sub-Right}
    {$`G \seq p : A ``<= U "~>" p'$}
    {$`G \judgetype h : P~p'$}
    {$`G \seq p : A ``<= \subset{x}{U}{P} "~>" \elt{U}{P}{p'}{h}$}
    {$A$ atomique}
    \DisplayProof
    
  \end{center}
  \label{subtyping-rules}
  \caption{Sous-typage}
\end{figure}

\begin{figure}[h]
  \begin{center}
    \begin{tabular}{ccc}
      atom & $"=>"$ & atom \\
      $\subset{x}{`t}{P}$ & $"=>"$ & $\mu~`t$ \\
      $\Pi x : `t. `t'$ & $"=>"$ & $\Pi x : `t. \mu~`t'$ \\
      $\Sigma x : `t. `t'$ & $"=>"$ & $\Sigma x : \mu~`t. (\mu~`t') `/
      ((\pi~`t) x)$ 
    \end{tabular}    
  \end{center}
  \label{mu-def}
  \caption{$\mu$: Supertypes maximaux}
\end{figure}

\begin{figure}[h]
  \begin{center}
    \begin{tabular}{ccc}
      $s `: \text{atom}$ & $"=>"$ & $\lambda x : s. True$ \\
      $\subset{x}{`t}{P}$ & $"=>"$ & $\lambda x : \mu~`t. ((\pi~`t) x)
      `^ P[x/y]$ \\
      $\Pi x : `t. `t'$ & $"=>"$ & $\lambda x : (\Pi x : `t. \mu~`t'). 
      `A y : A, ((\pi~`t') (x~y))$ \\
      $\Sigma x : `t, `t'$ & $"=>"$ & $\lambda x : 
      (\Sigma x : \mu~`t, (\mu~`t') `/ ((\pi~`t) x)). 
      \letml (a, b) = x \inml ((\pi~`t) a) `^ ((\pi~`t') b)[a/y]$ 
    \end{tabular}
  \end{center}
  \label{pi-def}
  \caption{$\pi$: Collection des contraintes}
\end{figure}

\clearpage

\begin{lemma}[Préservation de l'équivalence par $\mu$]
  \label{mu-equiv-preserve}
  Si $U \eqbi V$ alors $\mu~U \eqbi \mu~V$.
\end{lemma}

\begin{proof}
  Par induction sur $(U, V)$ : si $U `= \subset{x}{A}{P}$, 
  par hypothèse, $V \eqbi \subset{x}{A'}{P'}$ avec $A \eqbi A'$ et $P
  \eqbi P'$. Par induction $A \eqbi A' "=>" \mu~A \eqbi \mu~A'$. Sinon,
  $U = \mu~U$ et $V = \mu~V$.
\end{proof}

\begin{prop}[Equivalence des supertypes maximaux]
  Si $U ``<= V$ alors $\pi~U~u \mu~U "->" \mu~V$.
\end{prop}
\begin{proof}
  Par induction sur la dérivation de typage:

  \begin{description}
  \item[\SubConvRule:] $U \eqbi V$, donc par le lemme
    \ref{mu-equiv-preserve}, $\mu~U \eqbi \mu~V$.
    
  \item[\SubProdRule:]
    
  \item[\SubSigmaRule:] Par induction, $\mu~T \eqbi \mu~U$ et     
    $\mu~V \eqbi \mu~W[p/y]$. Donc 
    \begin{eqnarray*}
      \mu~\Sigma x : T.V & = & \Sigma x : \mu~T. \mu~V `/ ((\pi T) x) \\
      & \eqbi & \Sigma x : \mu~U. \mu~W[p/y] `/ ((\pi T) x) \\
      & = & \mu~\Sigma x : U. W[p/y]
    \end{eqnarray*}
    
  \item[\SubLeftRule:]
    
  \item[\SubRightRule:]    
  \end{description}
  
\end{proof}


\renewcommand{\thefootnote}{}
\footnotetext{Ce rapport a été préparé sous \LaTeX~avec la fonte 
  \texttt{Concrete Math}}

\end{document}
