\def\iG{\ipG{`G}}
\subsection{Propriétés}
On veut montrer que si l'on a un jugement valide dans notre système
algorithmique, alors son image par l'interprétation est un jugement
valide de \CCI{}. On rappelle que \CCI{} est équivalent au premier
calcul présenté où la règle de coercion est remplacée par la règle de conversion.

\typenvi
\subsubsection{Remarques sur l'interprétation}
\begin{itemize}
\item[{\bf Déterminisme}] L'interprétation est déterministe par rapport à la
  forme des termes. On peut en déduire que
  si $`G \typea x : T$ et $`G \typea \Sigma x : T.U : s$ alors 
  si $\ipt{T}{\ipG{`G}} = T'$ on a $\ipt{\Sigma x : T.U}{\ipG{`G}} =
  \Sigma x : T'. U'$.  
  
\item[{\bf Conservation de la structure}] On voit très clairement que notre
  interprétation est un homomorphisme module les coercions, 
  c'est à dire qu'elle préserve globallement la structure des termes et
  des types.

\item[{\bf Consevation du typage}] Notre interprétation transforme un terme
  bien typé dans le système algorithmique en un terme bien typé dans
  \CCI{}. Ce résultat va découler du fait que l'on reconstruit implicitement
  la dérivation de typage du système algorithmique dans notre
  interprétation en ajoutant les coercions nécessaires pour être bien
  typé dans \CCI{}.
\end{itemize}

\subsubsection{Correction}
On veut montrer le théorème suivant: si $`G \typea t : T$ alors $\iG
\typec \ipt{t}{\iG} : \ipt{T}{\iG}$. Nous n'avons pas encore trouvé de
preuve de ce résultat. En effet le jugement de coercion rend la preuve
 très difficile à cause de son caractère
non local. Pour mieux comprendre ce problème, considérons l'exemple
suivant:

\paragraph{Exemple}
Dans le système algorithmique, on peut très bien dériver
$\Pi n : \nat. \sref{list}~n \suba \Pi n :
\mysubset{x}{\nat}{P}.\listml~n$ puisque $\mysubset{x}{\nat}{P} \suba
\nat$ et $\listml~n \eqbi \listml~n$.
Si l'on réécrit vers \CCI{}, on n'aura plus les même types
de départ pour dériver le jugement puisqu'on part de types \Coq~valides.
Ici, une coercion a été insérée dans le second type:
$`G' \typec c : \Pi n : \nat. \listml~n \subi \Pi n :
\mysubset{x}{\nat}{P}.\listml~(\pi_1~n)$. Seulement, et c'est là la
preuve que l'intuition de la coercion par prédicats est bonne, on peut
dériver ce jugement:

\begin{prooftree}
  \AXC{$\nat \eqbi \nat$}
  \UIC{$`G' \typec \lambda x.x : \nat \subi \nat$}
  \UIC{$`G' \typec (\lambda x.x) `o \pi_1 : \mysubset{x}{\nat}{P} \subi \nat$}
  \AXC{$(\listml~n)[\pi_1~n/n] \eqbi \listml~(\pi_1~n)$}
  \UIC{$`G, n : \mysubset{x}{\nat}{P} \typec (\lambda x.x) :
    (\listml~n)[\pi_1~n/n] \subi \listml~(\pi_1~n)$}
  \BIC{$`G' \typec \lambda f.\lambda x.(\lambda x.x)~(f~(\pi_1~x)) : 
    \Pi n : \nat. \listml~n \subi 
    \Pi n : \mysubset{x}{\nat}{P}.\listml~(\pi_1~n)$}
\end{prooftree}

\paragraph{Coercion}
On conserve les propriétés suivantes sur la coercion:

\begin{lemma}[Transitivité de la coercion]
  \label{subi-trans}
  S'il existe $c_1, c_2$ tels que $`G \typec c_1 : A \subi B$ et $`G \typec c_2 : B \subi C$
  alors $`E!c, `G \typec c : A \subi C$ et $c = c_2 `o c_1$.
\end{lemma}
\begin{proof}
  \TODO{}
\end{proof}


\begin{lemma}[Symétrie de la coercion]
  \label{subi-sym}
  S'il existe $c$ tel que $`G \typec c : A \subi B$
  alors $`E!c^{-1}, `G \typec c^{-1} : B \subi A$ et $c^{-1} `o c =
  \sref{id} = c `o c^{-1}$.
\end{lemma}
\begin{proof}
  \TODO{}
\end{proof}


\paragraph{Substitutivité}
\setboolean{displayLabels}{false}
Le lemme qui pose problème est la substitutivité de l'interprétation.
On l'énonce de la façon suivante:

\begin{lemma}[$\mu$ et interprétation]
  \label{mu-interp}
  Si $\mualgo(T) = V$ alors soit $(\pi, V') = \muimpl(\ipt{T}{\iG})$. On
  a $V' = \ipt{\mualgo(T)}{\iG}$.
\end{lemma}

\begin{proof}
  Par induction sur la forme de $T$.
  \begin{induction}
  \item[-] Si $T `= \mysubset{x}{U}{P}$ alors $\mualgo(T) = \mualgo(U)$
    et $\ipt{T}{\iG} = \mysubset{x}{\ipt{U}{\iG}}{\ipt{P}{\ipG{`G, x :
          T}}}$ donc $\muimpl(\ipt{T}{\iG}) = \muimpl(\ipt{U}{\iG}) =
    (\pi, U')$.
    Par induction, $U' = \ipt{\mualgo(U)}{\iG}$ donc
    $\muimpl(\ipt{T}{\iG}) = (\pi `o \pi_1, \ipt{\mualgo(T)}{\iG})$
    et la propriété est vérifiée.
    
  \item[-] Sinon, $\mualgo(T) = T$, donc $\muimpl(\ipt{T}{\iG}) =
    \muimpl(\ipt{\mualgo(T)}{\iG})$.
    L'interprétation est un homomorphisme, donc si $T$ n'est pas un type
    sous-ensemble, $\ipt{T}{\iG}$ ne peut en être un, on en déduit donc
    $\muimpl(\ipt{\mualgo(T)}{\iG}) = (\sref{id},
    \ipt{\mualgo(T)}{\iG})$, soit le résultat désiré.
  \end{induction}
\end{proof}

\begin{lemma}[Coercion de sortes]
  \label{subi-sorts}
  Si $s \subi T$ ou $T \subi s$ où $s `: \setproptype$ alors $T = s$.
\end{lemma}

\begin{proof}
  \TODO{}
\end{proof}


\def\iu{\ipt{u}{\iG}}
\def\tux{\ipt{t[u/x]}{\ipG{`G, `D[u/x]}}}
\def\cux{[c~\ipt{u}{\iG}/x]}
\def\tcux{\ipt{t}{\ipG{`G, x : V, `D}}[c~\ipt{u}{\iG}/x]}
\def\GD{`G, x : V, `D}
\def\Gr{`G, `D[u/x]}
\def\iGD{\ipG{`G, x : V, `D}}
\def\iGr{\ipG{`G, `D[u/x]}}

\begin{lemma}[Substitution et coercion]
  \[\left.\begin{array}{l}
      \iG \typec \ipt{u}{\iG} : \ipT{u}{\iG} \\
      \iG \typec c : \ipT{u}{\iG} \subi \ipt{V}{\iG} \\
      `G, x : V, `D \typea t : T
%      `G, x : V, `D \typea t : T "=>" \ipT{t}{\iGD} = \ipt{T}{\iGD}      
%      \ipG{`G, x : V, `D} \typec \ipt{t}{\ipG{`G, x : V, `D}} :
%      \ipt{T}{\ipG{`G, x : V, `D}}
  \end{array}
\right\} "=>"
\begin{array}{l}
  `E `a,
  \ipG{`G, `D[u/x]} \typec `a : \ipT{t[u/x]}{\ipG{`G, `D[u/x]}}
  \subi 
  \ipt{T}{\ipG{`G, x : V, `D}}[c~\ipt{u}{\iG}/x] \\
  \begin{array}{lcl}
    `a~\ipt{t[u/x]}{\ipG{`G, `D[u/x]}} & 
    \eqbi & \ipt{t}{\ipG{`G, x : V, `D}}[c~\ipt{u}{\iG}/x] \\
    \ipT{t}{\iGD} & = & \ipt{T}{\iGD}
    % \ipt{T[u/x]}{`G, `D[u/x]} & \eqbi & \ipt{T}{\ipG{`G, x: V, `D}}[c~\ipt{u}{\iG}/x]
  \end{array}
\end{array}
\]
\end{lemma}


\begin{proof}
  Par induction sur la dérivation de $`G, x : V \typea t : T$.
  Soit $`G' = \GD$ et $`G_{`r} = \Gr$.

  On va utiliser le lemme suivant à plusieurs reprises.

  \begin{lemma}[Coercions et subsitution dans les types]
    \label{coerce-subst-type}
    Pour toute sous-dérivation de $\GD \typea t : T$ de la forme
    $\GD \typec V : s$ où $s `: \setproptype$, on a la propriété suivante:
    \[\ipt{V[u/x]}{\iGr} \eqbi \ipt{V}{\iGD}\cux\]
  \end{lemma}
  \begin{proof}
    En effet, par induction $`E`a, \iGr \typec `a : \ipT{V[u/x]}{\iGr}
    \suba \ipt{s}{\iGD}\cux = s$. On sait que $`a$ est une coercion vers
    une sorte, c'est donc l'identité (lemme \ref{subi-sorts}). Donc
    \begin{eqnarray*}
      \ipt{V}{\iGD}\cux & \eqbi & (\lambda x.x)~\ipt{V[u/x]}{\iGr} \\
      & \eqbi & \ipt{V[u/x]}{\iGr}
    \end{eqnarray*}
  \end{proof}
  
  De même on utilisera le lemme suivant à plusieurs reprises:
  \begin{lemma}[Interprétation de la coercion algorithmique]
    \label{interp-coercion}
    Si l'on peut appliquer l'hypothèse d'induction sur $`G \typea A, B :
    s$ et qu'on a $A \suba B$ alors
    \[`E!c: \ipt{A}{\iG} \suba \ipt{B}{\iG}\].
  \end{lemma}
  
  \begin{proof}
    Par induction sur la dérivation de $A \suba B$:
    \begin{induction}
      \case{SubConv}
      On a $A \eqbi B$. 
      On va montrer que si $A "->"_{\beta} A'$ alors
      $\ipt{A}{\iG} "->"^{*}_{\beta} \ipt{A'}{\iG}$
      
      \begin{itemize}
      \item Si $A `= (\lambda y : T.v)~u$ et $A' = v[u/y]$ alors
        par définition de l'interprétation, 
        \[\ipt{A}{\iG} `= 
        (\lambda y : \ipt{T}{\iG}.\ipt{v}{\ipG{`G, y : T}})
        (c~\ipt{u}{\iG})\]
        où $c : \ipT{u}{\iG} \subi \ipt{T}{\iG}$.
        $c$ est bien dérivable car par induction, $\ipT{u}{\iG} =
        \ipt{U}{\iG}$ et l'on peut appliquer l'hypothèse d'induction
        courante sur la dérivation de $`G \typea T : s$. On obtient ce
        jugement par inversion de $`G \typea (\lambda x : T.v)~u : s$.
        En effet pour que cette application soit bien typée on doit
        avoir $`G \typea T, U : s$.  
        
        D'autre part, $\ipt{A'}{\iG} = \ipt{v[u/y]}{\iG}$.
        Or par inversion du jugement $`G \typec (\lambda y :
        T.v)~u : s$, on a $`G, y : T \typea v : s$.
        On peut appliquer l'hypothèse d'induction pour obtenir:
        \[\ipt{v[u/y]}{\iG} \eqbi \ipt{v}{\ipG{`G, y : T}}
        [c~\ipt{u}{\iG}/y]\]
        Comme $\ipt{A}{\iG}$ se réduit vers $\ipt{v[u/y]}{\iG}$ la
        propriété est bien montrée.
        
      \item Si $A `= (\lambda y : V.v)~u$ et $A' = 
        (\lambda y : V.v')~u$ alors $v "->"_{\beta} v'$.
        Direct par induction ($\ipt{v}{\iG} "->"^{*}_{\beta}
        \ipt{v'}{\iG}$).

      \item Sinon il n'y a que des réductions internes possibles, 
        et la propriété est vraie par induction
      \end{itemize}

      On peut faire le même raisonnement pour $B$,
      on en déduit que si $A \eqbi B$ alors $\ipt{A}{\iG} \eqbi
      \ipt{B}{\iG}$.
      
      \case{SubHnf}
      On a $\hnf{A}~\suba~\hnf{B}$ et par induction
      $`E!c.\iG \typec c : \ipt{\hnf{A}}{\iG} \subi 
      \ipt{\hnf{B}}{\iG}$. On peut donc appliquer \irule{SubHnf}
      dans le système de réecriture des coercions pour obtenir
      le résultat désiré.

      \case{SubProd}
      \def\iGA{`G, y : A}
      Soit $A `= \Pi y : C.D$ et $B `= \Pi y : A.F$.
      Par induction \[`E!c_1, \iG \typec c_1 : \ipt{A}{\iG} \subi
      \ipt{C}{\iG}\] et \[`E!c_2, \ipG{\iGA} \typec c_2
      : \ipt{D}{\iGA} \subi \ipt{F}{\iGA}\]
      On a aussi \[\ipt{D}{\ipG{\iGA}} = 
      \ipt{D}{\ipG{`G, y : C}}[c_1~y/y]\]
      par induction sur $`G, y : C \typea D : s$.
      On a donc \[`E!c_2, \ipG{\iGA} \typec c_2
      : \ipt{D}{\ipG{`G, x : V, `D, y : C}}[c_1~y/y] \subi
      \ipt{F}{\iGA}\] 
      et on peut appliquer \irule{SubProd}.
      Les autres cas se montrent de la même manière.
      
    \end{induction}
    
    
  \end{proof}
  
  On va maintenant procéder à l'induction.

  \begin{induction}
    \case{Var} 
    On a:
    \begin{prooftree}
      \BAX{Var}
      {$\wf \GD$}
      {$y : T `: \GD$}
      {$\GD \seq y : T$}
      {}
    \end{prooftree}    

    \begin{itemize}
    \item Si $x "/=" y$ alors
      par inversion du jugement de bonne formation, on a:
      $\GD \typea T : s$ pour $s `: \setproptype$.
      On peut appliquer le lemme \ref{coerce-subst-type} pour obtenir:
      \[\ipt{T[u/x]}{\iGr} \eqbi \ipt{T}{\iGD}\cux\] 

      Or \[\ipT{t[u/x]}{\iGr} = \ipT{y}{\iGr} = \iGr(y) = \ipt{T[u/x]}{\iGr}\]
            
      Le jugement de coercion dérive donc l'identité par
      \irule{SubConv}, et l'on a bien:
      \begin{eqnarray*}     
        `a~\ipt{y[u/x]}{\iGr} & = & `a~y \\
        & = & (\lambda x.x)~y \\
        & \eqbi & y \\
        & = & \ipt{y}{\iGD}\cux
      \end{eqnarray*}
      
      
    \item Sinon, $T = V$, $x `; V$, $t[u/x] = u$.
      Soit $`a = c$.
      On sait que \[\ipT{x[u/x]}{\iG} = \ipT{u}{\iG} \mbox{ et }
      \ipt{V}{\iGD}\cux = \ipt{V}{\iGD}\]
      $c$ est donc du bon type, et il suffit d'affaiblir le jugement
      $\iG \typec c : \ipT{u}{\iG} \subi \ipt{V}{\iG}$ pour obtenir la
      dérivation voulue.
      On peut vérifier:
      \begin{eqnarray*}
        c~\ipt{x[u/x]}{\iGr} & = & c~\ipt{u}{\iGr} \\
        & = & \ipt{x}{\iGD}\cux
      \end{eqnarray*}
      
      On utilise la propriété: 
      $\ipt{u}{\ipG{`G}} = \ipt{u}{\ipG{`G, `D}}$ pour toute extension
      $`D$ bien formée (ne masquant pas les variable de $`G$).

      La seconde propriété est directe par définition de l'interprétation.
    \end{itemize}
    
    \case{App}\quad
    \typenva
    \begin{prooftree}
      \TAX{App}
      {$`G \seq f : F \quad \mualgo(F) = \Pi y : A. B$}
      {$`G \seq e : E \quad `G \seq E, A : s$}
      {$E \sub A $}
      {$`G \seq (f~e) : B [ e / y ]$}
      {}
    \end{prooftree}
    \typenvi
    
    \def\iGx{\ipG{`G, x : V}}
    
    Par induction:
    \begin{eqnarray*}
      `E `a_f, \iGD \typec `a_f & : & \ipT{f[u/x]}{\iG} \subi
      \ipt{F}{\iGD}\cux \\
      `a_f~\ipt{f[u/x]}{\iGr} & \eqbi & \ipt{f}{\iGD}\cux \\
      \text{ et } & & \\
      `E `a_e, \iGD \typec `a_e & : & \ipT{e[u/x]}{\iG} \subi
      \ipt{E}{\iGD}\cux \\
      `a_e~\ipt{e[u/x]}{\iGr} & \eqbi & \ipt{e}{\iGD}\cux
    \end{eqnarray*}
    
    \def\afe{`a}
    On veut montrer qu'il existe une coercion $\afe$ telle que:
    \begin{eqnarray*}
      \iGD \typec \afe & : & \ipT{(f~e)[u/x]}{\iG} \subi
      \ipt{B[e/y]}{\iGD}\cux \\
      \afe~\ipt{(f~e)[u/x]}{\iGr} & \eqbi & \ipt{f~e}{\iGD}\cux 
%     \ipt{B[e/y][u/x]}{\iGr} & \eqbi & \ipt{B[e/y]}{\iGD}\cux
    \end{eqnarray*}

    Par définition de la substitution et de l'interprétation, 
    \def\myipt#1{\lbag#1\rbag}
    \begin{eqnarray*}
      \ip{(f~e)}{\iGD}
      & = & (((\pi~\ipt{f}{\iGD})~(c'~\ipt{e}{\iGD})),
      \ipt{B}{\iGD}[c'~\ipt{e}{\iGD}/y]) \\
      & = & ((\pi~\myipt{f})~(c'~\myipt{e})),
      \myipt{B}[c'~\myipt{e}/y] \\
      \text{ où } & & \\
      \myipt{x} & = & \ipt{x}{\iGD} \\
      (\pi, \ipt{\Pi y : A.B}{\iGD}) & = & \muimpl~(\ipT{f}{\iGD}) \\
      c' & = & \sref{coerce}~\ipT{e}{\iGD}~\ipt{A}{\iGD}.
    \end{eqnarray*}
    
    On doit montrer que $c'$ est bien dérivable.
    Par induction on a $\ipT{e}{\iGD} = \ipt{E}{\iGD}$ et
    par hypothèse $E \suba A$. On peut appliquer le lemme
    \ref{interp-coercion} pour obtenir:    
    \[`E!c', \iGD \typec c' : \ipt{E}{\iGD} \subi \ipt{A}{\iGD}\]
        
    On peut substituer pour obtenir:
    \[c'\cux : \ipt{E}{\iGD}\cux \subi \ipt{A}{\iGD}\cux\]

    On a donc: 
    \[\ipt{(f~e)}{\iGD}\cux =
    ((\pi~\ipt{f}{\iGD}\cux)~(c'\cux~\ipt{e}{\iGD}\cux))\]
    et
    \[\ipT{(f~e)}{\iGD}\cux =
    \ipt{B}{\iGD}[c'~\ipt{e}{\iGD}/y]\cux\]

    D'autre part on a:
    \begin{eqnarray*}
      \ip{(f~e)[u/x]}{\iGr}
      & = & (\ipt{f[u/x]~e[u/x]}{\iG}, B'[c''~e'/y]) \\
      & = & ((\pi'~f')~(c''~e'),~B'[c''~e'/y]) \\
      \text{ où } & & \\
      (f', T') & = & \ip{f[u/x]}{\iGr} \\
      (\pi', \Pi y : A'.B') & = & \muimpl~(T') \\
      (e', E') & = & \ip{e[u/x]}{\iGr} \\
      c'' & = & \sref{coerce}~E'~A'.
    \end{eqnarray*}

    A partir de $\mualgo(F) = \Pi y : A.B$ on peut déduire que 
    $\mualgo(F[u/x]) = \Pi y : A[u/x].B[u/x]$ par substitutivité de
    $\mualgo$ (lemme \ref{substitutive-mu}) et par le lemme
    \ref{mu-interp}~on obtient \[\muimpl(\ipt{F[u/x]}{\iGr}) = 
    (\pi, \ipt{\mualgo(F[u/x])}{\iGr}) = 
    (\pi, \ipt{\Pi y : A[u/x].B[u/x]}{\iGr})\]


    On doit aussi montrer que $c''$ est bien dérivable.
    Ici, $E' = \ipT{e[u/x]}{\iGr}$ et $A' = \ipt{A[u/x]}{\iGr}$, et on a
    l'hypothèse $E \suba A$.    
    Or par substitutivité de la coercion dans le système algorithmique,
    on a $E[u/x] \suba A[u/x]$. 
    On peut appliquer le lemme \ref{interp-coercion} pour déduire:
    \[`E!d, \iGr \typec d : \ipt{E[u/x]}{\iGr} \subi
    \ipt{A[u/x]}{\iGr}\]
    
    Par application du lemme \ref{coerce-subst-type} sur la dérivation
    de $\GD \typea E : s$ on peut déduire que \[\ipt{E[u/x]}{\iGr} =
    \ipt{E}{\iGD}\cux\] On peut donc composer les coercions pour
    obtenir:
    \[c'' = d `o `a_e : \ipT {e[u/x]}{\iGr} \subi A'\]
    


%     De même, à partir de $E \suba A$ on peut déduire une coercion \[c :
%     \ipt{E[u/x]}{\iGr} \subi \ipt{A[u/x]}{\iGr}\]
    
    Par inversion de $\GD \typea f : F$ on a $\GD \typea F : s$.
    On peut appliquer le lemme \ref{coerce-subst-type} pour obtenir:
    \[\ipt{F[u/x]}{\iGr} = \ipt{F}{\iGD}\cux\]
    
    On a donc les coercions suivantes pour la fonction $f$ et l'argument
    $e$: 
    \[
    \xymatrix{
      \ipt{F}{\iGD}\cux\ar[rr]_{\pi} & & 
      \ipt{\Pi y : A.B}{\iGD}\cux \\
      \ipT{f[u/x]}{\iGr}\ar[u]^{`a_f}\ar[rr]^{\pi'} & &
      {\Pi y : A'.B'}\ar@{-->}[u]^{c_f}}
    \]
    \[
    \xymatrix{
      \ipt{E}{\iGD}\cux\ar[rr]_{c'} & & 
      \ipt{A}{\iGr}\cux\ar@{-->}[d]^{c_e} \\
      \ipT{e[u/x]}{\iGr}\ar[u]^{`a_e}
      \ar[rr]^{c''} & & A'}
    \]
    
    On veut montrer que les diagrammes commutent et que $c_f, c_e$ sont
    uniquement déterminés. 
    Pour cela on va tout d'abord
    montrer qu'il existe une coercion unique \[c_f : \Pi y : A'.B' \subi 
    \ipt{\Pi z : A.B}{\iGD}\cux\] Cela est vrai par transitivité
    et symmétrie de la coercion (lemmes \ref{subi-trans} et \ref{subi-sym}).  
    On en déduit qu'il existe $c_1, c_2$
    tels que $c_f = \lambda f.\lambda x. c_2~(f~(c_1~x))$ avec
    \[
    \xymatrix{
      \ipt{A}{\iGD}\cux\ar[rr]^(0.7){c_1} & & A' & &
      B' \ar[rr]^(0.3){c_2} & & 
      \ipt{B}{\ipG{`G, x : A, `D, y : A}}\cux
    }\]
    
    On peut prendre $c_e = c_1$ et $\afe = c_2$. On a l'équation $c'' = c_1
    `o c' `o `a_e$.
    Alors:
    
    \[\begin{array}{ll}
      \firsteq{\afe~\ipt{(f~e)[u/x]}{\iGr}}
      
      \step{Définition de l'interprétation}
      {=}{\afe~((\pi'~f')~(c''~e'))}
      
      \step{Définitions de $`a$ et $c''$}
      {=}{c_2~((\pi'~f')~((c_1 `o c' `o `a_e)~e'))}
      
      \step{Définition de la composition}
      {=}{c_2~((\pi'~f')~(c_1~(c'~(`a_e~e'))))}

      \step{Définition de $c_f$ ($= \lambda f.\lambda
        x.c_2~(f~(c_1~x))$)}
      {=}{(c_f~(\pi'~f'))~(c'~(`a_e~e'))}

      \step{Commutation du diagramme 1}{=}{(\pi~(`a_f~f'))~(c'~(`a_e~e'))}
      
      \step{Définitions de $`a_f$ et $`a_e$}{=}{(\pi~\ipt{f}{\iGD}\cux)~(c'~\ipt{e}{\iGD}\cux)}

      \step{Définition de l'interprétation}{=}{\ipt{f~e}{\iGD}\cux}
      \vspace{0.2em}
    \end{array}\]
    
    \vspace{1cm}
    On montre la deuxième condition:
    \[\begin{array}{ll}
      \firsteq{\ipT{f~e}{\iGD}}

      \step{Définition de l'interprétation}
      {=}{\ipt{B}{\ipG{\GD, y : A}}[c'~\ipt{e}{\iGD}/y]}
    
      \step{Application du lemme \ref{coerce-subst-type}~à $\GD, y : A \typea B : s$}
      {\eqbi}{\ipT{B[e/y]}{\iGD}}
    \end{array}\]
    
    \TODO{Autres cas}

  \end{induction}
\end{proof}

On peut maintenant montrer notre théorème de correction.

\setboolean{displayLabels}{false}
\begin{theorem}[Correction de l'interprétation]
  \label{correct-interp}
  Si $`G \typea t : T$ alors on a $\iG \typec \ipt{t}{\iG} :
  \ipt{T}{\iG}$.
  Si $\wf `G$ alors $\wf \iG$.
\end{theorem}

\begin{proof}
  Par induction mutuelle sur la dérivation de typage ou de bonne
  formation.

  \begin{induction}
    \case{WfEmpty} Trivial.

    \case{WfVar}
    Par induction $\iG \typec \ipt{A}{\iG} :
    \ipt{s}{\iG}$. Par inversion du jugement de bonne formation
    dans \CCI{}, $\typewf \iG$.
    Or, $\ipt{s}{\iG} = s$ ($s `: \{ \Prop, \Set, \Type \}$), donc 
    on peut appliquer \irule{WfVar} dans \CCI{} pour obtenir:
    $\wf \iG, x : \ipt{A}{\iG}$, soit $\wf \ipG{`G, x : A}$.

    \case{PropSet}
    Direct par induction, $\iG \typec \ipt{s}{\iG} = s :
    \ipt{\Type}{\iG} = \Type$. La deuxième condition est directe
    par définition de l'interprétation.
    
    \case{Var} On a:
    \begin{prooftree}
      \Var
    \end{prooftree}
    Par induction, $\wf \iG$ et par simple inspection de la
    définition de l'interprétation des contextes, si $x : A `: `G$ alors
    $x : \ipt{A}{`D} `: \iG$ pour $`D ``( `G$. Par affaiblissement
    dans \CCI{}, on obtient aisément $\iG \typec x : \ipt{A}{`D}$ 
    à partir de  $\ipG{`D} \typec x : \ipt{A}{\ipG{`D}}$. Or il est clair par
    la définition de l'interprétation que $\ipt{A}{`D} = \ipt{A}{`G}$  
    si $`G$ est une extension de $`D$ puisqu'on utilise l'environnement
    uniquement au moment de typer les variables et
    $\iG(x) = \ipG{`D}(x)$ pour tout $x$ utilisé dans $A$.
    On a donc $\iG \typec x : \ipt{A}{\iG}$.
    La deuxième condition est montrée par $\ipT{x}{`G} = \iG(x) = 
    \ipt{A}{\ipG{`D}} = \ipt{A}{\iG}$.
      
    \case{Prod} On a:
    \begin{prooftree}
      \Prod
    \end{prooftree}
    
    Par induction $\iG \typec \ipt{T}{\iG} : \ipt{s_1}{\iG}
    = s_1$ et $\ipG{`G, x : T} \typec \ipt{U}{\ipG{`G, x : T}} :
    \ipt{s_2}{\ipG{`G, x : T}} = s_2$.
    On déplie l'interprétation pour obtenir:
    $\iG, x : \ipt{T}{\iG} \typec \ipt{U}{\iG{}, x : \ipt{T}{\iG}} :
    s_2$.
    
    Par \irule{Prod} dans \CCI, on obtient:
    $\iG{} \typec \Pi x : \ipt{T}{\iG}. \ipt{U}{\iG{}, x : \ipt{T}{\iG}}
    : s_3$.
    Or $\ipt{\Pi x : T.U}{\iG} = \Pi x : \ipt{T}{\iG}. \ipt{U}{\iG{}, x
      : \ipt{T}{\iG}}$, donc on a bien:
    $\iG \typec \ipt{\Pi x : T.U}{\iG} : s_3 = \ipt{s_3}{\iG}$.
    La seconde condition est directe d'après la définition de $\mathcal{R}$ qui
    est une fonction.

    \case{Abs} On a:
    \begin{prooftree}
      \Abs
    \end{prooftree}
    
    Par induction $\iG \typec \ipt{\Pi x : T.U}{\iG} : \ipt{s}{\iG}$
    et $\ipG{`G, x : T} \typec \ipt{M}{\ipG{`G, x : T}} :
    \ipt{U}{\ipG{`G, x : T}}$.
    On déplie l'interprétation pour obtenir:
    $\iG, x : \ipt{T}{\iG} \typec \ipt{M}{\iG{}, x : \ipt{T}{\iG}} :
    \ipt{U}{\ipG{`G, x : T}}$.
    
    Par \irule{Abs} dans \CCI, on obtient:
    $\iG{} \typec \lambda x : \ipt{T}{\iG}. \ipt{M}{\iG{}, x : \ipt{T}{\iG}}
    : \ipt{\Pi x : T.U}{\iG}$.
    C'est équivalent à:
    $\iG \typec \ipt{\lambda x : T.U}{\iG} : \ipt{\Pi x : T.U}{\iG}$.
    La seconde condition se montre ainsi:
    $\ipT{\lambda x : T.M}{\iG} = \Pi x : \ipt{T}{\iG}. \ipT{M}{\iG, x :
      \ipt{T}{\iG}}$. Or par induction, 
    $\ipT{M}{\iG, x : \ipt{T}{\iG}} = \ipt{U}{\iG, x : \ipt{T}{\iG}}$, donc 
    $\ipT{\lambda x : T.M}{\iG} = \Pi x : \ipt{T}{\iG}. \ipt{U}{\iG, x :
      \ipt{T}{\iG}} = \ipt{\Pi x : T.U}{\iG}$.
    
    \case{App} On a:
    \begin{prooftree}
      \AppA
    \end{prooftree}

    C'est le cas intéressant puisqu'on ajoute ici des coercions.
    Par induction, $\iG{} \typec \ipt{f}{\iG} : \ipt{T}{\iG}$,
    $\iG{} \typec \ipt{u}{\iG} : \ipt{U}{\iG}$,
    $\iG{} \typec \ipt{U}{\iG}, \ipt{V}{\iG} : \ipt{s}{\iG}$.
    
    On procéde par étapes: d'abord la construction d'une fonction
    $\pi \ipt{f}{\iG} : \ipt{\Pi x : V.W}{\iG}$ puis la construction de
    l'argument $c \ipt{u}{\iG} : \ipt{V}{\iG}$. On n'a plus qu'à les
    appliquer pour obtenir le jugement:
    $\iG{} \typec \ipt{f~u}{\iG} : \ipt{W}{\iG, x :
      \ipt{V}{\iG}}[c~u/x]$.
    Par substitutivité de l'interprétation, on a
    $\ipt{W}{\iG, x : \ipt{V}{\iG}}[c~u/x] \eqbi
    \ipt{W[u/x]}{\iG}$ puisque les coercions de sorte à sorte ne peuvent
    être que l'identité. On peut donc déduire:
    $\iG{} \typec \ipt{f~u}{\iG} : \ipt{W[u/x]}{\iG}$ par \irule{Conv}.

    \item[- \irule{Sigma}, \irule{Sum}, \irule{LetSum}, \irule{Subset}:]
      Direct par induction ou un raisonnement similaire à \irule{App}.      
  \end{induction}
\end{proof}


%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "subset-typing"
%%% LaTeX-command: "x=pdf; TEXINPUTS=\"style:figures:\" ${pdfx}latex"
%%% End: 
