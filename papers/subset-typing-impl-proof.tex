\def\iG{`G}
\subsection{Propriétés}
On veut montrer que si l'on a un jugement valide dans notre système
algorithmique, alors son image par l'interprétation est un jugement
valide de \CCI{}. On rappelle que \CCI{} est équivalent au premier
calcul présenté où la règle de coercion est remplacée par la règle de conversion.

\typenvi
\subsubsection{Remarques sur l'interprétation}
\begin{itemize}
\item[{\bf Déterminisme}] L'interprétation est déterministe par rapport à la
  forme des termes. On peut en déduire que
  si $`G \typea x : T$ et $`G \typea \Sigma x : T.U : s$ alors 
  si $\ipt{T}{\ipG{`G}} = T'$ on a $\ipt{\Sigma x : T.U}{\ipG{`G}} =
  \Sigma x : T'. U'$.  
  
\item[{\bf Conservation de la structure}] On voit très clairement que notre
  interprétation est un homomorphisme module les coercions, 
  c'est à dire qu'elle préserve globallement la structure des termes et
  des types.

\item[{\bf Consevation du typage}] Notre interprétation transforme un terme
  bien typé dans le système algorithmique en un terme bien typé dans
  \CCI{}. Ce résultat va découler du fait que l'on reconstruit implicitement
  la dérivation de typage du système algorithmique dans notre
  interprétation en ajoutant les coercions nécessaires pour être bien
  typé dans \CCI{}.
\end{itemize}

\subsubsection{Correction}
On veut montrer le théorème suivant: si $`G \typea t : T$ alors $\iG
\typec \ipt{t}{\iG} : \ipt{T}{\iG}$. Nous n'avons pas encore trouvé de
preuve de ce résultat. En effet le jugement de coercion rend la preuve
 très difficile à cause de son caractère
non local. Pour mieux comprendre ce problème, considérons l'exemple
suivant:

\paragraph{Exemple}
Dans le système algorithmique, on peut très bien dériver
$\Pi n : \nat. \sref{list}~n \suba \Pi n :
\mysubset{x}{\nat}{P}.\listml~n$ puisque $\mysubset{x}{\nat}{P} \suba
\nat$ et $\listml~n \eqbi \listml~n$.
Si l'on réécrit vers \CCI{}, on n'aura plus les même types
de départ pour dériver le jugement puisqu'on part de types \Coq~valides.
Ici, une coercion a été insérée dans le second type:
$`G' \typec c : \Pi n : \nat. \listml~n \subi \Pi n :
\mysubset{x}{\nat}{P}.\listml~(\pi_1~n)$. Seulement, et c'est là la
preuve que l'intuition de la coercion par prédicats est bonne, on peut
dériver ce jugement:

\begin{prooftree}
  \AXC{$\nat \eqbi \nat$}
  \UIC{$`G' \typec \lambda x.x : \nat \subi \nat$}
  \UIC{$`G' \typec (\lambda x.x) `o \pi_1 : \mysubset{x}{\nat}{P} \subi \nat$}
  \AXC{$(\listml~n)[\pi_1~n/n] \eqbi \listml~(\pi_1~n)$}
  \UIC{$`G, n : \mysubset{x}{\nat}{P} \typec (\lambda x.x) :
    (\listml~n)[\pi_1~n/n] \subi \listml~(\pi_1~n)$}
  \BIC{$`G' \typec \lambda f.\lambda x.(\lambda x.x)~(f~(\pi_1~x)) : 
    \Pi n : \nat. \listml~n \subi 
    \Pi n : \mysubset{x}{\nat}{P}.\listml~(\pi_1~n)$}
\end{prooftree}

\paragraph{Coercion}
On conserve les propriétés suivantes sur la coercion:

\begin{lemma}[Transitivité de la coercion]
  \label{subi-trans}
  S'il existe $c_1, c_2$ tels que $`G \typec c_1 : A \subi B$ et $`G \typec c_2 : B \subi C$
  alors $`E!c, `G \typec c : A \subi C$ et $c = c_2 `o c_1$.
\end{lemma}
\begin{proof}
  De la même façon que pour la preuve de transitivité de la
  coercion algorithmique, on élimine la règle \irule{SubTrans}. 
  Comme les règles sont simplement annotés par des termes de coercion et
  que le type dirige toujours la dérivation, la propriété est directe.
\end{proof}


\begin{lemma}[Symétrie de la coercion]
  \label{subi-sym}
  S'il existe $c$ tel que $`G \typec c : A \subi B$
  alors $`E!c^{-1}, `G \typec c^{-1} : B \subi A$ et $c^{-1} `o c \eqbi
  \sref{id}~A$ et $c `o c^{-1} \eqbi \sref{id}~B$, où
  $\sref{id} \coloneqq \lambda X : Set.\lambda x : X. x$.
\end{lemma}
\begin{proof}
  Par induction sur la dérivation de $c$.
  \begin{induction}
    \case{SubConv} Trivial.

    \case{SubHnf} Par induction, il existe $c^{-1} : \hnf{B} \subi
    \hnf{A}$, $c_1$ est donc de type $B \subi A$ par conversion.

    \case{SubProd}
    Par induction on a: $`G \typec c_1^{-1} : T \subi U$ et $`G, x : U \typec c_2^{-1} : W \subi
    V[c_1~x/x]$.
    On peut donc construire la coercion:
    $\lambda f : \Pi x : U.W. \lambda x : T. c_2^{-1}~(f~(c_1^{-1}~x))$
    de type $\Pi x : U.W \subi \Pi x : T.V$ car:
    $f~(c_1^{-1}~x) : W[c_1^{-1}~x/x]$ donc $c_2^{-1}~(f~(c_1^{-1}~x)) : 
    V[c_1~(c_1^{-1}~x)/x]$. Or $c_1 `o c^{-1}_1 \eqbi \sref{id}~T$, donc
    $V[c_1~(c_1^{-1}~x)/x] \eqbi V$.

    On va maintenant montrer les identités (avec des termes à la Curry):

    $\begin{array}{ll}
      \firsteq{(\lambda f.c_2 `o f `o c_1) `o 
        (\lambda f.c_2^{-1} `o f `o c_1^{-1})}
      
      \step{Définition de la composition}
      {\eqbi}{\lambda f.c `o c^{-1}}
      
      \step{Hypothèse d'induction}
      {\eqbi}{\sref{id}~T}
    \end{array}$




    \case{SubSigma}
    De là même façon.

    \case{SubSub}
    Par induction $`G \typec c^{-1} : T \subi U$, on peut donc appliquer
    \irule{SubProof} pour obtenir la coercion:
    $\lambda t : T.\elt{U}{(\lambda x :
      U.P)}{(c^{-1}~t)}{?_{P[c^{-1}~t/x]}}$
    de type : $T \subi \mysubset{x}{U}{P}$.
    
    On a l'équation suivante:

    $\begin{array}{ll}
      \firsteq{c `o \pi_1 `o \lambda t : T.\elt{U}{(\lambda x :
          U.P)}{(c^{-1}~t)}{?_{P[c^{-1}~t/x]}}}
      
      \step{Définition de $\pi_1$}
      {\eqbi}{c `o c^{-1}}
      
      \step{Hypothèse d'induction}
      {\eqbi}{\sref{id}~T}
    \end{array}$

    De même:

    $\begin{array}{ll}
      \firsteq{(\lambda t : T.\elt{U}{(\lambda x :
          U.P)}{(c^{-1}~t)}{?_{P[c^{-1}~t/x]}})
        `o c `o \pi_1}
      
      \step{Définition de la composition}
      {\eqbi}{\lambda t : \mysubset{x}{U}{P}.
        \elt{U}{(\lambda x : U.P)}
        {(c^{-1}~(c~(\pi_1~t)))}{?_{P[c^{-1}~(c~(\pi_1~t))/x]}}}
    
    \step{Hypothèse d'induction}
    {\eqbi}{{\lambda t : \mysubset{x}{U}{P}.
        \elt{U}{(\lambda x : U.P)}{(\pi_1~t)}{?_{P[\pi_1~t/x]}}}}

    \step{Indifférence aux preuves!}
    {\eqbi}{\sref{id}_{\mysubset{x}{U}{P}}}

    \end{array}$

    \case{SubProof}
    C'est le cas dual, ici on a par induction $c^{-1} : U \subi T$.
    On veut construire une coercion de type $\mysubset{x}{U}{P} \subi
    T$.
    On applique donc \irule{SubSub} pour obtenir:
    $c^{-1} `o \pi_1$.
    On a bien:

    $\begin{array}{ll}
      \firsteq{c^{-1} `o \pi_1 `o (\lambda t : T.
        \elt{U}{(\lambda x : U.P)}{(c~t)}{?_{P[c~t/x]}})}
      
      \step{Définition de la composition}
      {\eqbi}{c^{-1} `o (\lambda t : T.
        \pi_1~(\elt{U}{(\lambda x : U.P)}{(c~t)}{?_{P[c~t/x]}}))}
        
      \step{Définition de $\pi_1$}
      {\eqbi}{c^{-1} `o (\lambda t : T. c~t)}
      
      \step{Hypothèse d'induction}
      {\eqbi}{\sref{id}~T}
    \end{array}
    \vspace{0.2em}
    $
    
    et
    \vspace{0.2em}

    $\begin{array}{ll}
      \firsteq{(\lambda t : T.\elt{U}{(\lambda x :
          U.P)}{(c^{-1}~t)}{?_{P[c^{-1}~t/x]}})
        `o c `o \pi_1}
      
      \step{Définition de la composition}
      {\eqbi}{\lambda t : \mysubset{x}{U}{P}.
        \elt{U}{(\lambda x : U.P)}
        {(c^{-1}~(c~(\pi_1~t)))}{?_{P[c^{-1}~(c~(\pi_1~t))/x]}}}
    
    \step{Hypothèse d'induction}
    {\eqbi}{{\lambda t : \mysubset{x}{U}{P}.
        \elt{U}{(\lambda x : U.P)}{(\pi_1~t)}{?_{P[\pi_1~t/x]}}}}

    \step{Indifférence aux preuves!}
    {\eqbi}{\sref{id}_{\mysubset{x}{U}{P}}}

    \end{array}$
    
    


  \end{induction}
\end{proof}


\paragraph{Substitutivité}
\setboolean{displayLabels}{false}
Le lemme qui pose problème est la substitutivité de l'interprétation.
On l'énonce de la façon suivante:

\begin{lemma}[$\mu$ et interprétation]
  \label{mu-interp}
  Si $\mualgo(T) = V$ alors soit $(\pi, V') = \muimpl(\ipt{T}{\iG})$. On
  a $V' = \ipt{\mualgo(T)}{\iG}$.
\end{lemma}

\begin{proof}
  Par induction sur la forme de $T$.
  \begin{induction}
  \item[-] Si $T `= \mysubset{x}{U}{P}$ alors $\mualgo(T) = \mualgo(U)$
    et $\ipt{T}{\iG} = \mysubset{x}{\ipt{U}{\iG}}{\ipt{P}{\ipG{`G, x :
          T}}}$ donc $\muimpl(\ipt{T}{\iG}) = \muimpl(\ipt{U}{\iG}) =
    (\pi, U')$.
    Par induction, $U' = \ipt{\mualgo(U)}{\iG}$ donc
    $\muimpl(\ipt{T}{\iG}) = (\pi `o \pi_1, \ipt{\mualgo(T)}{\iG})$
    et la propriété est vérifiée.
    
  \item[-] Sinon, $\mualgo(T) = T$, donc $\muimpl(\ipt{T}{\iG}) =
    \muimpl(\ipt{\mualgo(T)}{\iG})$.
    L'interprétation est un homomorphisme, donc si $T$ n'est pas un type
    sous-ensemble, $\ipt{T}{\iG}$ ne peut en être un, on en déduit donc
    $\muimpl(\ipt{\mualgo(T)}{\iG}) = (\sref{id},
    \ipt{\mualgo(T)}{\iG})$, soit le résultat désiré.
  \end{induction}
\end{proof}

\begin{lemma}[Coercion de sortes]
  \label{subi-sorts}
  Si $s \subi T$ ou $T \subi s$ où $s `: \setproptype$ alors $T = s$.
\end{lemma}

\begin{proof}
  \TODO{}
\end{proof}


\def\iu{\ip{u}{\iG}}
\def\tux{\ip{t[u/x]}{`G, `D[u/x]}}
\def\cux{[c~\ip{u}{`G}/x]}
\def\tcux{\ip{t}{\ipG{`G, x : V, `D}}[c~\ip{u}{`G}/x]}
\def\GD{`G, x : V, `D}
\def\Gr{`G, `D[u/x]}
\def\iGD{\ipG{`G, x : V, `D}}
\def\iGr{\ipG{`G, `D[u/x]}}

\begin{lemma}[Substitution et coercion]
  \[\left.\begin{array}{l}
      `G \typea u : U \\
      c : U \subi V \\
      \GD \typea t : T
%      `G, x : V, `D \typea t : T "=>" \ipT{t}{\iGD} = \ipt{T}{\iGD}      
%      \ipG{`G, x : V, `D} \typec \ipt{t}{\ipG{`G, x : V, `D}} :
%      \ipt{T}{\ipG{`G, x : V, `D}}
  \end{array}
\right\} "=>"
\begin{array}{l}
  \Gr \typea t[u/x] : T' \\
  `E `a : T' \suba T[u/x],\\
  `a \ip{t[u/x]}{\Gr} \eqbi \ip{t}{\GD}\cux
\end{array}
\]
\end{lemma}


\begin{proof}
  D'après le lemme de substitution du système algorithmique, 
  on a $\Gr \typea t[u/x] T' \suba T[u/x]$. On peut donc automatiquement
  dériver $`a$ à partir de la dérivation de $T' \suba T[u/x]$. On va
  montrer la conclusion par induction sur la dérivation de $`G, x : V
  \typea t : T$. Soit $`G' = \GD$ et $`G_{`r} = \Gr$.
  
  \begin{induction}
    \case{Var} 
    On a:
    \typenva
    \begin{prooftree}
      \BAX{Var}
      {$\wf \GD$}
      {$y : T `: \GD$}
      {$\GD \seq y : T$}
      {}
    \end{prooftree}    
    \typenvi

    \begin{itemize}
    \item Si $x "/=" y$ alors par définition de l'interprétation, on doit montrer
      $`a~y \eqbi y$. C'est direct car la coercion de $T'$ à
      $T[u/x]$ ne peut être que l'identité. En effet,
      le type dérivé pour $y$ dans
      l'environnement $`G, `D[u/x]$ est $(`G, `D[u/x])(y)$, soit $T[u/x]$. 
         
    \item Sinon, $T = V$, $x `; V$, $t[u/x] = u$ et donc $T' = U$.
      On peut prendre $`a = c$ car $T' = U$ et $T[u/x] = V$.
      On peut vérifier:
      \begin{eqnarray*}
        c~\ip{x[u/x]}{\Gr} & = & c~\ip{u}{\Gr} \\
        & = & \ip{x}{\GD}\cux
      \end{eqnarray*}
      
    \end{itemize}
    
    \case{App}\quad
    \typenva
    \begin{prooftree}
      \TAX{App}
      {$`G \seq f : F \quad \mualgo(F) = \Pi y : A. B$}
      {$`G \seq e : E \quad `G \seq E, A : s$}
      {$E \sub A $}
      {$`G \seq (f~e) : B [ e / y ]$}
      {}
    \end{prooftree}
    \typenvi
    
    Par induction:
    \[`E `a_f : F' \suba F[u/x],
    `a_f~\ip{f[u/x]}{\Gr} \eqbi \ip{f}{\GD}\cux\]
    \[`E `a_e, E' \suba E[u/x],
    `a_e~\ip{e[u/x]}{\Gr} \eqbi \ip{e}{\GD}\cux\]
    
    \def\afe{`a}
    On a $\Gr \typea (f~e)[u/x] : B' \suba B[u/x]$ et l'on veut montrer
    qu'il existe une coercion $\afe$ telle que:
    \[\afe : B' \suba B[e/y][u/x],
    \afe~\ip{(f~e)[u/x]}{\Gr} \eqbi \ip{(f~e)}{\GD}\cux\]
    
    Par définition de la substitution et de l'interprétation, 
    \def\myip#1{\lbag#1\rbag}
    \begin{eqnarray*}
      \ip{(f~e)}{\GD}
      & = & (((\pi~\ip{f}{\GD})~(c'~\ip{e}{\GD})) \\
      \text{ où } & & \\
      (\pi, \Pi y : A.B) & = & \muimpl~(\typeafn{\GD}{f}) \\
      c' & = & \sref{coerce}~\typeafn{\GD}{e}~A.
    \end{eqnarray*}
    
    On doit montrer que $c'$ est bien dérivable.
    Par induction on a $\ip{e}{\GD} = \ip{E}{\GD}$ et
    par hypothèse $E \suba A$. On peut appliquer le lemme
    \ref{interp-coercion} pour obtenir:    
    \[`E!c', \GD \typec c' : \ip{E}{\GD} \subi \ip{A}{\GD}\]
        
    On peut substituer pour obtenir:
    \[c'\cux : \ip{E}{\GD}\cux \subi \ip{A}{\GD}\cux\]

    On a donc: 
    \[\ip{(f~e)}{\GD}\cux =
    ((\pi~\ip{f}{\GD}\cux)~(c'\cux~\ip{e}{\GD}\cux))\]
    et
    \[\ip{(f~e)}{\GD}\cux =
    \ip{B}{\GD}[c'~\ip{e}{\GD}/y]\cux\]

    D'autre part on a:
    \begin{eqnarray*}
      \ip{(f~e)[u/x]}{\Gr}
      & = & (\ip{f[u/x]~e[u/x]}{\iG}, B'[c''~e'/y]) \\
      & = & ((\pi'~f')~(c''~e'),~B'[c''~e'/y]) \\
      \text{ où } & & \\
      (f', T') & = & \ip{f[u/x]}{\Gr} \\
      (\pi', \Pi y : A'.B') & = & \muimpl~(T') \\
      (e', E') & = & \ip{e[u/x]}{\Gr} \\
      c'' & = & \sref{coerce}~E'~A'.
    \end{eqnarray*}

    A partir de $\mualgo(F) = \Pi y : A.B$ on peut déduire que 
    $\mualgo(F[u/x]) = \Pi y : A[u/x].B[u/x]$ par substitutivité de
    $\mualgo$ (lemme \ref{substitutive-mu}) et par le lemme
    \ref{mu-interp}~on obtient \[\muimpl(\ip{F[u/x]}{\Gr}) = 
    (\pi, \ip{\mualgo(F[u/x])}{\Gr}) = 
    (\pi, \ip{\Pi y : A[u/x].B[u/x]}{\Gr})\]


    On doit aussi montrer que $c''$ est bien dérivable.
    Ici, $E' = \ip{e[u/x]}{\Gr}$ et $A' = \ip{A[u/x]}{\Gr}$, et on a
    l'hypothèse $E \suba A$.    
    Or par substitutivité de la coercion dans le système algorithmique,
    on a $E[u/x] \suba A[u/x]$. 
    On peut appliquer le lemme \ref{interp-coercion} pour déduire:
    \[`E!d, \Gr \typec d : \ip{E[u/x]}{\Gr} \subi
    \ip{A[u/x]}{\Gr}\]
    
    Par application du lemme \ref{coerce-subst-type} sur la dérivation
    de $\GD \typea E : s$ on peut déduire que \[\ip{E[u/x]}{\Gr} =
    \ip{E}{\GD}\cux\] On peut donc composer les coercions pour
    obtenir:
    \[c'' = d `o `a_e : \ip {e[u/x]}{\Gr} \subi A'\]
    


%     De même, à partir de $E \suba A$ on peut déduire une coercion \[c :
%     \ip{E[u/x]}{\Gr} \subi \ip{A[u/x]}{\Gr}\]
    
    Par inversion de $\GD \typea f : F$ on a $\GD \typea F : s$.
    On peut appliquer le lemme \ref{coerce-subst-type} pour obtenir:
    \[\ip{F[u/x]}{\Gr} = \ip{F}{\GD}\cux\]
    
    On a donc les coercions suivantes pour la fonction $f$ et l'argument
    $e$: 
    \[
    \xymatrix{
      \ip{F}{\GD}\cux\ar[rr]_{\pi} & & 
      \ip{\Pi y : A.B}{\GD}\cux \\
      \ip{f[u/x]}{\Gr}\ar[u]^{`a_f}\ar[rr]^{\pi'} & &
      {\Pi y : A'.B'}\ar@{-->}[u]^{c_f}}
    \]
    \[
    \xymatrix{
      \ip{E}{\GD}\cux\ar[rr]_{c'} & & 
      \ip{A}{\Gr}\cux\ar@{-->}[d]^{c_e} \\
      \ip{e[u/x]}{\Gr}\ar[u]^{`a_e}
      \ar[rr]^{c''} & & A'}
    \]
    
    On veut montrer que les diagrammes commutent et que $c_f, c_e$ sont
    uniquement déterminés. 
    Pour cela on va tout d'abord
    montrer qu'il existe une coercion unique \[c_f : \Pi y : A'.B' \subi 
    \ip{\Pi z : A.B}{\GD}\cux\] Cela est vrai par transitivité
    et symmétrie de la coercion (lemmes \ref{subi-trans} et \ref{subi-sym}).  
    On en déduit qu'il existe $c_1, c_2$
    tels que $c_f = \lambda f.\lambda x. c_2~(f~(c_1~x))$ avec
    \[
    \xymatrix{
      \ip{A}{\GD}\cux\ar[rr]^(0.7){c_1} & & A' & &
      B' \ar[rr]^(0.3){c_2} & & 
      \ip{B}{\ipG{`G, x : A, `D, y : A}}\cux
    }\]
    
    On peut prendre $c_e = c_1$ et $\afe = c_2$. On a l'équation $c'' = c_1
    `o c' `o `a_e$.
    Alors:
    
    \[\begin{array}{ll}
      \firsteq{\afe~\ip{(f~e)[u/x]}{\Gr}}
      
      \step{Définition de l'interprétation}
      {=}{\afe~((\pi'~f')~(c''~e'))}
      
      \step{Définitions de $`a$ et $c''$}
      {=}{c_2~((\pi'~f')~((c_1 `o c' `o `a_e)~e'))}
      
      \step{Définition de la composition}
      {=}{c_2~((\pi'~f')~(c_1~(c'~(`a_e~e'))))}

      \step{Définition de $c_f$ ($= \lambda f.\lambda
        x.c_2~(f~(c_1~x))$)}
      {=}{(c_f~(\pi'~f'))~(c'~(`a_e~e'))}

      \step{Commutation du diagramme 1}{=}{(\pi~(`a_f~f'))~(c'~(`a_e~e'))}
      
      \step{Définitions de $`a_f$ et $`a_e$}{=}{(\pi~\ip{f}{\GD}\cux)~(c'~\ip{e}{\GD}\cux)}

      \step{Définition de l'interprétation}{=}{\ip{f~e}{\GD}\cux}
      \vspace{0.2em}
    \end{array}\]
    
    \vspace{1cm}
    On montre la deuxième condition:
    \[\begin{array}{ll}
      \firsteq{\ip{f~e}{\GD}}

      \step{Définition de l'interprétation}
      {=}{\ip{B}{\ipG{\GD, y : A}}[c'~\ip{e}{\GD}/y]}
    
      \step{Application du lemme \ref{coerce-subst-type}~à $\GD, y : A \typea B : s$}
      {\eqbi}{\ip{B[e/y]}{\GD}}
    \end{array}\]
    
    \TODO{Autres cas}

  \end{induction}
\end{proof}

On peut maintenant montrer notre théorème de correction.

\setboolean{displayLabels}{false}
\begin{theorem}[Correction de l'interprétation]
  \label{correct-interp}
  Si $`G \typea t : T$ alors on a $\iG \typec \ip{t}{\iG} :
  \ip{T}{\iG}$.
  Si $\wf `G$ alors $\wf \iG$.
\end{theorem}

\begin{proof}
  Par induction mutuelle sur la dérivation de typage ou de bonne
  formation.

  \begin{induction}
    \case{WfEmpty} Trivial.

    \case{WfVar}
    Par induction $\iG \typec \ip{A}{\iG} :
    \ip{s}{\iG}$. Par inversion du jugement de bonne formation
    dans \CCI{}, $\typewf \iG$.
    Or, $\ip{s}{\iG} = s$ ($s `: \{ \Prop, \Set, \Type \}$), donc 
    on peut appliquer \irule{WfVar} dans \CCI{} pour obtenir:
    $\wf \iG, x : \ip{A}{\iG}$, soit $\wf \ipG{`G, x : A}$.

    \case{PropSet}
    Direct par induction, $\iG \typec \ip{s}{\iG} = s :
    \ip{\Type}{\iG} = \Type$. La deuxième condition est directe
    par définition de l'interprétation.
    
    \case{Var} On a:
    \begin{prooftree}
      \Var
    \end{prooftree}
    Par induction, $\wf \iG$ et par simple inspection de la
    définition de l'interprétation des contextes, si $x : A `: `G$ alors
    $x : \ip{A}{`D} `: \iG$ pour $`D ``( `G$. Par affaiblissement
    dans \CCI{}, on obtient aisément $\iG \typec x : \ip{A}{`D}$ 
    à partir de  $\ipG{`D} \typec x : \ip{A}{\ipG{`D}}$. Or il est clair par
    la définition de l'interprétation que $\ip{A}{`D} = \ip{A}{`G}$  
    si $`G$ est une extension de $`D$ puisqu'on utilise l'environnement
    uniquement au moment de typer les variables et
    $\iG(x) = \ipG{`D}(x)$ pour tout $x$ utilisé dans $A$.
    On a donc $\iG \typec x : \ip{A}{\iG}$.
    La deuxième condition est montrée par $\ip{x}{`G} = \iG(x) = 
    \ip{A}{\ipG{`D}} = \ip{A}{\iG}$.
      
    \case{Prod} On a:
    \begin{prooftree}
      \Prod
    \end{prooftree}
    
    Par induction $\iG \typec \ip{T}{\iG} : \ip{s_1}{\iG}
    = s_1$ et $\ipG{`G, x : T} \typec \ip{U}{\ipG{`G, x : T}} :
    \ip{s_2}{\ipG{`G, x : T}} = s_2$.
    On déplie l'interprétation pour obtenir:
    $\iG, x : \ip{T}{\iG} \typec \ip{U}{\iG{}, x : \ip{T}{\iG}} :
    s_2$.
    
    Par \irule{Prod} dans \CCI, on obtient:
    $\iG{} \typec \Pi x : \ip{T}{\iG}. \ip{U}{\iG{}, x : \ip{T}{\iG}}
    : s_3$.
    Or $\ip{\Pi x : T.U}{\iG} = \Pi x : \ip{T}{\iG}. \ip{U}{\iG{}, x
      : \ip{T}{\iG}}$, donc on a bien:
    $\iG \typec \ip{\Pi x : T.U}{\iG} : s_3 = \ip{s_3}{\iG}$.
    La seconde condition est directe d'après la définition de $\mathcal{R}$ qui
    est une fonction.

    \case{Abs} On a:
    \begin{prooftree}
      \Abs
    \end{prooftree}
    
    Par induction $\iG \typec \ip{\Pi x : T.U}{\iG} : \ip{s}{\iG}$
    et $\ipG{`G, x : T} \typec \ip{M}{\ipG{`G, x : T}} :
    \ip{U}{\ipG{`G, x : T}}$.
    On déplie l'interprétation pour obtenir:
    $\iG, x : \ip{T}{\iG} \typec \ip{M}{\iG{}, x : \ip{T}{\iG}} :
    \ip{U}{\ipG{`G, x : T}}$.
    
    Par \irule{Abs} dans \CCI, on obtient:
    $\iG{} \typec \lambda x : \ip{T}{\iG}. \ip{M}{\iG{}, x : \ip{T}{\iG}}
    : \ip{\Pi x : T.U}{\iG}$.
    C'est équivalent à:
    $\iG \typec \ip{\lambda x : T.U}{\iG} : \ip{\Pi x : T.U}{\iG}$.
    La seconde condition se montre ainsi:
    $\ip{\lambda x : T.M}{\iG} = \Pi x : \ip{T}{\iG}. \ip{M}{\iG, x :
      \ip{T}{\iG}}$. Or par induction, 
    $\ip{M}{\iG, x : \ip{T}{\iG}} = \ip{U}{\iG, x : \ip{T}{\iG}}$, donc 
    $\ip{\lambda x : T.M}{\iG} = \Pi x : \ip{T}{\iG}. \ip{U}{\iG, x :
      \ip{T}{\iG}} = \ip{\Pi x : T.U}{\iG}$.
    
    \case{App} On a:
    \begin{prooftree}
      \AppA
    \end{prooftree}

    C'est le cas intéressant puisqu'on ajoute ici des coercions.
    Par induction, $\iG{} \typec \ip{f}{\iG} : \ip{T}{\iG}$,
    $\iG{} \typec \ip{u}{\iG} : \ip{U}{\iG}$,
    $\iG{} \typec \ip{U}{\iG}, \ip{V}{\iG} : \ip{s}{\iG}$.
    
    On procéde par étapes: d'abord la construction d'une fonction
    $\pi \ip{f}{\iG} : \ip{\Pi x : V.W}{\iG}$ puis la construction de
    l'argument $c \ip{u}{\iG} : \ip{V}{\iG}$. On n'a plus qu'à les
    appliquer pour obtenir le jugement:
    $\iG{} \typec \ip{f~u}{\iG} : \ip{W}{\iG, x :
      \ip{V}{\iG}}[c~u/x]$.
    Par substitutivité de l'interprétation, on a
    $\ip{W}{\iG, x : \ip{V}{\iG}}[c~u/x] \eqbi
    \ip{W[u/x]}{\iG}$ puisque les coercions de sorte à sorte ne peuvent
    être que l'identité. On peut donc déduire:
    $\iG{} \typec \ip{f~u}{\iG} : \ip{W[u/x]}{\iG}$ par \irule{Conv}.

    \item[- \irule{Sigma}, \irule{Sum}, \irule{LetSum}, \irule{Subset}:]
      Direct par induction ou un raisonnement similaire à \irule{App}.      
  \end{induction}
\end{proof}


%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "subset-typing"
%%% LaTeX-command: "x=pdf; TEXINPUTS=\"style:figures:\" ${pdfx}latex"
%%% End: 
