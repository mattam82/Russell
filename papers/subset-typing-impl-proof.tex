\def\iG{\ipG{`G}}
\subsection{Propriétés}
On veut montrer que si l'on a un jugement valide dans notre système
algorithmique, alors son image par l'interprétation est un jugement
valide de \CCI{}. On rappelle que \CCI{} est équivalent au premier
calcul présenté où la règle de coercion est remplacée par la règle de conversion.

\typenvi
\subsubsection{Remarques sur l'interprétation}
\begin{itemize}
\item[{\bf Déterminisme}] L'interprétation est déterministe par rapport à la
  forme des termes. On peut en déduire que
  si $`G \typea x : T$ et $`G \typea \Sigma x : T.U : s$ alors 
  si $\ipt{T}{\ipG{`G}} = T'$ on a $\ipt{\Sigma x : T.U}{\ipG{`G}} =
  \Sigma x : T'. U'$.  
  
\item[{\bf Conservation de la structure}] On voit très clairement que notre
  interprétation est un homomorphisme module les coercions, 
  c'est à dire qu'elle préserve globallement la structure des termes et
  des types.

\item[{\bf Consevation du typage}] Notre interprétation transforme un terme
  bien typé dans le système algorithmique en un terme bien typé dans
  \CCI{}. Ce résultat va découler du fait que l'on reconstruit implicitement
  la dérivation de typage du système algorithmique dans notre
  interprétation en ajoutant les coercions nécessaires pour être bien
  typé dans \CCI{}.
\end{itemize}

\subsubsection{Correction}
On veut montrer le théorème suivant: si $`G \typea t : T$ alors $\iG
\typec \ipt{t}{\iG} : \ipt{T}{\iG}$. Nous n'avons pas encore trouvé de
preuve de ce résultat. En effet le jugement de coercion rend la preuve
 très difficile à cause de son caractère
non local. Pour mieux comprendre ce problème, considérons l'exemple
suivant:

\paragraph{Exemple}
Dans le système algorithmique, on peut très bien dériver
$\Pi n : \nat. \sref{list}~n \suba \Pi n :
\mysubset{x}{\nat}{P}.\listml~n$ puisque $\mysubset{x}{\nat}{P} \suba
\nat$ et $\listml~n \eqbi \listml~n$.
Si l'on réécrit vers \CCI{}, on n'aura plus les même types
de départ pour dériver le jugement puisqu'on part de types \Coq~valides.
Ici, une coercion a été insérée dans le second type:
$`G' \typec c : \Pi n : \nat. \listml~n \subi \Pi n :
\mysubset{x}{\nat}{P}.\listml~(\pi_1~n)$. Seulement, et c'est là la
preuve que l'intuition de la coercion par prédicats est bonne, on peut
dériver ce jugement:

\begin{prooftree}
  \AXC{$\nat \eqbi \nat$}
  \UIC{$`G' \typec \lambda x.x : \nat \subi \nat$}
  \UIC{$`G' \typec (\lambda x.x) `o \pi_1 : \mysubset{x}{\nat}{P} \subi \nat$}
  \AXC{$(\listml~n)[\pi_1~n/n] \eqbi \listml~(\pi_1~n)$}
  \UIC{$`G, n : \mysubset{x}{\nat}{P} \typec c_2 = (\lambda x.x) :
    (\listml~n)[\pi_1~n/n] \subi \listml~(\pi_1~n)$}
  \BIC{$`G' \typec \lambda f.\lambda x.c_2~(f~(\pi_1~x)) : 
    \Pi n : \nat. \listml~n \subi 
    \Pi n : \mysubset{x}{\nat}{P}.\listml~(\pi_1~n)$}
\end{prooftree}


\paragraph{Substitutivité}
\setboolean{displayLabels}{false}
Le lemme qui pose problème est la substitutivité de l'interprétation.
On l'énonce de la façon suivante:

\begin{lemma}[Substitutivité de l'interprétation]
  Si:
  \begin{itemize}
  \item $\iG \typec \ipt{u}{\iG} : \ipt{U}{\iG}$, 
  \item $\ipG{`G, x : V} \typec \ipt{W}{\ipG{`G, x : V}} :
    \ipt{T}{\ipG{`G, x : V}}$
  \item $c : \ipt{U}{\iG} \subi \ipt{V}{\iG}$ 
  \end{itemize}
  
  alors il existe $`a : \ipt{T}{\ipG{`G, x : V}}[c~\ipt{u}{\iG}/x] \suba
  \ipt{T[u/x]}{\iG}$ tel que
  $(`a~\ipt{W}{\ipG{`G, x : V}}[c~\ipt{u}{\iG}/x]) \eqbi \ipt{W[u/x]}{\iG}$.
\end{lemma}

\begin{proof}
  Par induction sur la dérivation de $\ipG{`G, x : V} \typec \ipt{W}{\ipG{`G, x : V}} :
  \ipt{T}{\ipG{`G, x : V}}$.
  La difficulté réside dans le fait que l'on doit montrer une certaine
  relation de commutation entre les coercions appliquées des deux cotés.
\end{proof}

% Par induction structurelle sur $W$.
  
%   \begin{induction}
%   \item[$W `= y$]\quad
%     \begin{itemize}
%     \item Si $y = x$, alors on doit montrer: $c~\ipt{u}{\iG} \eqbi
%       \ipt{u}{\iG}$. Cela n'est vrai que si $c$ est l'identité, donc si
%       $\ipt{U}{\iG} \eqbi \ipt{V}{\iG}$.
%       Si $\ipG{`G, x : V} \typec \ipt{x}{\ipG{`G, x : V}} : s$, alors
%       $s = \ipt{V}{\iG}$. Or $s `: \setproptype$ donc on doit avoir
%       $\ipt{V}{\iG} `: \setproptype$ et par inversion de l'interprétation,
%       $V `: \setproptype$. Par définition de la
%       coercion, si $U \suba s$ où $s `: \setproptype$ alors $U \eqbi s$.
%       On a donc bien $\ipt{U}{\iG} \eqbi \ipt{V}{\iG}$ et la coercion $c$
%       est l'identité $\lambda x.x$.
      
%     \item Si $y \neq x$ alors, $\ipt{y}{\ipG{`G, x: V}}[c~\ipt{u}{\iG}/x]
%       = \ipt{y}{\iG} = \ipt{y[u/x]}{\iG}$.
%     \end{itemize}
    
%   \item[$W `= f~v$]\quad
%     Par induction, $\ipt{f}{\ipG{`G, x : V}}[c~\ipt{u}{\iG}] \eqbi
%     \ipt{f[u/x]}{\iG}$ et $\ipt{v}{\ipG{`G, x : V}}[c~\ipt{u}{\iG}] \eqbi
%     \ipt{v[u/x]}{\iG}$.
%     D'après l'interprétation on a:
%     $\pi : \ipt{f}{\ipG{`G, x : V}} "->" \Pi x : S.T$ et $c' :
%     \ipt{v}{\ipG{`G, x : V}} "->" S$ tel que
%     $\ipt{f~v}{\ipG{`G, x : V}}[c~\ipt{u}{\iG}/x] = 
%     (\pi~\ipt{f[u/x]}{\iG})~(c~{\ipt{v[u/x]}{\iG}})$,
%     Soit $\ipt{f~v}{\ipG{`G, x : V}}[c~\ipt{u}{\iG}/x] = \ipt{(f~v)[u/x]}{\iG}$.
    
%     \begin{itemize}
%     \item Si $y = x$, alors on doit montrer:
%       $\ipt{x~a}{\ipG{`G, x : V}}[c~\ipt{u}{\iG}/x] \eqbi
%       \ipt{u~a[u/x]}{\iG}$. 
      
%       Par définition de l'interprétation, 
%       on a $\pi : \ipT{x}{\ipG{`G, x : V}} "->" \Pi x : S.T$ et
%       $c' : \ipT{a}{\ipG{`G, x : V}} "->" S$ tel que 
%       $\ipt{x~a}{\ipG{`G, x : V}} = (\pi~\ipt{x}{\ipG{`G, x :
%           V}})~(c'~\ipt{a}{\ipG{`G, x : V}})
%       = (\pi~x)~(c'~\ipt{a}{\ipG{`G, x : V}})$.
%       On a donc après application de la substitution,
%       $(\pi~(c~\ipt{u}{\iG}))~(c'~\ipt{a}{\ipG{`G, x :
%           V}}[c~\ipt{u}{\iG}/x]) : T[c'~\ipt{a}{\ipG{`G, x : V}}/x]$ ($\pi$ et $c'$ sont clos par définition).
      
%       Pour le membre droit, on a $\pi' : \ipT{u}{\iG} "->" \Pi x :
%       S'.T'$ et $c'' : \ipT{a[u/x]}{\iG} "->" S'$ tel que:
%       $\ip{u~a[u/x]}{\iG} =
%       (\pi'~\ipt{u}{\iG})~(c''~\ipt{a[u/x]}{\iG}) : T'[c''~\ipt{a[u/x]}{\iG}/x]$.
%       Il nous faut donc montrer que
%       \[(\pi~(c~\ipt{u}{\iG}))~(c'~\ipt{a}{\ipG{`G, x :
%           V}}[\ipt{u}{\iG}/x]) \eqbi (\pi'~\ipt{u}{\iG}) 
%       ~(c''~\ipt{a[u/x]}{\iG})\].
      
%       On a les coercions suivantes: 
%       \begin{itemize}
%       \item $c : \ipt{U}{\iG} "->" \ipt{V}{\iG}$
%       \item $\pi : \ipt{V}{\iG} "->" \Pi x : S.T$
%       \item $c' : \ipT{a}{\ipG{`G, x : V}} "->" S$
%       \item $\pi' : \ipt{U}{\iG} "->" \Pi x : S'.T'$
%       \item $c'' : \ipT{a[u/x]}{\iG} "->" S'$
%       \end{itemize}
      
%       Le problème ici est que $c$ peut être une coercion arbitraire et
%       donc on ne peut s'assurer que $\pi `o c = \pi'$ puisque $S, S'$ et
%       $T,T'$ peuvent effectivement être différents. En fait $T$ et $T'$
%       ne peuvent être différents puisqu'on a $\ipG{`G, x : V} \typec
%       \ipt{W}{\ipG{`G, x : V}} : s$, donc $f~v : s$ par inversion et $T
%       = T' = s$. On 

      

      
%       Supposons qu'on a $U = \Pi n : \nat.\listml~n$ et $V = \Pi n :
%       \mysubset{x}{\nat}{P}.\listml~(\pi_1~n)$ et $\ipT{a}{\ipG{`G, x :
%           V}} = \nat$.
%       Alors $S = \mysubset{x}{\nat}{P}$, $T = \listml~(\pi_1~n)$,
%       $S' = \nat$, $T' = \list~n$. Les coercions sont les suivantes:
%       $\pi = \pi' = \lambda x.x$, $c = \lambda x.u~(\pi_1~n)$,
%       $c' = (\lambda x. \sref{elt} x ?_P)$, $c'' = \lambda x.x$.
%       On a alors:
%       $(\lambda x.u~(\pi_1~x))~(\sref{elt} a ?_P[a/x]) \eqbi u~a$, ce
%       qui est vrai.
      


      

%       $\pi' \eqbi \pi `o c$  

% .
%       On va inspecter ces coercions pour obtenir le résultat.
%       On a donc $\pi `o c : \ipt{U}{\iG} "->" \Pi x : S.T$. Par
%       transitivité de la coercion, on a donc $U \suba \Pi x : S.T$ et 
%       $U \suba \Pi x : S.T'$.le
%       déterminisme de la coercion on peut en déduire que $\Pi x : S'.T'
%       \suba \Pi x : S.T$.
      
      

      
%     \end{itemize}
          
      
%   \end{induction}
  

% \end{proof}  

Si on a une preuve de ce lemme, alors on peut montrer:
\setboolean{displayLabels}{false}
\begin{theorem}[Correction de l'interprétation]
  \label{correct-interp}
  Si $`G \typea t : T$ alors on a $\iG \typec \ipt{t}{\iG} :
  \ipt{T}{\iG}$ avec $\ipT{t}{`G} = \ipt{T}{\iG}$.
  Si $\wf `G$ alors $\wf \iG$.
\end{theorem}

\begin{proof}
  Par induction mutuelle sur la dérivation de typage ou de bonne
  formation.

  \begin{induction}
    \case{WfEmpty} Trivial.

    \case{WfVar}
    Par induction $\iG \typec \ipt{A}{\iG} :
    \ipt{s}{\iG}$. Par inversion du jugement de bonne formation
    dans \CCI{}, $\typewf \iG$.
    Or, $\ipt{s}{\iG} = s$ ($s `: \{ \Prop, \Set, \Type \}$), donc 
    on peut appliquer \irule{WfVar} dans \CCI{} pour obtenir:
    $\wf \iG, x : \ipt{A}{\iG}$, soit $\wf \ipG{`G, x : A}$.

    \case{PropSet}
    Direct par induction, $\iG \typec \ipt{s}{\iG} = s :
    \ipt{\Type}{\iG} = \Type$. La deuxième condition est directe
    par définition de l'interprétation.
    
    \case{Var} On a:
    \begin{prooftree}
      \Var
    \end{prooftree}
    Par induction, $\wf \iG$ et par simple inspection de la
    définition de l'interprétation des contextes, si $x : A `: `G$ alors
    $x : \ipt{A}{`D} `: \iG$ pour $`D ``( `G$. Par affaiblissement
    dans \CCI{}, on obtient aisément $\iG \typec x : \ipt{A}{`D}$ 
    à partir de  $\ipG{`D} \typec x : \ipt{A}{\ipG{`D}}$. Or il est clair par
    la définition de l'interprétation que $\ipt{A}{`D} = \ipt{A}{`G}$  
    si $`G$ est une extension de $`D$ puisqu'on utilise l'environnement
    uniquement au moment de typer les variables et
    $\iG(x) = \ipG{`D}(x)$ pour tout $x$ utilisé dans $A$.
    On a donc $\iG \typec x : \ipt{A}{\iG}$.
    La deuxième condition est montrée par $\ipT{x}{`G} = \iG(x) = 
    \ipt{A}{\ipG{`D}} = \ipt{A}{\iG}$.
      
    \case{Prod} On a:
    \begin{prooftree}
      \Prod
    \end{prooftree}
    
    Par induction $\iG \typec \ipt{T}{\iG} : \ipt{s_1}{\iG}
    = s_1$ et $\ipG{`G, x : T} \typec \ipt{U}{\ipG{`G, x : T}} :
    \ipt{s_2}{\ipG{`G, x : T}} = s_2$.
    On déplie l'interprétation pour obtenir:
    $\iG, x : \ipt{T}{\iG} \typec \ipt{U}{\iG{}, x : \ipt{T}{\iG}} :
    s_2$.
    
    Par \irule{Prod} dans \CCI, on obtient:
    $\iG{} \typec \Pi x : \ipt{T}{\iG}. \ipt{U}{\iG{}, x : \ipt{T}{\iG}}
    : s_3$.
    Or $\ipt{\Pi x : T.U}{\iG} = \Pi x : \ipt{T}{\iG}. \ipt{U}{\iG{}, x
      : \ipt{T}{\iG}}$, donc on a bien:
    $\iG \typec \ipt{\Pi x : T.U}{\iG} : s_3 = \ipt{s_3}{\iG}$.
    La seconde condition est directe d'après la définition de $\mathcal{R}$ qui
    est une fonction.

    \case{Abs} On a:
    \begin{prooftree}
      \Abs
    \end{prooftree}
    
    Par induction $\iG \typec \ipt{\Pi x : T.U}{\iG} : \ipt{s}{\iG}$
    et $\ipG{`G, x : T} \typec \ipt{M}{\ipG{`G, x : T}} :
    \ipt{U}{\ipG{`G, x : T}}$.
    On déplie l'interprétation pour obtenir:
    $\iG, x : \ipt{T}{\iG} \typec \ipt{M}{\iG{}, x : \ipt{T}{\iG}} :
    \ipt{U}{\ipG{`G, x : T}}$.
    
    Par \irule{Abs} dans \CCI, on obtient:
    $\iG{} \typec \lambda x : \ipt{T}{\iG}. \ipt{M}{\iG{}, x : \ipt{T}{\iG}}
    : \ipt{\Pi x : T.U}{\iG}$.
    C'est équivalent à:
    $\iG \typec \ipt{\lambda x : T.U}{\iG} : \ipt{\Pi x : T.U}{\iG}$.
    La seconde condition se montre ainsi:
    $\ipT{\lambda x : T.M}{\iG} = \Pi x : \ipt{T}{\iG}. \ipT{M}{\iG, x :
      \ipt{T}{\iG}}$. Or par induction, 
    $\ipT{M}{\iG, x : \ipt{T}{\iG}} = \ipt{U}{\iG, x : \ipt{T}{\iG}}$, donc 
    $\ipT{\lambda x : T.M}{\iG} = \Pi x : \ipt{T}{\iG}. \ipt{U}{\iG, x :
      \ipt{T}{\iG}} = \ipt{\Pi x : T.U}{\iG}$.
    
    \case{App} On a:
    \begin{prooftree}
      \AppA
    \end{prooftree}

    C'est le cas intéressant puisqu'on ajoute ici des coercions.
    Par induction, $\iG{} \typec \ipt{f}{\iG} : \ipt{T}{\iG}$,
    $\iG{} \typec \ipt{u}{\iG} : \ipt{U}{\iG}$,
    $\iG{} \typec \ipt{U}{\iG}, \ipt{V}{\iG} : \ipt{s}{\iG}$.
    
    On procéde par étapes: d'abord la construction d'une fonction
    $\pi \ipt{f}{\iG} : \ipt{\Pi x : V.W}{\iG}$ puis la construction de
    l'argument $c \ipt{u}{\iG} : \ipt{V}{\iG}$. On n'a plus qu'à les
    appliquer pour obtenir le jugement:
    $\iG{} \typec \ipt{f~u}{\iG} : \ipt{W}{\iG, x :
      \ipt{V}{\iG}}[c~u/x]$.
    Par substitutivité de l'interprétation, on a
    $\ipt{W}{\iG, x : \ipt{V}{\iG}}[c~u/x] \eqbi
    \ipt{W[u/x]}{\iG}$ puisque les coercions de sorte à sorte ne peuvent
    être que l'identité. On peut donc déduire:
    $\iG{} \typec \ipt{f~u}{\iG} : \ipt{W[u/x]}{\iG}$ par \irule{Conv}.

    \item[- \irule{Sigma}, \irule{Sum}, \irule{LetSum}, \irule{Subset}:]
      Direct par induction ou un raisonnement similaire à \irule{App}.      
  \end{induction}
\end{proof}


%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "subset-typing"
%%% LaTeX-command: "TEXINPUTS=\"style:$TEXINPUTS\" latex"
%%% End: 
