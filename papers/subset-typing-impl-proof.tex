\def\iG{\ipG{`G}}
\subsection{Propriétés}
On veut montrer que si l'on a un jugement valide dans notre système
algorithmique, alors son image par l'interprétation est un jugement
valide de \CCI{}. On rappelle que \CCI{} est équivalent au premier
calcul présenté où la règle de coercion est remplacée par la règle de conversion.

\typenvi
\subsubsection{Remarques sur l'interprétation}
\begin{itemize}
\item[{\bf Déterminisme}] L'interprétation est déterministe par rapport à la
  forme des termes. On peut en déduire que
  si $`G \typea x : T$ et $`G \typea \Sigma x : T.U : s$ alors 
  si $\ipt{T}{\ipG{`G}} = T'$ on a $\ipt{\Sigma x : T.U}{\ipG{`G}} =
  \Sigma x : T'. U'$.  
  
\item[{\bf Conservation de la structure}] On voit très clairement que notre
  interprétation est un homomorphisme module les coercions, 
  c'est à dire qu'elle préserve globallement la structure des termes et
  des types.

\item[{\bf Consevation du typage}] Notre interprétation transforme un terme
  bien typé dans le système algorithmique en un terme bien typé dans
  \CCI{}. Ce résultat va découler du fait que l'on reconstruit implicitement
  la dérivation de typage du système algorithmique dans notre
  interprétation en ajoutant les coercions nécessaires pour être bien
  typé dans \CCI{}.
\end{itemize}

\subsubsection{Correction}
On veut montrer le théorème suivant: si $`G \typea t : T$ alors $\iG
\typec \ipt{t}{\iG} : \ipt{T}{\iG}$. Nous n'avons pas encore trouvé de
preuve de ce résultat. En effet le jugement de coercion rend la preuve
 très difficile à cause de son caractère
non local. Pour mieux comprendre ce problème, considérons l'exemple
suivant:

\paragraph{Exemple}
Dans le système algorithmique, on peut très bien dériver
$\Pi n : \nat. \sref{list}~n \suba \Pi n :
\mysubset{x}{\nat}{P}.\listml~n$ puisque $\mysubset{x}{\nat}{P} \suba
\nat$ et $\listml~n \eqbi \listml~n$.
Si l'on réécrit vers \CCI{}, on n'aura plus les même types
de départ pour dériver le jugement puisqu'on part de types \Coq~valides.
Ici, une coercion a été insérée dans le second type:
$`G' \typec c : \Pi n : \nat. \listml~n \subi \Pi n :
\mysubset{x}{\nat}{P}.\listml~(\pi_1~n)$. Seulement, et c'est là la
preuve que l'intuition de la coercion par prédicats est bonne, on peut
dériver ce jugement:

\begin{prooftree}
  \AXC{$\nat \eqbi \nat$}
  \UIC{$`G' \typec \lambda x.x : \nat \subi \nat$}
  \UIC{$`G' \typec (\lambda x.x) `o \pi_1 : \mysubset{x}{\nat}{P} \subi \nat$}
  \AXC{$(\listml~n)[\pi_1~n/n] \eqbi \listml~(\pi_1~n)$}
  \UIC{$`G, n : \mysubset{x}{\nat}{P} \typec c_2 = (\lambda x.x) :
    (\listml~n)[\pi_1~n/n] \subi \listml~(\pi_1~n)$}
  \BIC{$`G' \typec \lambda f.\lambda x.c_2~(f~(\pi_1~x)) : 
    \Pi n : \nat. \listml~n \subi 
    \Pi n : \mysubset{x}{\nat}{P}.\listml~(\pi_1~n)$}
\end{prooftree}


\begin{lemma}[Correction de l'interprétation des termes]
  Si $`G \typea t : T$ alors, si $(t', T') = \ip{t}{\iG}$ alors
  $\iG \typec t' : T'$.
  Si $\wf G$ alors $\wf \iG$.
\end{lemma}

\begin{proof}
  Par induction mutuelle sur les dérivations
  dans le système algorithmique:

  \begin{induction}
    \case{Var}
    Par définition, $t = t'$ et $T' = \iG(t) = \ipt{`G(x)}{`D} =
    \ipt{T}{`D}$ pour $`D ``( `G$. Par induction, $\wf \iG$. Comme la réecriture des contextes ne
    change pas leur domaine, on peut appliquer \irule{Var} dans \CCI{}
    pour obtenir $\iG \typec t' = \ipt{t}{\iG} : T' = \ipt{T}{\iG}$.
    
    \case{Prod}
    Par induction, $\iG \typec \ipt{T}{\iG} : \ipT{T}{\iG}$,
  \end{induction}
  
\end{proof}


\paragraph{Substitutivité}
\setboolean{displayLabels}{false}
Le lemme qui pose problème est la substitutivité de l'interprétation.
On l'énonce de la façon suivante:

\begin{lemma}[$\mu$ et interprétation]
  \label{mu-interp}
  Si $\mualgo(T) = V$ alors soit $(\pi, V') = \muimpl(\ipt{T}{\iG})$. On
  a $V' = \ipt{\mualgo(T)}{\iG}$.
\end{lemma}

\begin{proof}
  Par induction sur la forme de $T$.
  \begin{induction}
  \item[-] Si $T `= \mysubset{x}{U}{P}$ alors $\mualgo(T) = \mualgo(U)$
    et $\ipt{T}{\iG} = \mysubset{x}{\ipt{U}{\iG}}{\ipt{P}{\ipG{`G, x :
          T}}}$ donc $\muimpl(\ipt{T}{\iG}) = \muimpl(\ipt{U}{\iG}) =
    (\pi, U')$.
    Par induction, $U' = \ipt{\mualgo(U)}{\iG}$ donc
    $\muimpl(\ipt{T}{\iG}) = (\pi `o \pi_1, \ipt{\mualgo(T)}{\iG})$
    et la propriété est vérifiée.
    
  \item[-] Sinon, $\mualgo(T) = T$, donc $\muimpl(\ipt{T}{\iG}) =
    \muimpl(\ipt{\mualgo(T)}{\iG})$.
    L'interprétation est un homomorphisme, donc si $T$ n'est pas un type
    sous-ensemble, $\ipt{T}{\iG}$ ne peut en être un, on en déduit donc
    $\muimpl(\ipt{\mualgo(T)}{\iG}) = (\sref{id},
    \ipt{\mualgo(T)}{\iG})$, soit le résultat désiré.
  \end{induction}
\end{proof}

\begin{lemma}[Coercion de sortes]
  \label{subi-sorts}
  Si $s \subi T$ ou $T \subi s$ où $s `: \setproptype$ alors $T = s$.
\end{lemma}

On note dans la suite $`G \typec t : T \subi^c U$ pour 
$`G \typec t : T `^ `E c, `G \typec c : T \subi U$.


\def\iu{\ipt{u}{\iG}}
\def\tux{\ipt{t[u/x]}{\ipG{`G, `D[u/x]}}}
\def\cux{[c~\ipt{u}{\iG}/x]}
\def\tcux{\ipt{t}{\ipG{`G, x : V, `D}}[c~\ipt{u}{\iG}/x]}
\def\GD{`G, x : V, `D}
\def\Gr{`G, `D[u/x]}
\def\iGD{\ipG{`G, x : V, `D}}
\def\iGr{\ipG{`G, `D[u/x]}}

\begin{lemma}[Substitution et coercion]
  \[\left.\begin{array}{l}
      \iG \typec \ipt{u}{\iG} : \ipT{u}{\iG} \\
      \iG \typec c : \ipT{u}{\iG} \subi \ipt{V}{\iG} \\
      `G, x : V, `D \typea t : T
%      `G, x : V, `D \typea t : T "=>" \ipT{t}{\iGD} = \ipt{T}{\iGD}      
%      \ipG{`G, x : V, `D} \typec \ipt{t}{\ipG{`G, x : V, `D}} :
%      \ipt{T}{\ipG{`G, x : V, `D}}
  \end{array}
\right\} "=>"
\begin{array}{lcl}
  `E `a,
  \ipG{`G, `D[u/x]} \typec `a & : & \ipT{t[u/x]}{\ipG{`G, `D[u/x]}}
  \subi 
  \ipt{T}{\ipG{`G, x : V, `D}}[c~\ipt{u}{\iG}/x]
  \\
  `a~\ipt{t[u/x]}{\ipG{`G, `D[u/x]}} & 
  \eqbi & \ipt{t}{\ipG{`G, x : V, `D}}[c~\ipt{u}{\iG}/x] 
%  \ipt{T[u/x]}{`G, `D[u/x]} & \eqbi & \ipt{T}{\ipG{`G, x: V, `D}}[c~\ipt{u}{\iG}/x]
\end{array}
\]
\end{lemma}


\begin{proof}
  Par induction sur la dérivation de $`G, x : V \typea t : T$.
  Soit $`G' = \GD$ et $`G_{`r} = \Gr$.

  \begin{induction}
    \case{Var} 
    Alors $t `= y$ et $T = (\GD)(y)$.
    \begin{itemize}
    \item Si $x "/=" y$ alors:
      Par inversion du jugement de bonne formation, on a:
      $\GD \typea T : s$ pour $s `:
      \setproptype$.
      On peut appliquer notre hypothèse d'induction pour obtenir:
      \[`E c_T, \iGr \typec c_T : \ipT{T[u/x]}{\iGr}
      \subi s\] ($\ipt{s}{`G} = s$ pour tout $`G$ et $x$ ne peut
      pas apparaître dans une sorte). On a la propriété suivante:
      \[c_T~\ipt{T[u/x]}{\iGr} \eqbi \ipt{T}{\iGD}\cux\] 
      % Or . On a donc:
      %\[c_T~\ipt{(\Gr)(y)}{\iGr} \eqbi \ipt{(\GD(y))}{\iGD}\cux\].
      $c_T$ est une coercion vers une sorte, c'est donc l'identité
      (lemme \ref{subi-sorts}). 

%       On en déduit la deuxième condition:
%       \[\ipt{T[u/x]}{\iGr} \eqbi \ipt{T}{\iGD}\cux\]
      Le jugement de coercion dérive donc l'identité par
      \irule{SubConv}, et l'on a bien:
      \begin{eqnarray*}     
        `a~\ipt{y[u/x]}{\iGr} & = & `a~y \\
        & = & (\lambda x.x)~y \\
        & \eqbi & y \\
        & = & \ipt{y}{\iGD}\cux
      \end{eqnarray*}
      
      
    \item Sinon, $T = V$, $x `; V$, $t[u/x] = u$.
      Soit $`a = c$.
      On sait que $\ipT{x[u/x]}{\iG} = \ipT{u}{\iG}$ et
      $\ipt{V}{\iGD}\cux = \ipt{V}{\iGD}$,
      $c$ est donc du bon type, et il suffit d'affaiblir le jugement
      $\iG \typec c : \ipT{u}{\iG} \subi \ipt{V}{\iG}$ pour obtenir la
      dérivation voulue.
      On peut vérifier:
      \begin{eqnarray*}
        c~\ipt{x[u/x]}{\iGr} & = & c~\ipt{u}{\iGr} \\
        & = & \ipt{x}{\iGD}\cux
      \end{eqnarray*}
      
      On utilise la propriété: 
      $\ipt{u}{\ipG{`G}} = \ipt{u}{\ipG{`G, `D}}$ pour toute extension
      $`D$ bien formée (ne masquant pas les variable de $`G$).

%       De même:
%       \begin{eqnarray*}
%         \ipt{V[u/x]}{\iGr} & = & \ipt{V}{\iGr} \\
%         & = & \ipt{V}{\iGD}\cux
%       \end{eqnarray*}      
      
    \end{itemize}
    
    \case{App}
    On a:
    \typenva
    \begin{prooftree}
      \TAX{App}
      {$`G \seq f : F \quad \mualgo(F) = \Pi y : A. B$}
      {$`G \seq e : E \quad `G \seq E, A : s$}
      {$E \sub A $}
      {$`G \seq (f~e) : B [ e / y ]$}
      {}
    \end{prooftree}
    \typenvi
    
    \def\iGx{\ipG{`G, x : V}}
    
    Par induction:
    \begin{eqnarray*}
      `E `a_f, \iGD \typec `a_f & : & \ipT{f[u/x]}{\iG} \subi
      \ipt{F}{\iGD}\cux \\
      `a_f~\ipt{f[u/x]}{\iGr} & \eqbi & \ipt{f}{\iGD}\cux \\
      \text{ et } & & \\
      `E `a_e, \iGD \typec `a_e & : & \ipT{e[u/x]}{\iG} \subi
      \ipt{E}{\iGD}\cux \\
      `a_e~\ipt{e[u/x]}{\iGr} & \eqbi & \ipt{e}{\iGD}\cux
    \end{eqnarray*}
    
    \def\afe{`a}
    On veut montrer qu'il existe une coercion $\afe$ telle que:
    \begin{eqnarray*}
      \iGD \typec \afe & : & \ipT{(f~e)[u/x]}{\iG} \subi
      \ipt{B[e/y]}{\iGD}\cux \\
      \afe~\ipt{(f~e)[u/x]}{\iGr} & \eqbi & \ipt{f~e}{\iGD}\cux 
%     \ipt{B[e/y][u/x]}{\iGr} & \eqbi & \ipt{B[e/y]}{\iGD}\cux
    \end{eqnarray*}

    Par définition de la substitution et de l'interprétation, 
    \def\myipt#1{\lbag#1\rbag}
    \begin{eqnarray*}
      \ip{(f~e)}{\iGD}
      & = & (((\pi~\ipt{f}{\iGD})~(c'~\ipt{e}{\iGD})),
      \ipt{B}{\iGD}[c'~\ipt{e}{\iGD}/y]) \\
      & = & ((\pi~\myipt{f})~(c'~\myipt{e})),
      \myipt{B}[c'~\myipt{e}/y]\cux \\
      \text{ où } & & \\
      \myipt{x} & = & \ipt{x}{\iGD} \\
      (\pi, \ipt{\Pi y : A.B}{\iGD}) & = & \muimpl~(\ipT{f}{\iGD}) \\
      c' & = & \sref{coerce}~\ipT{e}{\iGD}~\ipt{A}{\iGD}.
    \end{eqnarray*}
    
    
    \ipt{E}{\iGD} \subi \ipt{A}{\iGD}$. On peut substituer pour obtenir:
    \[c' : \ipt{E}{\iGD}\cux \subi \ipt{A}{\iGD}\cux\] (lemme
    \ref{subst-ipt-subi}).
    On a donc: 
    \[\ipt{(f~e)}{\iGD}\cux =
    ((\pi~\ipt{f}{\iGD}\cux)~(c'~\ipt{e}{\iGD}\cux))\]
    et
    \[\ipT{(f~e)}{\iGD}\cux =
    \ipt{B}{\iGD}[c'~\ipt{e}{\iGD}/y]\cux\]
    
    
    D'autre part on a:
    \begin{eqnarray*}
      \ip{(f~e)[u/x]}{\iGr}
      & = & (\ipt{f[u/x]~e[u/x]}{\iG}, B'[c''~e'/y]) \\
      & = & ((\pi'~f')~(c''~e'), B'[c''~e'/y]) \\
      \text{ où } & & \\
      (f', T') & = & \ip{f[u/x]}{\iGr} \\
      (\pi', \Pi y : A'.B') & = & \muimpl~(T') \\
      (e', E') & = & \ip{e[u/x]}{\iGr} \\
      c'' & = & \sref{coerce}~E'~A'.
    \end{eqnarray*}

    A partir de $\mualgo(F) = \Pi y : A.B$ on peut déduire que 
    $\mualgo(F[u/x]) = \Pi y : A[u/x].B[u/x]$ par substitutivité de
    $\mualgo$ (lemme \ref{substitutive-mu}) et par le lemme
    \ref{mu-interp} on obtient \[\muimpl(\ipt{F[u/x]}{\iGr}) = 
    (\pi, \ipt{\mualgo(\Pi y : A[u/x].B[u/x])}{\iGr}) = 
    (\pi, \ipt{\Pi y : A[u/x].B[u/x]}{\iGr})\]
%     De même, à partir de $E \suba A$ on peut déduire une coercion \[c :
%     \ipt{E[u/x]}{\iGr} \subi \ipt{A[u/x]}{\iGr}\]
    
    On a donc les coercions suivantes pour la fonction $f$ et l'argument
    $e$: 
    \[
    \xymatrix{
      \ipt{F}{\iGD}\cux\ar[rr]_{\pi} & & 
      \ipt{\Pi y : A.B}{\iGD}\cux \\
      \ipT{f[u/x]}{\iGr}\ar[u]^{`a_f}\ar[rr]^{\pi'} & &
      {\Pi y : A'.B'}\ar@{-->}[u]^{c_f}}
    \]
    \[
    \xymatrix{
      \ipt{E}{\iGD}\cux\ar[rr]_{c'} & & 
      \ipt{A}{\iGr}\cux\ar@{-->}[d]^{c_e} \\
      \ipT{e[u/x]}{\iGr}\ar[u]^{`a_e}
      \ar[rr]^{c''} & & A'}
    \]
    
    On veut montrer que les diagrammes commutent et que $c_f, c_e$ sont
    uniquement déterminés. 
    Pour cela on va
    montrer qu'il existe une coercion $c_f : \Pi y : A'.B' \subi 
    \ipt{\Pi z : A.B}{\iGD}\cux$. Cela est vrai par transitivité
    et symmétrie de la coercion. On en déduit qu'il existe $c_1, c_2$
    tels que $c_f = \lambda f.\lambda x. c_2 (f (c_1~x))$ avec
    \[
    \xymatrix{
      \ipt{A}{\iGD}\cux\ar[rr]^(0.7){c_1} & & A' & &
      B' \ar[rr]^(0.3){c_2} & & 
      \ipt{B}{\ipG{`G, x : A, `D, y : A}}\cux
    }\]
    
    On peut prendre $c_e = c_1$ et $\afe = c_2$, on obtient: $c'' = c_1
    `o c' `o `a_e$.
    Alors:
%    \newcommand{\step}[1]{\textbf{ \{ #1 \} }}
    
    $\begin{array}{ll}
      \firsteq{\afe~\ipt{(f~e)[u/x]}{\iGr}}
      
      \step{Définition de l'interprétation}
      {=}{\afe~((\pi'~f')~(c''~e'))}
      
      \step{Définitions de $`a$ et $c''$}
      {=}{c_2~((\pi'~f')~((c_1 `o c' `o `a_e)~e'))}
      
      \step{Définition de la composition}
      {=}{c_2~((\pi'~f')~(c_1~(c'~(`a_e~e'))))}

      \step{Définition de $c_f$ ($= \lambda f.\lambda
        x.c_2~(f~(c_1~x))$)}
      {=}{(c_f~(\pi'~f'))~(c'~(`a_e~e'))}

      \step{Commutation du diagramme 1}{=}{(\pi~(`a_f~f'))~(c'~(`a_e~e'))}
      
      \step{Définitions de $`a_f$ et $`a_e$}{=}{(\pi~\ipt{f}{\iGD}\cux)~(c'~\ipt{e}{\iGD}\cux)}

      \step{Définition de l'interprétation}{=}{\ipt{f~e}{\iGD}\cux}
      \vspace{0.2em}
    \end{array}$
    
    
%     Il faut maintenant montrer que $\ipt{B[e/y][u/x]}{\iGr} \eqbi
%     \ipt{B[e/y]}{\iGD}\cux$.

%     On a $`a_1 : T' \subi \ipt{T[u/x]}{\iG}$ et $\pi : \ipt{T[u/x]}{\iG}
%     \subi \ipt{\Pi y : A[u/x].B[u/x]}{\iG}$, on peut donc construire la
%     coercion \[\pi~`o~`a_1 : T' \subi \Pi y :
%     \ipt{A[u/x]}{\iG}.\ipt{B[u/x]}{\ipG{`G, y : A[u/x]}}\]
    
    

%     $T'$ est nécessairement de la forme $\mysubset{x}{\ldots\Pi x : V'.B'\ldots}{P}$.

%     On a $E \suba V$ et l'on veut montrer qu'il existe une coercion $c : 
%     E' \subi V'$. 
    
    

%     La substitution ne change pas la forme des termes, donc on est
%     assuré que si $\mualgo(T) = \Pi x : V.B$ alors $\muimpl{T'} = (\pi,
%     \Pi y : V'.B')$ où $V' \subi \ipt{V[u/x]}{\iG}$ et
%     $\ipt{B[u/x]}{\ipG{`G, y : V}} \subi B'$.
    
    




    
    

    


    
    
    
  \end{induction}
  



  La difficulté réside dans le fait que l'on doit montrer une certaine
  relation de commutation entre les coercions appliquées des deux cotés.
\end{proof}

% Par induction structurelle sur $B$.

%   \begin{induction}
%   \item[$B `= y$]\quad
%     \begin{itemize}
%     \item Si $y = x$, alors on doit montrer: $c~\ipt{u}{\iG} \eqbi
%       \ipt{u}{\iG}$. Cela n'est vrai que si $c$ est l'identité, donc si
%       $\ipt{U}{\iG} \eqbi \ipt{V}{\iG}$.
%       Si $\ipG{`G, x : V} \typec \ipt{x}{\ipG{`G, x : V}} : s$, alors
%       $s = \ipt{V}{\iG}$. Or $s `: \setproptype$ donc on doit avoir
%       $\ipt{V}{\iG} `: \setproptype$ et par inversion de l'interprétation,
%       $V `: \setproptype$. Par définition de la
%       coercion, si $U \suba s$ où $s `: \setproptype$ alors $U \eqbi s$.
%       On a donc bien $\ipt{U}{\iG} \eqbi \ipt{V}{\iG}$ et la coercion $c$
%       est l'identité $\lambda x.x$.
      
%     \item Si $y \neq x$ alors, $\ipt{y}{\ipG{`G, x: V}}[c~\ipt{u}{\iG}/x]
%       = \ipt{y}{\iG} = \ipt{y[u/x]}{\iG}$.
%     \end{itemize}
    
%   \item[$B `= f~v$]\quad
%     Par induction, $\ipt{f}{\ipG{`G, x : V}}[c~\ipt{u}{\iG}] \eqbi
%     \ipt{f[u/x]}{\iG}$ et $\ipt{v}{\ipG{`G, x : V}}[c~\ipt{u}{\iG}] \eqbi
%     \ipt{v[u/x]}{\iG}$.
%     D'après l'interprétation on a:
%     $\pi : \ipt{f}{\ipG{`G, x : V}} "->" \Pi x : S.T$ et $c' :
%     \ipt{v}{\ipG{`G, x : V}} "->" S$ tel que
%     $\ipt{f~v}{\ipG{`G, x : V}}[c~\ipt{u}{\iG}/x] = 
%     (\pi~\ipt{f[u/x]}{\iG})~(c~{\ipt{v[u/x]}{\iG}})$,
%     Soit $\ipt{f~v}{\ipG{`G, x : V}}[c~\ipt{u}{\iG}/x] = \ipt{(f~v)[u/x]}{\iG}$.
    
%     \begin{itemize}
%     \item Si $y = x$, alors on doit montrer:
%       $\ipt{x~a}{\ipG{`G, x : V}}[c~\ipt{u}{\iG}/x] \eqbi
%       \ipt{u~a[u/x]}{\iG}$. 
      
%       Par définition de l'interprétation, 
%       on a $\pi : \ipT{x}{\ipG{`G, x : V}} "->" \Pi x : S.T$ et
%       $c' : \ipT{a}{\ipG{`G, x : V}} "->" S$ tel que 
%       $\ipt{x~a}{\ipG{`G, x : V}} = (\pi~\ipt{x}{\ipG{`G, x :
%           V}})~(c'~\ipt{a}{\ipG{`G, x : V}})
%       = (\pi~x)~(c'~\ipt{a}{\ipG{`G, x : V}})$.
%       On a donc après application de la substitution,
%       $(\pi~(c~\ipt{u}{\iG}))~(c'~\ipt{a}{\ipG{`G, x :
%           V}}[c~\ipt{u}{\iG}/x]) : T[c'~\ipt{a}{\ipG{`G, x : V}}/x]$ ($\pi$ et $c'$ sont clos par définition).
      
%       Pour le membre droit, on a $\pi' : \ipT{u}{\iG} "->" \Pi x :
%       S'.T'$ et $c'' : \ipT{a[u/x]}{\iG} "->" S'$ tel que:
%       $\ip{u~a[u/x]}{\iG} =
%       (\pi'~\ipt{u}{\iG})~(c''~\ipt{a[u/x]}{\iG}) : T'[c''~\ipt{a[u/x]}{\iG}/x]$.
%       Il nous faut donc montrer que
%       \[(\pi~(c~\ipt{u}{\iG}))~(c'~\ipt{a}{\ipG{`G, x :
%           V}}[\ipt{u}{\iG}/x]) \eqbi (\pi'~\ipt{u}{\iG}) 
%       ~(c''~\ipt{a[u/x]}{\iG})\].
      
%       On a les coercions suivantes: 
%       \begin{itemize}
%       \item $c : \ipt{U}{\iG} "->" \ipt{V}{\iG}$
%       \item $\pi : \ipt{V}{\iG} "->" \Pi x : S.T$
%       \item $c' : \ipT{a}{\ipG{`G, x : V}} "->" S$
%       \item $\pi' : \ipt{U}{\iG} "->" \Pi x : S'.T'$
%       \item $c'' : \ipT{a[u/x]}{\iG} "->" S'$
%       \end{itemize}
      
%       Le problème ici est que $c$ peut être une coercion arbitraire et
%       donc on ne peut s'assurer que $\pi `o c = \pi'$ puisque $S, S'$ et
%       $T,T'$ peuvent effectivement être différents. En fait $T$ et $T'$
%       ne peuvent être différents puisqu'on a $\ipG{`G, x : V} \typec
%       \ipt{B}{\ipG{`G, x : V}} : s$, donc $f~v : s$ par inversion et $T
%       = T' = s$. On 

      

      
%       Supposons qu'on a $U = \Pi n : \nat.\listml~n$ et $V = \Pi n :
%       \mysubset{x}{\nat}{P}.\listml~(\pi_1~n)$ et $\ipT{a}{\ipG{`G, x :
%           V}} = \nat$.
%       Alors $S = \mysubset{x}{\nat}{P}$, $T = \listml~(\pi_1~n)$,
%       $S' = \nat$, $T' = \list~n$. Les coercions sont les suivantes:
%       $\pi = \pi' = \lambda x.x$, $c = \lambda x.u~(\pi_1~n)$,
%       $c' = (\lambda x. \sref{elt} x ?_P)$, $c'' = \lambda x.x$.
%       On a alors:
%       $(\lambda x.u~(\pi_1~x))~(\sref{elt} a ?_P[a/x]) \eqbi u~a$, ce
%       qui est vrai.
      


      

%       $\pi' \eqbi \pi `o c$  

% .
%       On va inspecter ces coercions pour obtenir le résultat.
%       On a donc $\pi `o c : \ipt{U}{\iG} "->" \Pi x : S.T$. Par
%       transitivité de la coercion, on a donc $U \suba \Pi x : S.T$ et 
%       $U \suba \Pi x : S.T'$.le
%       déterminisme de la coercion on peut en déduire que $\Pi x : S'.T'
%       \suba \Pi x : S.T$.
      
      

      
%     \end{itemize}
          
      
%   \end{induction}
  

% \end{proof}  

Si on a une preuve de ce lemme, alors on peut montrer:
\setboolean{displayLabels}{false}
\begin{theorem}[Correction de l'interprétation]
  \label{correct-interp}
  Si $`G \typea t : T$ alors on a $\iG \typec \ipt{t}{\iG} :
  \ipT{t}{\iG}$ et il existe $c : \ipT{t}{`G} \subi \ipt{T}{\iG}$.
  Si $\wf `G$ alors $\wf \iG$.
\end{theorem}

\begin{proof}
  Par induction mutuelle sur la dérivation de typage ou de bonne
  formation.

  \begin{induction}
    \case{WfEmpty} Trivial.

    \case{WfVar}
    Par induction $\iG \typec \ipt{A}{\iG} :
    \ipt{s}{\iG}$. Par inversion du jugement de bonne formation
    dans \CCI{}, $\typewf \iG$.
    Or, $\ipt{s}{\iG} = s$ ($s `: \{ \Prop, \Set, \Type \}$), donc 
    on peut appliquer \irule{WfVar} dans \CCI{} pour obtenir:
    $\wf \iG, x : \ipt{A}{\iG}$, soit $\wf \ipG{`G, x : A}$.

    \case{PropSet}
    Direct par induction, $\iG \typec \ipt{s}{\iG} = s :
    \ipt{\Type}{\iG} = \Type$. La deuxième condition est directe
    par définition de l'interprétation.
    
    \case{Var} On a:
    \begin{prooftree}
      \Var
    \end{prooftree}
    Par induction, $\wf \iG$ et par simple inspection de la
    définition de l'interprétation des contextes, si $x : A `: `G$ alors
    $x : \ipt{A}{`D} `: \iG$ pour $`D ``( `G$. Par affaiblissement
    dans \CCI{}, on obtient aisément $\iG \typec x : \ipt{A}{`D}$ 
    à partir de  $\ipG{`D} \typec x : \ipt{A}{\ipG{`D}}$. Or il est clair par
    la définition de l'interprétation que $\ipt{A}{`D} = \ipt{A}{`G}$  
    si $`G$ est une extension de $`D$ puisqu'on utilise l'environnement
    uniquement au moment de typer les variables et
    $\iG(x) = \ipG{`D}(x)$ pour tout $x$ utilisé dans $A$.
    On a donc $\iG \typec x : \ipt{A}{\iG}$.
    La deuxième condition est montrée par $\ipT{x}{`G} = \iG(x) = 
    \ipt{A}{\ipG{`D}} = \ipt{A}{\iG}$.
      
    \case{Prod} On a:
    \begin{prooftree}
      \Prod
    \end{prooftree}
    
    Par induction $\iG \typec \ipt{T}{\iG} : \ipt{s_1}{\iG}
    = s_1$ et $\ipG{`G, x : T} \typec \ipt{U}{\ipG{`G, x : T}} :
    \ipt{s_2}{\ipG{`G, x : T}} = s_2$.
    On déplie l'interprétation pour obtenir:
    $\iG, x : \ipt{T}{\iG} \typec \ipt{U}{\iG{}, x : \ipt{T}{\iG}} :
    s_2$.
    
    Par \irule{Prod} dans \CCI, on obtient:
    $\iG{} \typec \Pi x : \ipt{T}{\iG}. \ipt{U}{\iG{}, x : \ipt{T}{\iG}}
    : s_3$.
    Or $\ipt{\Pi x : T.U}{\iG} = \Pi x : \ipt{T}{\iG}. \ipt{U}{\iG{}, x
      : \ipt{T}{\iG}}$, donc on a bien:
    $\iG \typec \ipt{\Pi x : T.U}{\iG} : s_3 = \ipt{s_3}{\iG}$.
    La seconde condition est directe d'après la définition de $\mathcal{R}$ qui
    est une fonction.

    \case{Abs} On a:
    \begin{prooftree}
      \Abs
    \end{prooftree}
    
    Par induction $\iG \typec \ipt{\Pi x : T.U}{\iG} : \ipt{s}{\iG}$
    et $\ipG{`G, x : T} \typec \ipt{M}{\ipG{`G, x : T}} :
    \ipt{U}{\ipG{`G, x : T}}$.
    On déplie l'interprétation pour obtenir:
    $\iG, x : \ipt{T}{\iG} \typec \ipt{M}{\iG{}, x : \ipt{T}{\iG}} :
    \ipt{U}{\ipG{`G, x : T}}$.
    
    Par \irule{Abs} dans \CCI, on obtient:
    $\iG{} \typec \lambda x : \ipt{T}{\iG}. \ipt{M}{\iG{}, x : \ipt{T}{\iG}}
    : \ipt{\Pi x : T.U}{\iG}$.
    C'est équivalent à:
    $\iG \typec \ipt{\lambda x : T.U}{\iG} : \ipt{\Pi x : T.U}{\iG}$.
    La seconde condition se montre ainsi:
    $\ipT{\lambda x : T.M}{\iG} = \Pi x : \ipt{T}{\iG}. \ipT{M}{\iG, x :
      \ipt{T}{\iG}}$. Or par induction, 
    $\ipT{M}{\iG, x : \ipt{T}{\iG}} = \ipt{U}{\iG, x : \ipt{T}{\iG}}$, donc 
    $\ipT{\lambda x : T.M}{\iG} = \Pi x : \ipt{T}{\iG}. \ipt{U}{\iG, x :
      \ipt{T}{\iG}} = \ipt{\Pi x : T.U}{\iG}$.
    
    \case{App} On a:
    \begin{prooftree}
      \AppA
    \end{prooftree}

    C'est le cas intéressant puisqu'on ajoute ici des coercions.
    Par induction, $\iG{} \typec \ipt{f}{\iG} : \ipt{T}{\iG}$,
    $\iG{} \typec \ipt{u}{\iG} : \ipt{U}{\iG}$,
    $\iG{} \typec \ipt{U}{\iG}, \ipt{V}{\iG} : \ipt{s}{\iG}$.
    
    On procéde par étapes: d'abord la construction d'une fonction
    $\pi \ipt{f}{\iG} : \ipt{\Pi x : V.W}{\iG}$ puis la construction de
    l'argument $c \ipt{u}{\iG} : \ipt{V}{\iG}$. On n'a plus qu'à les
    appliquer pour obtenir le jugement:
    $\iG{} \typec \ipt{f~u}{\iG} : \ipt{W}{\iG, x :
      \ipt{V}{\iG}}[c~u/x]$.
    Par substitutivité de l'interprétation, on a
    $\ipt{W}{\iG, x : \ipt{V}{\iG}}[c~u/x] \eqbi
    \ipt{W[u/x]}{\iG}$ puisque les coercions de sorte à sorte ne peuvent
    être que l'identité. On peut donc déduire:
    $\iG{} \typec \ipt{f~u}{\iG} : \ipt{W[u/x]}{\iG}$ par \irule{Conv}.

    \item[- \irule{Sigma}, \irule{Sum}, \irule{LetSum}, \irule{Subset}:]
      Direct par induction ou un raisonnement similaire à \irule{App}.      
  \end{induction}
\end{proof}


%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "subset-typing"
%%% LaTeX-command: "x=pdf; TEXINPUTS=\"style:figures:\" ${pdfx}latex"
%%% End: 
