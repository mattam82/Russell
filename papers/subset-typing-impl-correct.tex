\begin{lemma}[Substitution et coercion]
  \label{coerce-subst-and-coercion}
  Si $\talgo{`G}{u}{U}$ et $\subimpl{`G}{c}{U}{V}$ alors
  \[\talgo{\GD}{t}{T} "=>"
  \begin{array}{l}
    \talgo{\Gr}{t[u/x]}{T'} \\
    `E `a, \subimpl{\Gr}{`a}{T'}{T[u/x]},\\
    `a[\ip{t[u/x]}{\Gr}] `= \ip{t}{\GD}\cux
  \end{array}\]
\end{lemma}

\begin{proof}
  
  Si $\talgo{\GD}{t}{T}$, alors soit $`r$ la coercion de contextes
  $\ctxdot, \ldots, c, \ctxdot, \ldots : (`G, x : U, `D) \typec (`G, x
  : V, `D)$. Par le lemme \ref{coerce-narrowing-term}, on a
  $\talgo{`G, x : U, `D}{t}{T'}$ et il existe $`a$, 
  \[\subimpl{`G, x : U, `D}{`a}{T'}{T} `^ \ip{t}{\GD}[`r] `=
  `a[\ip{t}{`G, x : U, `D}]\]
  
  Par substitutivité de la coercion, il existe $`a' `=
  `a[\ip{u}{`G}/x]$ telle que
  $\subimpl{\Gr}{`a'}{T'[u/x]}{T[u/x]}$. 

  On a donc, par substitutivité de l'équivalence:
  \[\ip{t}{\GD}[c[x]/x][\ip{u}{`G}/x] `= `a'[\ip{t}{`G, x : U,
    `D}][\ip{u}{`G}/x]\]
  
  Comme $x `; \freevars{`a'}$, on a $`a'[\ip{t}{`G, x : U,
    `D}][\ip{u}{`G}/x] = `a'[\ip{t}{`G, x : U,`D}[\ip{u}{`G}/x]]$.

  Soit, par application du lemme de stabilité par substitution:
  \[\ip{t}{\GD}[c[\ip{u}{`G}]/x] `= `a'[\ip{t[u/x]}{`G, `D[u/x]}]\]
  
  On a donc bien construit la coercion $`a'$ recherchée.
\end{proof}

On définit l'équivalence typée figure \ref{fig:teq-rules}.

\teqfig

On a la propriété suivante:
\begin{definition}[Equivalence typée]
  Si $\talgo{`G}{t}{T}$, $\talgo{`G}{u}{U}$, alors
  $\teq{`G}{t}{T}{u}{U}$~\ssi~$t \eqbr u$ et $T \sub U$.
\end{definition}

\begin{proof}
  De gauche à droite, c'est trivial.
\end{proof}

\begin{theorem}[Conservation de l'équivalence]
  \label{interp-eq}
  Si $\talgo{`G}{t}{T}$, $\talgo{`G}{u}{U}$, $t \eqbr u$ et $T \sub U$ alors
  il existe $`a$, $`a[\ip{t}{`G}] `= \ip{u}{`G}$ où $\subimpl{`G}{`a}{T}{U}$.
\end{theorem}

\begin{proof}
  Par induction sur la dérivation de $\teq{`G}{t}{T}{u}{U}$.

  \begin{induction}
    \case{Transitivity}
      On a $\teq{`G}{t}{T}{v}{V}$ et $\teq{`G}{v}{V}{t}{T}$, donc par
      induction, il existe $`a, `b$ telles que:
      $`a[\ip{t}{`G}] `= \ip{v}{`G}$ et $`b[\ip{v}{`G}] `= \ip{u}{`G}$
      où $\subimpl{`G}{`a}{T}{V}$ et $\subimpl{`G}{`b}{V}{U}$. Par
      transitivité de la coercion il existe $c `= `b `o `a$ telle que
      $\subimpl{`G}{c}{T}{U}$. Clairement, $c[\ip{t}{`G}] `=
      `b[`a[\ip{t}{`G}]] `= `b[\ip{v}{`G}] `= \ip{u}{`G}$.
      
    \case{Symetry}
      On a $\teq{`G}{u}{U}{t}{T}$. Par induction, il existe $`a$,
      $`a[\ip{u}{`G}] `= \ip{t}{`G}$ et $\subimpl{`G}{`a}{U}{T}$.
      Par symmétrie de la coercion, il existe $c `= `a^{-1}$,
      $\subimpl{`G}{c}{T}{U}$ et $c `o `a `= `a `o c `= \ctxdot$.
      On a donc $c[`a[\ip{u}{`G}]] `= \ip{u}{`G} `=
      `a^{-1}[\ip{t}{`G}]$. 
      Par symétrie de l'équivalence, on obtient le résultat désiré:
      $`a^{-1}[\ip{t}{`G} `= \ip{u}{`G}$. 
      
    \case{Reflexivity}
      On a $\teq{`G}{t}{T}{t}{T}$. Par réflexivité de la coercion, c'est
      trivial.
      
    \case{BetaTeq}
      On a $\ip{(\lambda x : X.v)~e}{`G} = (\lambda x : \ip{X}{`G}.\ip{v}{`G, x :
        X})~c[\ip{e}{`G}] "->"_\beta \ip{v}{`G, x : X}[c[\ip{e}{`G}]/x]$
      où $\talgo{`G}{e}{E}$, $\subimpl{`G}{c}{X}{E}$.
      On doit montrer qu'il existe $`a$ tel que 
      $\ip{v}{`G, x : X}[c[\ip{e}{`G}]/x] `= `a[\ip{v[e/x]}]$.
      Par inversion de $\talgo{`G}{(\lambda x : X.v)~e}{T}$ on a 
      $\talgo{`G, x : X}{v}{V}$ tel que $V[e/x] = T$.

      On applique lemme de substitution et coercion
      \ref{coerce-subst-and-coercion} avec $\talgo{`G}{e}{E}$,
      $\subimpl{`G}{c}{X}{E}$ et cette dérivation. On obtient:
      $`a[\ip{v[e/x]}{`G} `= \ip{v}{`G, x : X}[c[\ip{e}{`G}]/x]$, soit
      le résultat désiré.

    \case{PiLeftTeq}
      On a $\ip{\pi_1~\pair{\Sigma x : T.V}{e_1}{e_2}}{`G} \eqdef
      \pi_1~\ip{\pair{\Sigma x : T.V}{e_1}{e_2}}{`G} =
      \pi_1~\pair{\ip{\Sigma x : T.V}{`G}}{\ip{e_1}{`G}}{\ip{e_2}{`G}}
      "->"_{\pi_1} \ip{e_1}{`G}$. On peut donc prendre
      $\subimpl{`G}{`a}{T}{U}$.
      
      
      
      
    

      
      Par inversion du jugement $\talgo{`G}{(\lambda x : X.v)~e}{T}$
      on a $\talgo{`G, x : X}{v}{V}$ où $T = V[e/x]$.
      On applique
      l'hypothèse d'induction pour obtenir $\ip{v}{`G, x : X}[c] `=
      `a[\ip{v}{`G, x : U}]$ en utilisant la coercion de contexte
      $\ctxdot, \ldots, c : (`G, x : U) \sub (`G, x : V)$. La coercion
      $`a$ est équivalente à l'identité car elle part de la sorte $s$.
      On a donc: $\ip{e}{`G, x : V}[c] `= \ip{e}{`G, x : U}$. Par
      substitutivité dans \CCI{} on obtient:
      \[\ip{e}{`G, x : V}[c[x]/x][\ip{u}{`G}/x] `= \ip{e}{`G, x :
        U}[\ip{u}{`G}/x]\]
      Soit:
      \[\ip{e}{`G, x : V}[c[\ip{u}{`G}]/x] `= \ip{e}{`G, x :
        U}[\ip{u}{`G}/x]\]
      Enfin par le lemme de stabilité par substitution
      \ref{coerce-subst}, on obtient:
      \[\ip{e}{`G, x : V}[c[\ip{u}{`G}]/x] `= \ip{e[u/x]}{`G}\]
      
      On a donc bien $\ip{(\lambda x : V.e)~u}{`G} `=
      \ip{e[u/x]}{`G}$.


    \end{induction}
    



%   Il suffit de prouver que si $T "->"_{\beta} T'$ alors $\ip{T}{`G}
%   `= \ip{T'}{`G}$.

%   \begin{induction}
%     \case{PropSet} On a $T = s = \ip{T}{`G}$, on doit donc montrer que
%     $\ip{T'}{`G} `= s$. 
%     Par induction sur la dérivation de $T'$.
%     Si $T'$ est une sorte c'est direct. $T'$ ne peut pas être une
%     variable, un type $\Pi, \Sigma, \{|\}$ ni une abstraction ou une
%     paire. Il ne reste que les redex.
    
%     Si $T' : s$ est dérivé par \irule{App}, alors $W[u/x] = s$ donc $u =
%     s$ ou $W = s$. Dans le premier cas, on aurait une dérivation de $`G
%     \typea s : U$ et $`G \typec U : s'$, ce qui est impossible.
%     Dans le second cas, on a:
%     $`G \typea \Pi x : V.s : s_3$. Par inversion, $`G \typea V : s_1$,
%     $`G, x : V \typea s : s_2$ et $(s_1, s_2, s_3) `: \mathcal{R}$. Or
%     $s_2$ ne peut être que $\Type$, donc c'est impossible.
    
%     \case{Var} On a alors $T' \eqbr x$ et $`G \typea x : s : s'$ par
%     inversion du jugement de bonne formation.
%     Encore une fois seuls les jugement sur les rédex s'appliquent.


%     \case{App} 
%     Si $f~u$ est de la forme $(\lambda x : V.e)~u$ alors on a
%     $\ip{f~u}{`G} = (\lambda x : \ip{V}{`G}.\ip{e}{`G, x :
%       V})~c[\ip{u}{`G}] "->"_\beta \ip{e}{`G, x : V}[c[\ip{u}{`G}]/x]$
%     où $\subimpl{`G}{c}{U}{V}$. 
%     Supposons $T' = e[u/x]$, alors $\ip{T'}{`G} = \ip{e[u/x]}{`G}$.
%     Par inversion du jugement $\subimpl{`G}{\lambda x : V.e}{\Pi x :
%       V.W}$ on a $\subimpl{`G, x : V}{e}{W = s}$. On applique
%     l'hypothèse d'induction pour obtenir $\ip{e}{`G, x : V}[c] `=
%     `a[\ip{e}{`G, x : U}]$ en utilisant la coercion de contexte
%     $\ctxdot, \ldots, c : (`G, x : U) \sub (`G, x : V)$. La coercion
%     $`a$ est équivalente à l'identité car elle part de la sorte $s$.
%     On a donc: $\ip{e}{`G, x : V}[c] `= \ip{e}{`G, x : U}$. Par
%     substitutivité dans \CCI{} on obtient:
%     \[\ip{e}{`G, x : V}[c[x]/x][\ip{u}{`G}/x] `= \ip{e}{`G, x :
%       U}[\ip{u}{`G}/x]\]
%     Soit:
%     \[\ip{e}{`G, x : V}[c[\ip{u}{`G}]/x] `= \ip{e}{`G, x :
%       U}[\ip{u}{`G}/x]\]
%     Enfin par le lemme de stabilité par substitution
%     \ref{coerce-subst}, on obtient:
%     \[\ip{e}{`G, x : V}[c[\ip{u}{`G}]/x] `= \ip{e[u/x]}{`G}\]

%     On a donc bien $\ip{(\lambda x : V.e)~u}{`G} `=
%     \ip{e[u/x]}{`G}$.
    
%     Si $T = f~u'$ où $u `= u'$, alors:
%     $\ip{T} = (\pi_F[f])~(c[\ip{u}{`G}])$ et $\ip{T'} = (\pi_F[f])~(c'[\ip{u'}{`G}])$. 
%     On doit montrer que $c[\ip{u}{`G}] `= c'[\ip{u'}{`G}]]$. 
%     \Problem{Analyser tout les cas possibles ?}
%   \end{induction}
\end{proof}

On peut maintenant montrer notre théorème de correction.

\setboolean{displayLabels}{false}
\begin{theorem}[Correction de l'interprétation]
  \label{correct-interp}
  Si $\talgo{`G}{t}{T}$ alors on a $\tcoq{\iG}{\ip{t}{\iG}}{\ip{T}{\iG}}$.
  Si $\wf `G$ alors $\wf \iG$.
  Si $\talgo{`G}{T, U}{s}$ et $T \suba U$ alors il existe $c$,
  $\subimpl{`G}{c}{T}{U}$ et $\tcoq{\iG}{\lambda x :
    \ip{T}.c[x]}{\ip{T}{`G} "->" \ip{U}{`G}}$.
\end{theorem}

\begin{proof}
  Par induction mutuelle sur les dérivations de typage, bonne
  formation et coercion.

  \begin{induction}
    \case{WfEmpty} Trivial.

    \case{WfVar}
    Par induction $\iG \typec \ip{A}{\iG} :
    \ip{s}{\iG}$. Par inversion du jugement de bonne formation
    dans \CCI{}, $\typewf \iG$.
    Or, $\ip{s}{\iG} = s$ ($s `: \{ \Prop, \Set, \Type \}$), donc 
    on peut appliquer \irule{WfVar} dans \CCI{} pour obtenir:
    $\wf \iG, x : \ip{A}{\iG}$, soit $\wf \ipG{`G, x : A}$.

    \case{PropSet}
    Direct par induction, $\iG \typec \ip{s}{\iG} = s :
    \ip{\Type}{\iG} = \Type$. 
    
    \case{Var} On a:
    \begin{prooftree}
      \Var
    \end{prooftree}
    Par induction, $\wf \iG$ et par simple inspection de la
    définition de l'interprétation des contextes, si $x : A `: `G$ alors
    $x : \ip{A}{`D} `: \iG$ pour $`D ``( `G$. Par affaiblissement
    dans \CCI{}, on obtient aisément $\tcoq{\iG}{x}{\ip{A}{`D}}$ 
    à partir de  $\tcoq{\ipG{`D}}{x}{\ip{A}{`D}}$. Or il est clair par
    la définition de l'interprétation que $\ip{A}{`D} = \ip{A}{`G}$  
    puisque les variables libres de $A$ sont strictement contenues dans $`D$.

    \case{Prod} On a:
    \begin{prooftree}
      \Prod
    \end{prooftree}
    
    Par induction $\tcoq{\iG}{\ip{T}{\iG}}{\ip{s_1}{\iG} = s_1}$ et 
    $\tcoq{\ipG{`G, x : T}}{\ip{U}{\ipG{`G, x : T}}}{\ip{s_2}{\ipG{`G, x : T}} = s_2}$.
    On déplie l'interprétation pour obtenir:
    $\tcoq{\iG, x : \ip{T}{`G}}{\ip{U}{`G, x : T}}{s_2}$.
    
    Par \irule{Prod} dans \CCI, on obtient:
    $\tcoq{\iG{}}{\Pi x : \ip{T}{`G}. \ip{U}{`G, x : T}}{s_3}$.
    Or $\ip{\Pi x : T.U}{`G} = \Pi x : \ip{T}{`G}. \ip{U}{`G, x : T}$, donc on a bien:
    $\tcoq{\iG}{\ip{\Pi x : T.U}{`G}}{s_3 = \ip{s_3}{`G}}$.

    \case{Abs} On a:
    \begin{prooftree}
      \Abs
    \end{prooftree}
    
    Par induction $\tcoq{`G}{\ip{\Pi x : T.U}{`G}}{\ip{s}{`G}}$
    et $\tcoq{\ipG{`G, x : T}}{\ip{M}{\ipG{`G, x : T}}}{\ip{U}{\ipG{`G, x : T}}}$.
    On déplie l'interprétation pour obtenir:
    $\tcoq{\iG, x : \ip{T}{`G}}{\ip{M}{`G, x : \ip{T}{\iG}}}{\ip{U}{\ipG{`G, x : T}}}$.
    
    Par \irule{Abs} dans \CCI, on obtient:
    $\tcoq{\iG}{\lambda x : \ip{T}{`G}. \ip{M}{`G, x : T}}{\ip{\Pi x : T.U}{`G}}$.
    C'est équivalent à:
    $\tcoq{\iG}{\ip{\lambda x : T.U}{`G}}{\ip{\Pi x : T.U}{`G}}$.
    
    \case{App} On a:
    \begin{prooftree}
      \AppA
    \end{prooftree}

    C'est le cas intéressant puisqu'on ajoute ici des coercions.
    Par induction, $\tcoq{\iG}{\ip{f}{\iG}}{\ip{T}{`G}}$,
    $\tcoq{\iG}{\ip{u}{`G}}{\ip{U}{`G}}$ et
    $\tcoq{\iG}{\ip{U}{`G}, \ip{V}{`G}}{\ip{s'}{`G} = s'}$.
    
    On procéde par étapes: d'abord la construction d'une fonction
    $\tcoq{\iG}{\pi[\ip{f}{`G}]}{\ip{\Pi x : V.W}{`G}}$ puis la construction de
    l'argument $\tcoq{\iG}{c[\ip{u}{`G}]}{\ip{V}{`G}}$. On a ces deux
    résultats par application de l'hypothèse de récurrence pour les coercions.
    On n'a plus qu'à les appliquer pour obtenir le jugement:
    $\tcoq{\iG}{\ip{f~u}{`G}}{\ip{W}{`G, x : V}[c[u]/x]}$.
    Par le lemme \ref{coerce-subst-and-coercion}, on a
    $\ip{W}{`G, x : V}[c[u]/x] `= \ip{W[u/x]}{`G}$ puisque les coercions de sorte à sorte ne peuvent
    être que l'identité. On peut donc déduire:
    $\tcoq{\iG}{\ip{f~u}{`G}}{\ip{W[u/x]}{`G}}$ par \irule{Conv}.

  \item[-- \irule{Sigma}, \irule{Sum}, \irule{LetSum}, \irule{Subset}:]
    Direct par induction ou un raisonnement similaire à \irule{App}.
    
  \case{SubConv}
  Par le lemme \ref{interp-eq} on a $\ip{T}{`G} `= \ip{U}{`G}$, on peut
  donc dériver:
  \begin{prooftree}
    \AXC{$\tcoq{\iG}{t}{\ip{T}{`G}}$}
    \AXC{$\ip{T}{`G} `= \ip{U}{`G}$}
    \BIC{$\tcoq{\iG}{c[t] = t}{\ip{U}{`G}}$}
  \end{prooftree}
  
  \case{SubHnf}
  Par induction on a $\tcoq{\iG}{t}{\ip{\hnf{T}}{`G}} "=>"
  \tcoq{\iG}{c[t]}{\ip{\hnf{U}}{`G}}$.
  A l'aide du lemme \ref{interp-eq} on peut dériver:
  \begin{prooftree}
    \AXC{$\tcoq{\iG}{t}{\ip{T}{`G}}$}
    \AXC{$\ip{T}{`G} `= \ip{\hnf{T}}{`G}$}
    \BIC{$\tcoq{\iG}{t}{\ip{\hnf{T}}{`G}}$}
    \UIC{$\tcoq{\iG}{c[t]}{\ip{\hnf{U}}{`G}}$}
    \AXC{$\ip{\hnf{U}}{`G} `= \ip{U}{`G}$}
    \BIC{$\tcoq{\iG}{c[t]}{\ip{U}{`G}}$}
  \end{prooftree}
  
  \case{SubProd} On a:
  \begin{prooftree}
    \SubProdI
  \end{prooftree}
  
  Supposons $\tcoq{\iG}{t}{\ip{\Pi x : T.V}{`G}}$. Alors $c[t] = \lambda
  x : \ip{U}{`G}.c_2[t~c_1[x]]$.
  
  Par induction, $\tcoq{\ipG{G, x : U}}{c_1[x]}{\ip{T}{`G}}$, donc par
  \irule{App}, $\tcoq{\ipG{G, x : U}}{t~c_1[x]}{\ip{V}{`G, x :
      T}[c_1[x]/x]}$. 
  Par stabilité par affaiblissement (\ref{coerce-narrowing-term}), 
  $\ip{V}{`G, x : T}[c_1[x]/x] `= \ip{V}{`G, x : U}$. On peut donc
  dériver par \irule{SubConv}:
  \[\tcoq{\ipG{G, x : U}}{t~c_1[x]}{\ip{V}{`G, x : V}}\] 
  
  Par induction, $\tcoq{\ipG{G, x : U}}{c_2[t~c_1[x]]}{\ip{W}{`G}}$,
  donc par \irule{Abs}, \[\tcoq{\iG}{\lambda x :
    \ip{U}{`G}. c_2[t~c_1[x]]}{\ip{\Pi x : U.W}{`G}}\]
  
  \case{SubSigma} On a:
  \begin{prooftree}
    \SubSigmaI
  \end{prooftree}
  
  Ici, $c[t] = \pair{\ip{\Sigma x : U.W}{`G}}{c_1[\pi_1~t]}{c_2[\pi_1~t/x][\pi_2~t]}$.
  Par application des règles de typage pour les projections:
  $\tcoq{\iG}{\pi_1~t}{\ip{T}{`G}}$ et $\tcoq{\iG}{\pi_2~t}{\ip{V}{`G, x
      : T}[\pi_1~t/x]}$.
  
  Par induction on obtient $\tcoq{\iG}{c_1[\pi_1~t]}{\ip{U}{`G}}$.
  Par induction on a aussi
  $\tcoq{\ipG{`G, x : T}}{\lambda y : \ip{V}{`G}.c_2[\pi_2~y]}{\ip{V}{`G} "->"
    \ip{W}{`G}}$, où $y$ n'apparait pas dans $c_2$.

  Par affaiblissement, on passe dans l'environnement $`G, t : \Sigma x :
  T.V, x : T$:
  \[\tcoq{\ipG{`G, t : \Sigma x : T.V, x : T}}
  {\lambda y : \ip{V}{`G}.c_2[\pi_2~y]}
  {\ip{V}{`G} "->" \ip{W}{`G}}\]

  On peut alors substituer pour obtenir:
  $\tcoq{\ipG{`G, t : \Sigma x : T.V}}{\lambda y :
    \ip{V}{`G}[\pi_1~t/x].c_2[\pi_1~t/x][\pi_2~y]}
  {\ip{V}{`G}[\pi_1~t/x] "->" \ip{W}{`G}[\pi_1~t/x]}$.
  
  Enfin on applique à $\pi_2~t$ pour obtenir:
  $\tcoq{\ipG{`G, t : \Sigma x : T.V}}
  {c_2[\pi_1~t/x][\pi_2~t]}{\ip{W}{`G}[\pi_1~t/x]}$.

  On a bien:
  \[\tcoq{\iG}{\lambda t : \ip{\Sigma x : T.V}{`G}.~\pair{\ip{\Sigma x :
        U.W}{`G}}
    {c_1[\pi_1~t]}{c_2[\pi_1~t/x][\pi_2~t]}}
  {\ip{\Sigma x : T.V}{`G} "->" \ip{\Sigma x : U.W}{`G}}\]
  
  \case{SubProof} On a:
  \begin{prooftree}
    \SubProofI
  \end{prooftree}
  
  Par induction, $\tcoq{\iG}{\lambda x :
    \ip{T}{`G}. c[x]}{\ip{T}{`G}} "->" {\ip{U}{`G}}$ et
  $\tcoq{\iG}{\mysubset{x}{\ip{U}{`G}}{\ip{P}{`G, x : U}}}{\Set}$.
  
  On a donc clairement:
  \[\tcoq{\iG}{\lambda t : \ip{T}{`G}.
    \elt{\ip{U}{`G}}{\ip{\lambda x : U.P}{`G}}{c[t]}
    {\ex{\iG}{\ip{P}{`G, x : U}[c[t]/x]}}}
  {\ip{T}{`G} "->" \ip{\mysubset{x}{U}{P}}{`G}}\]
      
  \case{SubSub} On a:
  \begin{prooftree}
    \SubSubI
  \end{prooftree}
  
  Par induction, $\tcoq{\iG}{\lambda x : \ip{U}{`G}.
    c[x]}{\ip{U}{`G} "->" \ip{T}{`G}}$, on a bien:

  \[\tcoq{\iG}{\lambda t :
    \ip{\mysubset{x}{U}{P}}{`G}.c[\eltpit~t]}{\ip{\mysubset{x}{U}{P}}{`G} "->" \ip{T}{`G}}\]
  
  \end{induction}
\end{proof}

%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "subset-typing"
%%% LaTeX-command: "TEXINPUTS=\"style:$TEXINPUTS\" latex"
%%% End: 
