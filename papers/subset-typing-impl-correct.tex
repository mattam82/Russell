\def\iu{\ip{u}{\iG}}
\def\tux{\ip{t[u/x]}{`G, `D[u/x]}}
\def\cux{[c~\ip{u}{`G}/x]}
\def\tcux{\ip{t}{\ipG{`G, x : V, `D}}[c~\ip{u}{`G}/x]}
\def\GD{`G, x : V, `D}
\def\Gr{`G, `D[u/x]}
\def\iGD{\ipG{`G, x : V, `D}}
\def\iGr{\ipG{`G, `D[u/x]}}

Il nous faut tout d'abord un lemme supplémentaire sur la substitution
dans le système algorithmique:

\begin{lemma}[Substitutivité du typage algorithmique avec coercion]
  \label{subst-coerce-algo}
  \[\left.\begin{array}{l}
      `G \typea u : U \\
      \GD \typea t : T \\ 
      U \suba V
    \end{array}
\right\} "=>"    
`G, `D[u/x] \typea t[u/x] : T' \suba T[u/x]
    \]
\end{lemma}

\begin{proof}
  Par induction sur la dérivation de $\GD \typea t : T$.
  
  \typenva
  \begin{induction}
    \case{Var} On a deux cas:
    \begin{itemize}
    \item Si $y = x$, alors $T = V$. On a $t[u/x] = u$ donc $T' =
      U$. Par hypothèse $U \suba V$ donc $T' \suba T[u/x]$ triviallement
      ($x$ n'apparait pas dans $V$).

    \item Sinon, $t[u/x] = y$ donc $T' = T[u/x]$ et on a $T' \suba T[u/x]$
      par réflexivité de la coercion.
    \end{itemize}
    

    \case{Prod}
    Par induction, $\Gr \typea T[u/x] : s_1' \suba s_1[u/x]$ et $\Gr, x
    : T[u/x]
    \typea U[u/x] : s_2' \suba s_2[u/x]$. Or $s_1[u/x] = s_1$ et
    $s_2[u/x] = s_2$. On en déduit par \irule{Prod}: 
    $\Gr \typea (\Pi x : T.U)[u/x] : s_3 \suba s_3[u/x]$.

    \case{Abs}
    On a: 
    \begin{prooftree}
      \Abs
    \end{prooftree}
    
    Par induction, $\Gr \typea (\Pi y : T.U)[u/x] : s' \suba s[u/x]$ et
    $\Gr, y : T[u/x] \typea M[u/x] : U' \suba U[u/x]$.
    Par le même raisonnement que précedemment, $s' = s[u/x] = s$.
    On peut appliquer \irule{Abs} pour obtenir:
    $\Gr \typea (\lambda y : T.M)[u/x] : \Pi y : T[u/x].U'$. Comme $U'
    \suba U[u/x]$ on a $\Pi y : T[u/x].U' \suba \Pi y : T[u/x].U[u/x]$
    et la propriété est vérifiée.

    \case{App}
    On a: 
    \begin{prooftree}
      \TAX{App}
      {$\GD \seq f : F \quad \mualgo(F) = \Pi y : A. B$}
      {$\GD \seq e : E \quad \GD \seq E, A : s$}
      {$E \sub A $}
      {$\GD \seq (f~e) : B[ e / y ]$}
      {}
    \end{prooftree}
    
    Par induction, $\Gr \typea f[u/x] : F' \suba F[u/x]$ et $\Gr \typea
    e[u/x] : E' \suba E[u/x]$ et $\Gr \typea E[u/x], A[u/x] : s$.
    Comme $\mualgo(F) = \Pi y : A.B$, $\mualgo(F[u/x]) = \Pi y :
    A[u/x].B[u/x]$ et par transitivité de la coercion, $F' \suba \Pi y :
    A[u/x].B[u/x]$. On en déduit que $\mualgo(F') = \Pi y : A'.B'$ avec
    $A[u/x] \suba A'$ et $B' \suba B[u/x]$.
    Par substitutivité de la coercion, $E \suba A$ implique $E[u/x]
    \suba A[u/x]$. On applique la transitivité pour obtenir $E' \suba
    A'$. Par définition, si $E' \suba E[u/x]$ et $\Gr \typea E[u/x] : s$
    alors $\Gr \typea E' : s$. De même pour $A'$.  

    On peut donc appliquer \irule{App}:    
    \begin{prooftree}
      \TAX{App}
      {$\GD \seq f[u/x] : F' \quad \mualgo(F') = \Pi y : A'. B'$}
      {$\GD \seq e[u/x] : E' \quad \GD \seq E', A' : s$}
      {$E' \sub A' $}
      {$\GD \seq (f~e)[u/x] : B'[ e[u/x] / y ]$}
      {}
    \end{prooftree}
    
    Par substitutivité de la coercion, $B' \suba B[u/x]$ implique
    $B'[e[u/x]/y] \suba B[u/x][e[u/x]/y]$. Or $B[u/x][e[u/x]/y] =
    B[e/y][u/x]$ car $y$ n'apparait pas dans $u$. On a donc bien
    $T' = B'[e[u/x]/y] \suba T[u/x] = B[e/y][u/x]$.
     
    \item[] Les autres cas passent aisément par induction.
  \end{induction}
  

\end{proof}



\begin{lemma}[Substitution et coercion]
  Si $`G \typea u : U$ et $`G \typec c : U \suba V$ alors
  \[\GD \typea t : T "=>"
  \begin{array}{l}  
    `E!`a, \Gr \typec `a : \typeafn{\Gr}{t[u/x]} \suba T[u/x],\\
    `a \ip{t[u/x]}{\Gr} \eqbr \ip{t}{\GD}\cux
  \end{array}\]
\end{lemma}


\begin{proof}
  Ici, $\typeafn{\Gr}{t[u/x]}$ est l'égal du $T'$ du lemme précédent, il
  est donc uniquement déterminé par l'algorithme de typage ce qui
  entraine que $`a$ est unique.
  
  Si $\talgo{\GD}{t}{T}$, alors soit $`r$ la coercion de contextes
  $\ctxdot, \ldots, c, \ctxdot, \ldots : (`G, x : U, `D) \typec (`G, x
  : V, `D)$. Par le lemme \ref{narrowing-i-term}, on a
  $\talgo{`G, x : U, `D}{t}{T'}$ et il existe $`a$, 
  \[\subimpl{`G, x : U, `D}{`a}{T'}{T} `^ \ip{t}{\GD}[`r] \eqbres
  `a[\ip{t}{`G, x : U, `D}]\]
  
  Par substitutivité de la coercion, il existe $`a' \eqbres
  `a[\ip{u}{`G}/x]$ telle que
  $\subimpl{\Gr}{`a'}{T'[u/x]}{T[u/x]}$. 

  On a donc, par substitutivité de l'équivalence:
  \[\ip{t}{\GD}[c[x]/x][\ip{u}{`G}/x] \eqbres `a'[\ip{t}{`G, x : U,
    `D}][\ip{u}{`G}/x]\]
  
  Soit, par application du lemme de stabilité par affaiblissement:
  \[\ip{t}{\GD}[c[\ip{u}{`G}]/x] \eqbres `a'[\ip{t[u/x]}{`G,
    `D[u/x]}]\]
  
  On a donc bien construit la coercion $`a'$ recherchée.
\end{proof}

On peut maintenant montrer notre théorème de correction.

\setboolean{displayLabels}{false}
\begin{theorem}[Correction de l'interprétation]
  \label{correct-interp}
  Si $`G \typea t : T$ alors on a $\iG \typec \ip{t}{\iG} :
  \ip{T}{\iG}$.
  Si $\wf `G$ alors $\wf \iG$.
\end{theorem}

\begin{proof}
  Par induction mutuelle sur la dérivation de typage ou de bonne
  formation.

  \begin{induction}
    \case{WfEmpty} Trivial.

    \case{WfVar}
    Par induction $\iG \typec \ip{A}{\iG} :
    \ip{s}{\iG}$. Par inversion du jugement de bonne formation
    dans \CCI{}, $\typewf \iG$.
    Or, $\ip{s}{\iG} = s$ ($s `: \{ \Prop, \Set, \Type \}$), donc 
    on peut appliquer \irule{WfVar} dans \CCI{} pour obtenir:
    $\wf \iG, x : \ip{A}{\iG}$, soit $\wf \ipG{`G, x : A}$.

    \case{PropSet}
    Direct par induction, $\iG \typec \ip{s}{\iG} = s :
    \ip{\Type}{\iG} = \Type$. La deuxième condition est directe
    par définition de l'interprétation.
    
    \case{Var} On a:
    \begin{prooftree}
      \Var
    \end{prooftree}
    Par induction, $\wf \iG$ et par simple inspection de la
    définition de l'interprétation des contextes, si $x : A `: `G$ alors
    $x : \ip{A}{`D} `: \iG$ pour $`D ``( `G$. Par affaiblissement
    dans \CCI{}, on obtient aisément $\iG \typec x : \ip{A}{`D}$ 
    à partir de  $\ipG{`D} \typec x : \ip{A}{\ipG{`D}}$. Or il est clair par
    la définition de l'interprétation que $\ip{A}{`D} = \ip{A}{`G}$  
    si $`G$ est une extension de $`D$ puisqu'on utilise l'environnement
    uniquement au moment de typer les variables et
    $\iG(x) = \ipG{`D}(x)$ pour tout $x$ utilisé dans $A$.
    On a donc $\iG \typec x : \ip{A}{\iG}$.
    La deuxième condition est montrée par $\ip{x}{`G} = \iG(x) = 
    \ip{A}{\ipG{`D}} = \ip{A}{\iG}$.
      
    \case{Prod} On a:
    \begin{prooftree}
      \Prod
    \end{prooftree}
    
    Par induction $\iG \typec \ip{T}{\iG} : \ip{s_1}{\iG}
    = s_1$ et $\ipG{`G, x : T} \typec \ip{U}{\ipG{`G, x : T}} :
    \ip{s_2}{\ipG{`G, x : T}} = s_2$.
    On déplie l'interprétation pour obtenir:
    $\iG, x : \ip{T}{\iG} \typec \ip{U}{\iG{}, x : \ip{T}{\iG}} :
    s_2$.
    
    Par \irule{Prod} dans \CCI, on obtient:
    $\iG{} \typec \Pi x : \ip{T}{\iG}. \ip{U}{\iG{}, x : \ip{T}{\iG}}
    : s_3$.
    Or $\ip{\Pi x : T.U}{\iG} = \Pi x : \ip{T}{\iG}. \ip{U}{\iG{}, x
      : \ip{T}{\iG}}$, donc on a bien:
    $\iG \typec \ip{\Pi x : T.U}{\iG} : s_3 = \ip{s_3}{\iG}$.
    La seconde condition est directe d'après la définition de $\mathcal{R}$ qui
    est une fonction.

    \case{Abs} On a:
    \begin{prooftree}
      \Abs
    \end{prooftree}
    
    Par induction $\iG \typec \ip{\Pi x : T.U}{\iG} : \ip{s}{\iG}$
    et $\ipG{`G, x : T} \typec \ip{M}{\ipG{`G, x : T}} :
    \ip{U}{\ipG{`G, x : T}}$.
    On déplie l'interprétation pour obtenir:
    $\iG, x : \ip{T}{\iG} \typec \ip{M}{\iG{}, x : \ip{T}{\iG}} :
    \ip{U}{\ipG{`G, x : T}}$.
    
    Par \irule{Abs} dans \CCI, on obtient:
    $\iG{} \typec \lambda x : \ip{T}{\iG}. \ip{M}{\iG{}, x : \ip{T}{\iG}}
    : \ip{\Pi x : T.U}{\iG}$.
    C'est équivalent à:
    $\iG \typec \ip{\lambda x : T.U}{\iG} : \ip{\Pi x : T.U}{\iG}$.
    La seconde condition se montre ainsi:
    $\ip{\lambda x : T.M}{\iG} = \Pi x : \ip{T}{\iG}. \ip{M}{\iG, x :
      \ip{T}{\iG}}$. Or par induction, 
    $\ip{M}{\iG, x : \ip{T}{\iG}} = \ip{U}{\iG, x : \ip{T}{\iG}}$, donc 
    $\ip{\lambda x : T.M}{\iG} = \Pi x : \ip{T}{\iG}. \ip{U}{\iG, x :
      \ip{T}{\iG}} = \ip{\Pi x : T.U}{\iG}$.
    
    \case{App} On a:
    \begin{prooftree}
      \AppA
    \end{prooftree}

    C'est le cas intéressant puisqu'on ajoute ici des coercions.
    Par induction, $\iG{} \typec \ip{f}{\iG} : \ip{T}{\iG}$,
    $\iG{} \typec \ip{u}{\iG} : \ip{U}{\iG}$,
    $\iG{} \typec \ip{U}{\iG}, \ip{V}{\iG} : \ip{s}{\iG}$.
    
    On procéde par étapes: d'abord la construction d'une fonction
    $\pi \ip{f}{\iG} : \ip{\Pi x : V.W}{\iG}$ puis la construction de
    l'argument $c \ip{u}{\iG} : \ip{V}{\iG}$. On n'a plus qu'à les
    appliquer pour obtenir le jugement:
    $\iG{} \typec \ip{f~u}{\iG} : \ip{W}{\iG, x :
      \ip{V}{\iG}}[c~u/x]$.
    Par substitutivité de l'interprétation, on a
    $\ip{W}{\iG, x : \ip{V}{\iG}}[c~u/x] \eqbr
    \ip{W[u/x]}{\iG}$ puisque les coercions de sorte à sorte ne peuvent
    être que l'identité. On peut donc déduire:
    $\iG{} \typec \ip{f~u}{\iG} : \ip{W[u/x]}{\iG}$ par \irule{Conv}.

    \item[- \irule{Sigma}, \irule{Sum}, \irule{LetSum}, \irule{Subset}:]
      Direct par induction ou un raisonnement similaire à \irule{App}.      
  \end{induction}
\end{proof}

%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "subset-typing"
%%% LaTeX-command: "TEXINPUTS=\"style:$TEXINPUTS\" latex"
%%% End: 
