\subsection{Coercions explicites}
On définit le système $\subi$ (figure \ref{fig:subti})
qui dérive une coercion à partir de deux types $S$ et $T$ dans un environnement $`G$.
On a introduit du déterminisme par rapport au jugement de
coercion algorithmique puisqu'on donne priorité à la règle
\irule{SubSub} par rapport à la règle \irule{SubProof} (ces règles sont
confluentes). On explicite aussi la prioritée donnée à la mise en forme
normale de tête (figure \ref{fig:hnfdef}) puis à la dérivation
par rapport au test de
conversion dans la prémisse de \irule{SubConv}.

Notre opération de mise en forme normale de tête est définie de la façon suivante:
\begin{figure}[h]
  \[\begin{array}{lcl}
    \hnf{((\lambda x : T.e)~v)} & = & \hnf{e[v/x]} \\
    \hnf{x} & = & x
  \end{array}\]
  \caption{Définition de la forme normale de tête}
  \label{fig:hnfdef}
\end{figure}

On utilise la $\beta$-équivalence de $CCI$ enrichi avec les
existentielles, on étend donc la relation aux existentielles de la façon
suivante: $\ex{`G}{P} \eqbi \ex{`G'}{P'} `= `G \eqbi `G' `^ P \eqbi P'$.

%\coerceFig
\subtiFig


\begin{lemma}[Coercion et conversion dans le contexte]
  \label{coercion-conversion-ctx-impl}
  Si $`G, x : V, `D \typec c : S \subi T$ et $V \eqbi V'$ alors
  $`G, x : V', `D \typec c' : S \subi T$ et $c \eqbi c'$.
\end{lemma}
\begin{proof}
  Par induction sur la dérivation de coercion. Tout les cas passent par
  induction sauf \irule{SubConv} qui n'utilise pas $`G$ en prémisse donc
  ne pose pas de problème. Le seul cas intéressant est \irule{SubProof}
  qui utilise la $\beta$-équivalence sur les existentielles.
\end{proof}

On conserve les propriétés suivantes sur la coercion:
\def\subhnf{\subihnf}
\begin{lemma}[Coercion et conversion]
  \label{coercion-conversion-impl}
  Si $`G \typea S,T,U,V : s$, $S \eqbi T$, $U \eqbi V$ et
  $`G \typec c : T \sub U$ alors $`G \typec c' : S \sub V$ avec 
  $c \eqbi c'$. Les dérivations sont de même taille.
\end{lemma}

\begin{proof}
  Par simple inspection des règles on voit que le jugement ne peut
  distinguer deux termes $\beta$-équivalents (ils ont forcément des
  formes normales de tête équivalentes). On en déduit que la dernière
  règle appliquée dans le jugement $T \sub U$ est la seule règle
  applicable à $S \sub V$.

  Par induction sur la dérivation dans $\sub$.
   
  \begin{induction}
    \case{SubHnf}\quad
    Comme $S \eqbi T$, $S \eqbi \hnf{T}$. 
    De même comme $U \eqbi V$, $\hnf{U} \eqbi V$.
    On a l'hypothèse $\hnf{T} \sub \hnf{U}$ donc
    par induction on a $c' : \hnf{S} \sub \hnf{V}$ avec $c' \eqbi c$. 
    On dérive bien $`G \typec c' : S \sub V$ avec $c' \eqbi c$ par \irule{SubHnf}. 
    
    \case{SubConv}\quad
    On a  $S \eqbi T$, $T \eqbi U$ et $U \eqbi V$ donc $S \eqbi V$ par transitivité
    de la $\beta$-équivalence. On a donc $c' = \lambda x : S.x
    \eqbi \lambda x : T.x$. C'est la seule règle applicable pour dériver
    le jugement $S \sub V$, sinon on aurait des symboles de tête
    différents pour deux termes $\beta$-équivalents. 

    \case{SubProd}\quad
    Soit $T = \Pi x : A.B$ et $U = \Pi x : C.D$.
    On a $\subimpl{`G}{c_1}{A}{C}$ et $\subimpl{`G, x : C}{c_2}{B[c_1~x/x]}{D}$
    Or si $S \eqbi \Pi x : A.B$ et $\Pi x : C.D \eqbi V$ alors $\hnf{S}
    = \Pi x : A'.B'$ avec $A \eqbi A'$ et $B \eqbi B'$ et $\hnf{V} =
    \Pi x : C'.D'$ avec $C \eqbi C'$ et $D \eqbi D'$.
      
    Par induction on a $`G \typec c_1' : C' \sub A'$ avec $c_1'
    \eqbi c_1$. Par hypothèse on a $`G, x : C \typec c_2 : B[c_1~x/x]
    \sub D$. Par induction: $`G, x : C \typec c_2' : B'[c_1'~x/x] \sub
    D'$ avec $c_2' \eqbi c_2$ car $B[c_1~x/x] \eqbi B'[c_1~x/x]$.
    On peut donc déduire $`G, x : C' \typec c_2' : B'[c_1'~x/x] \sub D'$
    par le lemme \ref{coercion-conversion-ctx-impl}. 
    On déduit par
    \irule{SubProd} que $c' : \hnf{S} \sub \hnf{V}$ est
    dérivable. On a bien $c \eqbi c'$ car $c_1' \eqbi c_1$ et $c_2'
    \eqbi c_2$, donc $\lambda f.\lambda x.c_2~(f~(c_1~x)) \eqbi
    \lambda f.\lambda x.c_2'~(f~(c_1'~x))$.

    \case{SubSigma}\quad
    De même par \irule{SubSigma}:
    
    \begin{prooftree}      
      \AXC{$\subimpl{`G}{c_1'}{A'}{C'}$}
      \AXC{$\subimpl{`G, x : A'}{c_2'}{B'}{D'[c_1'~x/x]}$}
      \BIC{$\subimplhnf{`G}{\lambda t : \Sigma x : A'. B'.~\letml~(x, y) = t~\inml~(c_1'~x, c_2'~y)}
        {\Sigma x : A'. B'}{\Sigma x : C'. D'}$}
    \end{prooftree}
 
    \case{SubSub}\quad  
    On a $\hnf{T} = \mysubset{x}{T'}{P}$ donc $\hnf{S} = \mysubset{x}{S'}{P'}$
    avec $T' \eqbi S'$ et $P \eqbi P'$.
    Par hypothèse, $\subimpl{`G}{c}{T'}{U}$, donc par induction,
    $\subimpl{`G}{c'}{S'}{\hnf{V}}$ ($U \eqbi \hnf{V}$) et par \irule{SubSub}, 
    $\subimpl{`G}{c' `o \pi_1}{\mysubset{x}{S'}{P'} = \hnf{S}}{\hnf{V}}$.
    Clairement, $c' `o \pi_1 \eqbi c `o \pi_1$, la propriété est donc
    bien vérifiée.
    
    \case{SubProof}\quad
    On a $U = \mysubset{x}{U'}{P}$.
    De même on obtient:
    \begin{prooftree}
      \UAX{SubProof}
      {$\subimpl{`G}{c'}{\hnf{S}}{V' \eqbi U'}$}
      {$\subimplhnf{`G}
        {\lambda t : \hnf{S}.~\elt{V'}{(\lambda x : V'.P')}{(c'~t)}{?_{P'[c'~t/x]}}}
        {\hnf{S}}{\hnf{V} = \mysubset{x}{V'}{P'}}$}
      {}
    \end{prooftree}

    Encore une fois $c \eqbi c'$ est vérifié car $\ex{`G, t :
      \hnf{S}}{P'[c'~t/x]} \eqbi \ex{`G, x : T}{P[c~t/x]}$.
  \end{induction}
\end{proof}

\begin{lemma}[Coercion et formes normales de tête]
  \label{coercioni-hnf}
  Si $`G \typec c : T \suba U$ alors $`G \typec c' : \hnf{T}~\suba
  \hnf{U}$ avec $c \eqbi c'$ est dérivable par une
  dérivation plus petite ou égale.
\end{lemma}

\begin{proof}
  Par cas sur la dérivation dans le système algorithmique:
  \begin{itemize}
    \case{SubHnf} La mise en forme normale de tête étant idempotente, on
    a la même dérivation.
    \case{SubConv} Trivial.
  \end{itemize}  
\end{proof}

\input{subset-typing-impl-subtyping-subst}


De la même façon que pour la preuve de transitivité de la
coercion algorithmique, on élimine la règle \irule{SubTrans} qui a la
forme:
\begin{prooftree}
  \AXC{$`G \typec c_1 : A \sub B$}
  \AXC{$`G \typec c_2 : B \sub C$}
  \BIC{$`G \typec c_2 `o c_1 : A \sub C$}
\end{prooftree}


\input{subset-typing-impl-subtyping-trans}

\begin{lemma}[Coercion identité]
  Si $`G \typec T : s$ alors il existe $cid_T$,
  $\subimpl{`G}{cid_T}{T}{T}$ et pour tout $t$, $`G \typec t : T$,
  $cid_T t \eqbi t$.
\end{lemma}

\begin{proof}
  Par induction sur la forme de $T$.

  

\end{proof}


On peut maintenant énoncer le lemme de symmétrie:

\begin{lemma}[Symétrie de la coercion]
  \label{subi-sym}
  S'il existe $c$ tel que $`G \typec c : A \subi B$
  alors $`E!c^{-1}, `G \typec c^{-1} : B \subi A$ et $c^{-1} `o c \eqbei
  \sref{id}~A$ et $c `o c^{-1} \eqbei \sref{id}~B$, où
  $\sref{id} \coloneqq \lambda X : Set.\lambda x : X. x$.
\end{lemma}
\begin{proof}
  On sait que le jugement $\subi$ est symmétrique, c'est à dire qu'on a
  l'existence des inverses. On utilise la transitivité pour montrer le
  reste du lemme. Si $\subimpl{`G}{c}{A}{B}$ et
  $\subimpl{`G}{c^{-1}}{B}{A}$ alors il existe $f$ et $f^{-1}$ tel que
  $\subimpl{`G}{f \eqbi c^{-1} `o c}{A}{A}$ et $\subimpl{`G}{f^{-1}
    \eqbi c `o c^{-1}}{B}{B}$. Par unicité des coercions, $f \eqbei \lambda
  x : A.x$ et $f^{-1} \eqbei \lambda x : B.x$. En général $f$ et $f'$
  sont en forme $\eta$-longue et pas l'identité.
\end{proof}

%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "subset-typing"
%%% LaTeX-command: "TEXINPUTS=\"style:$TEXINPUTS\" latex"
%%% End: 
