\begin{lemma}[Unicité de la coercion]
  \label{coerce-unicity}
  Si $`G \typea T, U : s$ alors si $\subimpl{`G}{c}{T}{U}$ et
  $\subimpl{`G}{c'}{T}{U}$ alors $c = c'$.
\end{lemma}

\begin{proof}
  Par induction lexicographique sur la paire de dérivations de $c$ et $c'$.
  Seule la régle \irule{SubHnf} peut s'appliquer n'importe quand. 
  Supposons que la dérivation de $c$ se termine par une application de \irule{SubHnf}.
  Quelque soit la dernière règle appliquée dans la dérivation de $c'$,
  on a $T = \hnf{T}$ et $U = \hnf{U}$. Par induction on a donc $c = c'$.
\end{proof}

On peut donc raisonner comme ceci: si l'on parvient à construire une
dérivation de $\subimpl{`G}{c}{T}{U}$ alors c'est l'unique dérivation
existante.

\begin{lemma}[Réflexivité de la coercion]
  \label{coerce-refl}
  Si $\timpl{`G}{A}{s}$ alors il existe $c$, $\subimpl{`G}{c}{A}{A}$ et
  $c `= \ctxdot$.
\end{lemma}

\begin{proof}
  Par induction sur le nombre de constructeurs $\Pi, \Sigma, \{|\}$ dans
  la forme normale de $A$.

  S'il $\nf{A}$ n'a pas de constructeur $\Pi, \Sigma, \{|\}$ en tête,
  alors $\hnf{A}$ n'en a pas en tête et l'on peut directement appliquer
  \irule{SubConv}.
  
  Sinon, on va appliquer la ou les règles correspondant au constructeur
  en tête. Le cas le plus intéressant est si $\hnf{A}$ est de la forme
  $\mysubset{x}{U}{P}$.
  Alors on a la dérivation:

  \begin{prooftree}
    \AXC{$\subimpl{`G}{c' `= \ctxdot}{U}{U}$}
    \UIC{$\subimpl{`G}{d = c'[\eltpit~\ctxdot]}{U}{U}$}
    \UIC{$\subimpl{`G}{c = \elt{\ip{U}{`G}}{\ip{\lambda x : U.P}{`G}}{d}
        {\ex{\ipG{`G}}{\ip{P}{`G, x : U}[d/x]}}}{\mysubset{x}{U}{P}}{U}$}
    \UIC{$\subimpl{`G}{c}{\hnf{A} = \mysubset{x}{U}{P}}{\mysubset{x}{U}{P}}$}
    \UIC{$\subimpl{`G}{c}{A}{A}$}
  \end{prooftree}

  On obtient la dérivation de $c'$ par induction, puisque $\nf{U}$
  contient strictement moins de constructeurs que $\nf{A}$.

  On a: 
  \begin{eqnarray*}
    c & \eqdef & \elt{\ip{U}{`G}}{\ip{\lambda x : U.P}{`G}}{d}
    {\ex{\ipG{`G}}{\ip{P}{`G, x : U}[d/x]}} \\
    & \eqdef & \elt{\ip{U}{`G}}{\ip{\lambda x : U.P}{`G}}{(\eltpit~\ctxdot)}
    {\ex{\ipG{`G}}{\ip{P}{`G, x : U}[\eltpit~\ctxdot/x]}} \\
    & =_{\sigma} & \elt{\ip{U}{`G}}{\ip{\lambda x : U.P}{`G}}{(\eltpit~\ctxdot)}
    {(\eltpip~\ctxdot)} \\
    & =_{\rho} & \ctxdot
  \end{eqnarray*}

  On utilise ici l'indifférence aux preuves ($\sigma$). Comme $(\eltpip~\ctxdot)$ est
  de type $\ip{P}{`G, x : U}[\eltpit~\ctxdot/x]$ dans un contexte où $\ctxdot$
  est de type $\ip{\mysubset{x}{U}{P}}{`G}$, on peut remplacer directement
  l'existentielle par ce terme. En pratique, ces preuves pourront être
  directement déchargées par l'assistant de preuve.
\end{proof}


\begin{lemma}[Coercion et formes normales de tête]
  \label{coerce-hnf}
  Si $`G \typec c : T \suba U$ alors $`G \typec c' : \hnf{T}~\suba
  \hnf{U}$ avec $c = c'$ est dérivable par une dérivation plus
  petite ou égale.
\end{lemma}

\begin{proof}
  Par idempotence de la mise en forme normale de tête, on a la même
  dérivation dans le cas où la dernière règle appliquée était
  \irule{SubHnf}, sinon c'est trivial.
\end{proof}

\begin{lemma}[Coercion de termes convertibles]
  \label{coerce-eqbr-eq-id}
  Si $`G \typea T, U : s$, $T \eqbr U$ alors il existe $c$,
  $\subimpl{`G}{c}{T}{U}$ avec $c `= \ctxdot$.
\end{lemma}

\begin{proof}
  Par induction sur le nombre de constructeurs $\Pi, \Sigma, \{|\}$ dans
  les formes normales de $T$ et $U$ (on note $\nf{T}$ la forme normale
  de $T$).

  \begin{itemize}  
  \item Si $\nf{T}$ n'a pas pour symbole de tête, $\Pi, \Sigma$ ou
    $\{|\}$, alors \irule{SubConv} est la seule règle applicable et on
    a $c = \ctxdot$. On a donc traité les cas ou le nombre de symboles
    $\Pi, \Sigma, \{|\}$ dans $T$ et $U$ est supérieur ou égal à zéro, seulement
    s'il n'apparaît pas en tête. On traite maintenant le seul autre cas possible.

  \item Si $\hnf{T} = \Pi y : A.B$, alors $\hnf{U} = \Pi y : A'.B'$ avec $A
    \eqbr A'$, $B \eqbr B'$. Par induction, $\subimpl{`G}{c_1 `= \ctxdot}{A'}{A}$
    et $\subimpl{`G, x : A'}{c_2 `= \ctxdot}{B}{B'}$ ($\nf{A}, \nf{A'}, \nf{B}, \nf{B'}$ sont des
    sous-termes stricts de $\nf{T}$ et $\nf{U}$). On peut donc dériver: 
    $\subimpl{`G}{\lambda x : \ip{A'}{`G}. c_2[\ctxdot~c_1[x]]}
    {\Pi y : A.B}{\Pi y : A'.B'}$. Puis par application de
    \irule{SubHnf}, la coercion de $T$ à $U$.
        
    On a donc:
    \begin{eqnarray*}
      c & \eqdef & \lambda x : \ip{A'}{`G}. c_2[\ctxdot~(c_1[x]) \\
      & `= & \lambda x : \ip{A'}{`G}. \ctxdot~x \\
      & =_{\eta} & \ctxdot
    \end{eqnarray*}
    
  \item Si $\hnf{T} = \Sigma y : A.B$ alors $\hnf{U} = \Sigma y : A'.B'$ avec $A
    \eqbr A'$, $B \eqbr B'$. Par induction, $\subimpl{`G}{c_1 `= \ctxdot}{A}{A'}$
    et $\subimpl{`G, x : A}{c_2 `= \ctxdot}{B}{B'}$ ($\nf{A},
    \nf{A'}, \nf{B}, \nf{B'}$ sont des
    sous-termes stricts de $\nf{T}$ et $\nf{U}$). On peut donc dériver: 
    $\subimpl{`G}{\pair{\ip{\Sigma y :
          A'.B'}{`G}}{c_1[\pi_1~\ctxdot]}{c_2[\pi_1~\ctxdot/x][\pi_2~\ctxdot]}}    
    {\Sigma y : A.B}{\Sigma y : A'.B'}$. Puis par application de
    \irule{SubHnf}, la coercion de $T$ à $U$.

    On a donc:
    \begin{eqnarray*}
      c & \eqdef & \pair{\ip{\Sigma y : A'.B'}{`G}}
      {c_1[\pi_1~\ctxdot]}
      {c_2[\pi_1~\ctxdot/x][\pi_2~\ctxdot]} \\
      & `= & 
      \pair{\ip{\Sigma y : A'.B'}{`G}}
      {\pi_1~\ctxdot}
      {\pi_2~\ctxdot} \\
      & =_\rho & \ctxdot
    \end{eqnarray*}
    
  \item Le cas des sous-ensembles est un peu différent.
    Si $\hnf{T} = \mysubset{x}{T'}{P}$ alors $\hnf{U} =
    \mysubset{x}{U'}{P'}$ avec $T' \eqbr U'$ et $P \eqbr P'$.
    La dérivation va avoir la forme suivante:
    \begin{prooftree}
      \AXC{$\subimpl{`G}{c' `= \ctxdot}{T'}{U'}$}
      \UIC{$\subimpl{`G}{d = c'[\eltpit~\ctxdot]}{\mysubset{x}{T'}{P}}{U'}$}
      \UIC{$\subimpl{`G}{c = \elt{\ip{U'}{`G}}{\ip{\lambda x : U'.P'}{`G}}{d}
          {\ex{\ipG{`G}}{\ip{P'}{`G}[d/x]}}}{\mysubset{x}{T'}{P}}{\mysubset{x}{U'}{P'}}$}
      \UIC{$\subimpl{`G}{c}{T}{U}$}
    \end{prooftree}
    
    On a donc $d = c'[\eltpit~\ctxdot] `= \eltpit~\ctxdot$.

    On peut vérifier:
    \begin{eqnarray*}
      c & \eqdef & \elt{\ip{U'}{`G}}{\ip{\lambda x : U'.P'}{`G}}{d}
      {\ex{\ipG{`G}}{\ip{P'}{`G}[d/x]}} \\
      & `= & \elt{\ip{U'}{`G}}{\ip{\lambda x : U'.P'}{`G}}{(\eltpit~\ctxdot)}
      {\ex{\ipG{`G}}{\ip{P'}{`G}[\eltpit~\ctxdot/x]}} \\
      & =_\sigma & \elt{\ip{U'}{`G}}{\ip{\lambda x : U'.P'}{`G}}{(\eltpit~\ctxdot)}
      {(\eltpip~\ctxdot)} \\
      & =_\rho & \ctxdot
    \end{eqnarray*}
    
  \end{itemize}
\end{proof}

\input{subset-typing-impl-subtyping-subst}

%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "subset-typing"
%%% LaTeX-command: "TEXINPUTS=\"style:$TEXINPUTS\" latex"
%%% End: 
