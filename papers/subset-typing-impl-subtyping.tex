\begin{lemma}[Unicité de la coercion]
  \label{coercion-unicity}
  Si $`G \typea T, U : s$ alors si $\subimpl{`G}{c}{T}{U}$ et
  $\subimpl{`G}{c'}{T}{U}$ alors $c = c'$.
\end{lemma}

\begin{proof}
  Par induction lexicographique sur la paire de dérivations de $c$ et $c'$.
  Seule la régle \irule{SubHnf} peut s'appliquer n'importe quand. 
  Supposons que la dérivation de $c$ se termine par une application de \irule{SubHnf}.
  Quelque soit la dernière règle appliquée dans la dérivation de $c'$,
  on a $T = \hnf{T}$ et $U = \hnf{U}$. Par induction on a donc $c = c'$.
\end{proof}

On peut donc raisonner comme ceci: si l'on parvient à construire une
dérivation de $\subimpl{`G}{c}{T}{U}$ alors c'est l'unique dérivation
existante.

\begin{lemma}[Réflexivité de la coercion]
  \label{coerce-refl}
  Si $\timpl{`G}{A}{s}$ alors il existe $c$, $\subimpl{`G}{c}{A}{A}$ et
  $c \eqbres \ctxdot$.
\end{lemma}

\begin{proof}
  Par induction sur le nombre de constructeurs $\Pi, \Sigma, \{|\}$ dans
  la forme normale de $A$.

  S'il $\nf{A}$ n'a pas de constructeur $\Pi, \Sigma, \{|\}$ en tête,
  alors $\hnf{A}$ n'en a pas en tête et l'on peut directement appliquer
  \irule{SubConv}.
  
  Sinon, on va appliquer la ou les règles correspondant au constructeur
  en tête. Le cas le plus intéressant est si $\hnf{A}$ est de la forme
  $\mysubset{x}{U}{P}$.
  Alors on a la dérivation:

  \begin{prooftree}
    \AXC{$\subimpl{`G}{c' \eqbres \ctxdot}{U}{U}$}
    \UIC{$\subimpl{`G}{d = c'[\pi_1~\ctxdot]}{U}{U}$}
    \UIC{$\subimpl{`G}{c = \elt{\ip{U}{`G}}{\ip{\lambda x : U.P}{`G}}{d}
        {\ex{\ipG{`G}}{\ip{P}{`G}[d/x]}}}{\mysubset{x}{U}{P}}{U}$}
    \UIC{$\subimpl{`G}{c}{\hnf{A} = \mysubset{x}{U}{P}}{\mysubset{x}{U}{P}}$}
    \UIC{$\subimpl{`G}{c}{A}{A}$}
  \end{prooftree}

  On obtient la dérivation de $c'$ par induction, puisque $\nf{U}$
  contient strictement moins de constructeurs que $\nf{A}$.

  On a: 
  \begin{eqnarray*}
    c & = & \elt{\ip{U}{`G}}{\ip{\lambda x : U.P}{`G}}{d}
    {\ex{\ipG{`G}}{\ip{P}{`G}[d/x]}} \\
    & \eqbres & \elt{\ip{U}{`G}}{\ip{\lambda x : U.P}{`G}}{(\pi_1~\ctxdot)}
    {\ex{\ipG{`G}}{\ip{P}{`G}[\pi_1~\ctxdot/x]}} \\
    & = & \elt{\ip{U}{`G}}{\ip{\lambda x : U.P}{`G}}{(\pi_1~\ctxdot)}
    {(\pi_2~\ctxdot)} \\
    & =_\SP & \ctxdot
  \end{eqnarray*}

  On utilise ici l'indifférence aux preuves. Comme $(\pi_2~\ctxdot)$ est
  de type $\ip{P}{`G}[\pi_1~\ctxdot/x]$, on peut remplacer directement
  l'existentielle par ce terme. En pratique, ces preuves pourront être
  directement déchargées par l'assistant de preuve.
\end{proof}


\begin{lemma}[Coercion et formes normales de tête]
  \label{substi-coercion-hnf}
  Si $`G \typec c : T \suba U$ alors $`G \typec c' : \hnf{T}~\suba
  \hnf{U}$ avec $c = c'$ est dérivable par une dérivation plus
  petite ou égale.
\end{lemma}

\begin{proof}
  Par idempotence de la mise en forme normale de tête, on a la même
  dérivation dans le cas où la dernière règle appliquée était
  \irule{SubHnf}, sinon c'est trivial.
\end{proof}

\begin{lemma}[Coercion de termes convertibles]
  \label{subti-eqb-coercion-eqbres-id}
  Si $`G \typea T, U : s$, $T \eqbr U$ et $\ip{T}{`G} \eqbres \ip{U}{`G}$ alors il existe $c$,
  $\subimpl{`G}{c}{T}{U}$ avec $c \eqbres \ctxdot$.
\end{lemma}

\begin{proof}
  Par induction sur le nombre de constructeurs $\Pi, \Sigma, \{|\}$ dans
  les formes normales de $T$ et $U$ (on note $\nf{T}$ la forme normale
  de $T$).

  \begin{itemize}  
  \item Si $\nf{T}$ n'a pas pour symbole de tête, $\Pi, \Sigma$ ou
    $\{|\}$, alors \irule{SubConv} est la seule règle applicable et on
    a $c = \ctxdot$. On a donc traité les cas ou le nombre de symboles
    $\Pi, \Sigma, \{|\}$ dans $T$ et $U$ est supérieur ou égal à zéro, seulement
    s'il n'apparaît pas en tête. On traite maintenant le seul autre cas possible.

  \item Si $\hnf{T} = \Pi y : A.B$, alors $\hnf{U} = \Pi y : A'.B'$ avec $A
    \eqbr A'$, $B \eqbr B'$. Par induction, $\subimpl{`G}{c_1 \eqbres \ctxdot}{A'}{A}$
    et $\subimpl{`G, x : A'}{c_2 \eqbres \ctxdot}{B}{B'}$ ($\nf{A}, \nf{A'}, \nf{B}, \nf{B'}$ sont des
    sous-termes stricts de $\nf{T}$ et $\nf{U}$). On peut donc dériver: 
    $\subimpl{`G}{\lambda x : \ip{A'}{`G}. c_2[\ctxdot~c_1[x]]}
    {\Pi y : A.B}{\Pi y : A'.B'}$. Puis par application de
    \irule{SubHnf}, la coercion de $T$ à $U$.
        
    On a donc:
    \begin{eqnarray*}
      c & = & \lambda x : \ip{A'}{`G}. c_2[\ctxdot~(c_1[x]) \\
      & \eqbres & \lambda x : \ip{A'}{`G}. \ctxdot~x \\
      & \eqbres & \ctxdot
    \end{eqnarray*}
    
  \item Si $\hnf{T} = \Sigma y : A.B$ alors $\hnf{U} = \Sigma y : A'.B'$ avec $A
    \eqbr A'$, $B \eqbr B'$. Par induction, $\subimpl{`G}{c_1 \eqbres \ctxdot}{A}{A'}$
    et $\subimpl{`G, x : A}{c_2 \eqbres \ctxdot}{B}{B'}$ ($\nf{A},
    \nf{A'}, \nf{B}, \nf{B'}$ sont des
    sous-termes stricts de $\nf{T}$ et $\nf{U}$). On peut donc dériver: 
    $\subimpl{`G}{(c_1[\pi_1~\ctxdot], c_2[\pi_1~\ctxdot/x][\pi_2~\ctxdot])}
    {\Pi y : A.B}{\Pi y : A'.B'}$. Puis par application de
    \irule{SubHnf}, la coercion de $T$ à $U$.

    On a donc:
    \begin{eqnarray*}
      c & = & (c_1[\pi_1~\ctxdot], c_2[\pi_1~\ctxdot/x][\pi_2~\ctxdot]) \\
      & "->>"_\beta & (\pi_1~\ctxdot, \pi_2~\ctxdot) \\
      & =_\SP & \ctxdot
    \end{eqnarray*}
    
  \item Le cas des sous-ensembles est un peu différent.
    Si $\hnf{T} = \mysubset{x}{T'}{P}$ alors $\hnf{U} =
    \mysubset{x}{U'}{P'}$ avec $T' \eqbr U'$ et $P \eqbr P'$.
    La dérivation va avoir la forme suivante:
    \begin{prooftree}
      \AXC{$\subimpl{`G}{c' \eqbr \ctxdot}{T'}{U'}$}
      \UIC{$\subimpl{`G}{d = c'[\pi_1~\ctxdot]}{T'}{U'}$}
      \UIC{$\subimpl{`G}{c = \elt{\ip{U'}{`G}}{\ip{\lambda x : U'.P'}{`G}}{d}
            {\ex{\ipG{`G}}{\ip{P'}{`G}[d/x]}}}{\mysubset{x}{T'}{P}}{U'}$}
      \UIC{$\subimpl{`G}{c}{\mysubset{x}{T'}{P}}{\mysubset{x}{U'}{P'}}$}
      \UIC{$\subimpl{`G}{c}{T}{U}$}
    \end{prooftree}
    
    On a donc $d = c'[\pi_1~\ctxdot] \eqbr \pi_1~\ctxdot$.
    Comme $P \eqbr P'$, la preuve de l'existentielle
    $\ex{\ipG{`G}}{\ip{P'}{`G}[\pi_1~\ctxdot/x]}$ peut être considérée
    comme équivalente à $\pi_2~\ctxdot$. 
    \Problem{Problème de l'interprétation, on n'a pas $P \eqbr P' "=>" \ip{P}{`G} =
      \ip{P'}{`G}$ sans ajouter cette condition dans l'énoncé}

    On peut vérifier:
    \begin{eqnarray*}
      c & = & \elt{\ip{U'}{`G}}{\ip{\lambda x : U'.P''}{`G}}{d}
      {\ex{\ipG{`G}}{\ip{P''}{`G}[d/x]}} \\
      & = & \elt{\ip{U'}{`G}}{\ip{\lambda x : U'.P''}{`G}}{(\pi_1~\ctxdot)}
      {\ex{\ipG{`G}}{\ip{P''}{`G}[\pi_1~\ctxdot/x]}} \\
      & = & \elt{\ip{U'}{`G}}{\ip{\lambda x : U'.P''}{`G}}{(\pi_1~\ctxdot)}
      {(\pi_2~\ctxdot)} \\
      & =_\SP & \ctxdot
    \end{eqnarray*}
    
  \end{itemize}
\end{proof}

\input{subset-typing-impl-subtyping-subst}

%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "subset-typing"
%%% LaTeX-command: "TEXINPUTS=\"style:$TEXINPUTS\" latex"
%%% End: 
